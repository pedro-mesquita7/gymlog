---
phase: 10-workout-features-demo-data
plan: 03
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/components/workout/WorkoutComplete.tsx
  - src/hooks/useWorkoutSummary.ts
autonomous: true

must_haves:
  truths:
    - "User sees total volume, duration, sets, and exercises after completing workout"
    - "User sees list of PRs achieved during the workout with gold badges"
    - "User sees volume comparison vs last session of the same template"
    - "Rotation auto-advances after workout is saved successfully"
  artifacts:
    - path: "src/components/workout/WorkoutComplete.tsx"
      provides: "Enhanced post-workout summary with PRs and comparison"
    - path: "src/hooks/useWorkoutSummary.ts"
      provides: "Hook for PR detection and session comparison queries"
      exports: ["useWorkoutSummary"]
  key_links:
    - from: "src/hooks/useWorkoutSummary.ts"
      to: "src/db/duckdb-init.ts"
      via: "DuckDB queries for PR detection and session comparison"
      pattern: "getDuckDB|conn\\.query"
    - from: "src/components/workout/WorkoutComplete.tsx"
      to: "src/stores/useRotationStore.ts"
      via: "advanceRotation after successful save"
      pattern: "advanceRotation|useRotationStore"
    - from: "src/components/workout/WorkoutComplete.tsx"
      to: "src/hooks/useWorkoutSummary.ts"
      via: "PR and comparison data for display"
      pattern: "useWorkoutSummary"
---

<objective>
Enhance the WorkoutComplete dialog with PR detection badges, volume comparison vs last session of the same template, and rotation auto-advance on save. Create useWorkoutSummary hook for post-workout analytics queries.

Purpose: SUMM-01 (summary stats), SUMM-02 (PR highlighting), SUMM-03 (template comparison), ROTN-03 (auto-advance).
Output: Enhanced WorkoutComplete with PRs/comparison, useWorkoutSummary hook, rotation advance wiring.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-workout-features-demo-data/10-RESEARCH.md
@.planning/phases/10-workout-features-demo-data/10-CONTEXT.md
@src/components/workout/WorkoutComplete.tsx
@src/db/events.ts
@src/db/queries.ts
@src/db/compiled-queries.ts
@src/stores/useRotationStore.ts
@src/stores/useWorkoutStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useWorkoutSummary hook for PR detection and session comparison</name>
  <files>src/hooks/useWorkoutSummary.ts</files>
  <action>
Create a hook that queries DuckDB for post-workout analytics after events are written.

**Interface:**
```typescript
interface ExercisePR {
  exercise_id: string;
  exercise_name: string;
  weight_prs: number;
  estimated_1rm_prs: number;
}

interface SessionComparison {
  last_date: string;
  last_volume_kg: number;
  volume_delta_kg: number;
}

interface WorkoutSummaryData {
  prs: ExercisePR[];
  comparison: SessionComparison | null;
  isLoading: boolean;
}
```

**Export:** `useWorkoutSummary(workoutId: string, templateId: string): WorkoutSummaryData`

**PR Detection Query:**
Query the events table directly (not dbt models, since those may not be materialized at runtime). Use window functions to detect if any set in this workout achieved a new max weight or estimated 1RM per exercise.

```sql
WITH all_sets AS (
  SELECT
    payload->>'workout_id' as workout_id,
    payload->>'original_exercise_id' as exercise_id,
    CAST(payload->>'weight_kg' AS DOUBLE) as weight_kg,
    CAST(payload->>'reps' AS INTEGER) as reps,
    CAST(payload->>'weight_kg' AS DOUBLE) * (1 + CAST(payload->>'reps' AS INTEGER) / 30.0) as estimated_1rm
  FROM events
  WHERE event_type = 'set_logged'
),
ranked AS (
  SELECT *,
    MAX(weight_kg) OVER (PARTITION BY exercise_id ORDER BY rowid ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING) as prev_max_weight,
    MAX(estimated_1rm) OVER (PARTITION BY exercise_id ORDER BY rowid ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING) as prev_max_1rm
  FROM all_sets
)
SELECT exercise_id,
  COUNT(CASE WHEN weight_kg > COALESCE(prev_max_weight, 0) THEN 1 END) as weight_prs,
  COUNT(CASE WHEN estimated_1rm > COALESCE(prev_max_1rm, 0) THEN 1 END) as estimated_1rm_prs
FROM ranked
WHERE workout_id = '${workoutId}'
  AND (weight_kg > COALESCE(prev_max_weight, 0) OR estimated_1rm > COALESCE(prev_max_1rm, 0))
GROUP BY exercise_id
```

Then join exercise names from exercise_created events.

**Session Comparison Query:**
Find last completed workout with same template_id, sum its volume, compare to current.

```sql
WITH workout_volumes AS (
  SELECT
    ws.payload->>'workout_id' as workout_id,
    ws.payload->>'template_id' as template_id,
    ws._created_at as started_at,
    SUM(CAST(sl.payload->>'weight_kg' AS DOUBLE) * CAST(sl.payload->>'reps' AS INTEGER)) as total_volume
  FROM events ws
  JOIN events wc ON wc.event_type = 'workout_completed'
    AND wc.payload->>'workout_id' = ws.payload->>'workout_id'
  JOIN events sl ON sl.event_type = 'set_logged'
    AND sl.payload->>'workout_id' = ws.payload->>'workout_id'
  WHERE ws.event_type = 'workout_started'
    AND ws.payload->>'template_id' = '${templateId}'
    AND ws.payload->>'workout_id' != '${workoutId}'
  GROUP BY ws.payload->>'workout_id', ws.payload->>'template_id', ws._created_at
  ORDER BY ws._created_at DESC
  LIMIT 1
)
SELECT * FROM workout_volumes
```

**Implementation:**
- Use useState + useEffect pattern (matches existing hooks)
- Get DuckDB connection via getDuckDB()
- Both queries run after component mounts (events already written)
- Handle errors gracefully (log, return empty state)
- Return loading state while queries run

**Testing the window function queries:**
After implementing, verify with a known test scenario: If exercise X has historical sets at 60kg and the current workout logs 65kg, the query MUST return exercise X with weight_prs >= 1. Test this by:
1. Opening DevTools console after completing a workout where you increased weight on any exercise
2. Checking that the PR section appears for that exercise
3. If no historical data exists (first workout), ALL sets should count as PRs since they exceed the COALESCE(prev_max, 0) baseline

Also verify the window frame is correct: `ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING` ensures we compare against all PRIOR sets, not the current one. The `ORDER BY rowid` uses DuckDB's internal row ordering which preserves insertion order (chronological for our event-sourced data).
  </action>
  <verify>
`npx tsc --noEmit` passes. Hook compiles without errors. After building and running in browser: complete a workout with a weight increase on at least one exercise, verify the useWorkoutSummary hook returns that exercise in the prs array (check via console.log or React DevTools). For a first-ever workout (no history), verify all exercises show as PRs. For session comparison, complete two workouts with the same template and verify volume_delta_kg is non-null.
  </verify>
  <done>
useWorkoutSummary returns PR list and session comparison data from DuckDB queries. PR detection correctly identifies new weight and estimated 1RM records using window functions. Session comparison shows volume delta against the most recent prior workout with the same template.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance WorkoutComplete with PRs, comparison, and rotation advance</name>
  <files>src/components/workout/WorkoutComplete.tsx</files>
  <action>
Upgrade the existing WorkoutComplete component to show PR badges, volume comparison, and advance rotation.

**Changes to handleSave:**
1. After writing all events (workout_started, set_logged, workout_completed) -- keep existing logic
2. After incrementWorkoutCount() -- add rotation advance:
   ```typescript
   const activeRotationId = useRotationStore.getState().activeRotationId;
   if (activeRotationId) {
     useRotationStore.getState().advanceRotation(activeRotationId);
   }
   ```
3. Instead of immediately calling onSaved(), transition to a "saved" state that shows the enhanced summary

**New state machine:**
- `phase: 'review' | 'saving' | 'saved'`
- 'review': current behavior (pre-save, shows stats + save button)
- 'saving': isSaving=true
- 'saved': events written, now show enhanced summary with PRs and comparison

**Enhanced summary (phase === 'saved'):**
- Call useWorkoutSummary(session.workout_id, session.template_id) -- queries run after save
- Keep existing stats grid (sets, exercises, duration)
- Keep total volume display
- Add PR section if prs.length > 0:
  - Gold/amber section: bg-yellow-500/10 border border-yellow-500/30
  - Heading: "Personal Records" with trophy emoji or bold text
  - List each exercise with PR type badges:
    - Weight PR: small gold badge "Weight PR" (bg-yellow-500 text-black text-xs px-2 py-0.5 rounded-full)
    - 1RM PR: similar badge "Est. 1RM PR"
- Add comparison section if comparison exists:
  - Text: "vs last {templateName}: {volumeDelta > 0 ? '+' : ''}{Math.round(volumeDelta)} {weightUnit}"
  - Color: text-success if positive, text-error if negative, text-text-secondary if zero
  - Include date of last session
- Show "Done" button (variant="primary") that calls onSaved()

**Do NOT:**
- Don't advance rotation on cancel -- only on successful save (CRITICAL per CONTEXT.md)
- Don't block the save flow if PR detection fails -- wrap in try/catch, show summary without PRs
- Don't change the existing props interface (keep backward compatible)
  </action>
  <verify>
`npx tsc --noEmit` passes. `npx vitest run` passes. In browser: complete a workout, see enhanced summary with stats. If PRs exist, gold badges shown. Rotation advances (check localStorage gymlog-rotations).
  </verify>
  <done>
WorkoutComplete shows enhanced post-workout summary with PR badges, volume comparison vs last session of same template, and auto-advances rotation on successful save. Cancel does not advance rotation.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npx vitest run` passes
3. Complete a workout: see sets/exercises/duration/volume stats
4. If PRs achieved: gold badges per exercise with PR type
5. If previous session of same template exists: volume delta shown with color
6. After save: rotation advances (verify in localStorage)
7. Cancel workout: rotation does NOT advance
</verification>

<success_criteria>
- useWorkoutSummary detects PRs via DuckDB window functions and compares volume to last same-template session
- WorkoutComplete shows enhanced summary with PR badges and comparison after save
- Rotation auto-advances ONLY on successful workout completion
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-workout-features-demo-data/10-03-SUMMARY.md`
</output>
