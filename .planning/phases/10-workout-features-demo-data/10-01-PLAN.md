---
phase: 10-workout-features-demo-data
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/stores/useRotationStore.ts
  - src/components/settings/RotationSection.tsx
  - src/components/rotation/RotationEditor.tsx
  - src/components/backup/BackupSettings.tsx
autonomous: true

must_haves:
  truths:
    - "User can create a named rotation with ordered template sequence in Settings"
    - "User can reorder templates in rotation via drag-and-drop"
    - "User can set one rotation as active and choose a default gym"
    - "User can delete a rotation and reset rotation position"
  artifacts:
    - path: "src/stores/useRotationStore.ts"
      provides: "Rotation state management with Zustand persist"
      exports: ["useRotationStore"]
    - path: "src/components/settings/RotationSection.tsx"
      provides: "Rotation management UI in Settings"
      exports: ["RotationSection"]
    - path: "src/components/rotation/RotationEditor.tsx"
      provides: "Drag-and-drop rotation template editor"
      exports: ["RotationEditor"]
  key_links:
    - from: "src/components/settings/RotationSection.tsx"
      to: "src/stores/useRotationStore.ts"
      via: "Zustand store actions"
      pattern: "useRotationStore"
    - from: "src/components/rotation/RotationEditor.tsx"
      to: "@dnd-kit/sortable"
      via: "SortableContext + useSortable"
      pattern: "SortableContext"
    - from: "src/components/backup/BackupSettings.tsx"
      to: "src/components/settings/RotationSection.tsx"
      via: "RotationSection rendered in Settings page"
      pattern: "RotationSection"
---

<objective>
Create the rotation state management store and rotation editor UI in Settings. Users can create named rotations (ordered template sequences), reorder templates via drag-and-drop, set an active rotation, and choose a default gym.

Purpose: Foundation for workout rotation auto-advance (ROTN-01, ROTN-04). The store is consumed by quick-start card (Plan 02) and workout completion (Plan 03).
Output: useRotationStore with full CRUD + persist, RotationSection in Settings, drag-and-drop RotationEditor.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-workout-features-demo-data/10-RESEARCH.md
@.planning/phases/10-workout-features-demo-data/10-CONTEXT.md
@src/stores/useWorkoutStore.ts
@src/components/backup/BackupSettings.tsx
@src/hooks/useTemplates.ts
@src/hooks/useGyms.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useRotationStore with Zustand persist</name>
  <files>src/stores/useRotationStore.ts</files>
  <action>
Create a new Zustand store with persist middleware for rotation management. Follow the exact pattern from useWorkoutStore.ts (create, persist, createJSONStorage, partialize).

**Interface:**
```typescript
interface Rotation {
  rotation_id: string;
  name: string;
  template_ids: string[];  // Ordered list of template IDs
  current_position: number; // 0-based index into template_ids
}

interface RotationState {
  rotations: Rotation[];
  activeRotationId: string | null;
  defaultGymId: string | null;

  // CRUD
  createRotation: (name: string, templateIds: string[]) => string; // returns rotation_id
  updateRotation: (id: string, updates: { name?: string; template_ids?: string[] }) => void;
  deleteRotation: (id: string) => void;

  // Active rotation
  setActiveRotation: (id: string | null) => void;
  setDefaultGym: (gymId: string | null) => void;

  // Position management
  advanceRotation: (rotationId: string) => void; // wraps around using modulo
  resetPosition: (rotationId: string) => void;
}
```

**Key details:**
- Storage key: `'gymlog-rotations'` (unique, no collision with `gymlog-workout`)
- Use `uuidv7()` for rotation_id generation (import from 'uuidv7')
- `advanceRotation`: `(current_position + 1) % template_ids.length`
- `resetPosition`: sets current_position to 0
- When deleting the active rotation, also set activeRotationId to null
- `partialize` should persist: rotations, activeRotationId, defaultGymId
- Export selector: `selectNextTemplate` that returns `{ templateId, position, total, rotationName }` or null if no active rotation

**Do NOT:**
- Don't put UI state in the persisted store
- Don't use `type` imports for runtime values (uuidv7 is a value import)
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Import resolves correctly.
  </verify>
  <done>
useRotationStore exports all CRUD actions, activeRotationId/defaultGymId selectors, advanceRotation/resetPosition, and selectNextTemplate selector. Persists to localStorage under 'gymlog-rotations'.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build Rotation Settings UI with drag-and-drop editor</name>
  <files>
    src/components/settings/RotationSection.tsx
    src/components/rotation/RotationEditor.tsx
    src/components/backup/BackupSettings.tsx
  </files>
  <action>
**RotationEditor.tsx** -- Drag-and-drop sortable list of templates:
- Use @dnd-kit/core DndContext with closestCenter collision detection
- Use @dnd-kit/sortable SortableContext with verticalListSortingStrategy
- PointerSensor and KeyboardSensor with sortableKeyboardCoordinates
- Each item: useSortable hook, CSS.Transform.toString for style
- Display template name with a grip handle icon (use unicode ≡ or ⠿)
- Remove button (X) per item to remove template from rotation
- On drag end: call onReorder with arrayMove result
- Props: `{ templateIds: string[], templates: Template[], onReorder: (ids: string[]) => void, onRemove: (id: string) => void }`

**RotationSection.tsx** -- Settings section for rotation management:
- Import useRotationStore, useTemplates, useGyms hooks
- **Rotation list**: show all rotations with name, template count, active indicator
- **Create rotation**: name input + multi-select to pick templates (or add from available templates list) + "Create" button
- **Edit rotation**: inline RotationEditor for drag-and-drop reorder
- **Active rotation**: radio/button to mark one as active (calls setActiveRotation)
- **Default gym**: Select dropdown from gyms list (calls setDefaultGym)
- **Reset position**: button per rotation (calls resetPosition)
- **Delete rotation**: button with confirmation
- Use existing UI primitives (Button, Input, Select, Card) from src/components/ui/
- Design tokens: bg-bg-secondary for cards, text-text-primary/secondary, border-border-primary

**BackupSettings.tsx** -- Add RotationSection to Settings page:
- Import RotationSection
- Add it as a new section BEFORE the Data Backup section
- Add a horizontal rule separator between sections
- Section heading: "Workout Rotations"

**Do NOT:**
- Don't create a new top-level tab -- rotation management lives in Settings
- Don't use index as key in SortableContext items (use template_id)
  </action>
  <verify>
Run `npx tsc --noEmit` and `npx vitest run` -- no errors. Open dev server, navigate to Settings tab, verify rotation section is visible with create/edit/delete UI. To verify drag-and-drop: create a rotation with 3+ templates, drag a template to reorder, confirm the onReorder callback fires with the new array order (check that the list visually updates). Inspect DevTools Elements tab to confirm DndContext and SortableContext are rendering (look for dnd-kit data attributes on draggable items).
  </verify>
  <done>
Settings page shows "Workout Rotations" section where user can create named rotations, reorder templates via drag-and-drop, set active rotation, choose default gym, reset position, and delete rotations.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npx vitest run` passes (existing tests not broken)
3. In browser: Settings tab shows Workout Rotations section
4. Can create a rotation, reorder via drag, set as active, choose default gym
5. localStorage key `gymlog-rotations` contains persisted rotation data
</verification>

<success_criteria>
- useRotationStore created with full CRUD, advanceRotation, resetPosition, selectNextTemplate
- RotationEditor supports drag-and-drop reorder with @dnd-kit/sortable
- RotationSection rendered in Settings with create/edit/delete/active/default gym controls
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-workout-features-demo-data/10-01-SUMMARY.md`
</output>
