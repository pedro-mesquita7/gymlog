---
phase: 03-history-analytics
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - dbt/models/marts/core/fact_sets.sql
  - dbt/models/marts/core/fact_workouts.sql
  - dbt/models/marts/core/fact_prs.sql
  - dbt/models/marts/analytics/vw_exercise_history.sql
  - dbt/models/marts/core/_core__models.yml
  - dbt/tests/custom/test_weight_positive.sql
  - dbt/tests/custom/test_reps_reasonable.sql
autonomous: true

must_haves:
  truths:
    - "fact_sets contains all logged sets with analytics columns"
    - "fact_prs tracks historical PR records per exercise"
    - "vw_exercise_history shows last 2 weeks with gym filtering"
    - "dbt tests validate no negative weights and reasonable rep ranges"
  artifacts:
    - path: "dbt/models/marts/core/fact_sets.sql"
      provides: "Central fact table for sets"
      contains: "is_pr"
    - path: "dbt/models/marts/analytics/vw_exercise_history.sql"
      provides: "2-week history view with gym filtering"
      contains: "14 days"
    - path: "dbt/tests/custom/test_weight_positive.sql"
      provides: "Data quality test for weights"
      contains: "weight_kg"
  key_links:
    - from: "dbt/models/marts/core/fact_sets.sql"
      to: "int_sets__with_anomalies"
      via: "ref()"
      pattern: "ref.*int_sets"
---

<objective>
Create mart models (fact tables, views) and dbt tests for data quality validation.

Purpose: Delivers production-ready mart models for UI consumption (HIST-01, HIST-05), fact tables for analytics, and dbt tests for data quality (DATA-05).
Output: 4 mart models + schema documentation + 2 custom tests.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-history-analytics/03-RESEARCH.md

# Existing mart models
@dbt/models/marts/core/dim_exercise.sql
@dbt/models/marts/core/dim_gym.sql
@dbt/models/marts/core/_core__models.yml

# Intermediate models from 03-02
@dbt/models/intermediate/workouts/int_sets__with_anomalies.sql

# Staging models from 03-01
@dbt/models/staging/events/stg_events__workout_started.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mart fact tables</name>
  <files>
    dbt/models/marts/core/fact_sets.sql
    dbt/models/marts/core/fact_workouts.sql
    dbt/models/marts/core/fact_prs.sql
  </files>
  <action>
Create three fact tables for the star schema:

1. **fact_sets.sql** - Central fact table with all analytics:
```sql
-- Mart model: Fact table for logged sets (DATA-01)
{{
    config(
        materialized='table'
    )
}}

SELECT
    set_id,
    workout_id,
    exercise_id,
    original_exercise_id,
    weight_kg,
    reps,
    rir,
    estimated_1rm,
    is_weight_pr,
    is_1rm_pr,
    is_pr,
    is_anomaly,
    weight_change_pct,
    previous_weight,
    previous_max_weight,
    logged_at,
    _event_id,
    _created_at
FROM {{ ref('int_sets__with_anomalies') }}
```

2. **fact_workouts.sql** - Workout sessions with status:
```sql
-- Mart model: Fact table for workouts
{{
    config(
        materialized='table'
    )
}}

WITH started AS (
    SELECT
        workout_id,
        template_id,
        gym_id,
        started_at,
        _event_id,
        _created_at
    FROM {{ ref('stg_events__workout_started') }}
),

completed AS (
    SELECT
        workout_id,
        completed_at
    FROM {{ ref('stg_events__workout_completed') }}
)

SELECT
    s.workout_id,
    s.template_id,
    s.gym_id,
    s.started_at,
    c.completed_at,
    CASE
        WHEN c.completed_at IS NOT NULL THEN 'completed'
        ELSE 'in_progress'
    END AS status,
    s._event_id,
    s._created_at
FROM started s
LEFT JOIN completed c ON s.workout_id = c.workout_id
```

3. **fact_prs.sql** - PR history per exercise (HIST-05):
```sql
-- Mart model: Personal records history (HIST-05)
{{
    config(
        materialized='table'
    )
}}

SELECT
    set_id,
    workout_id,
    exercise_id,
    weight_kg,
    reps,
    estimated_1rm,
    CASE
        WHEN is_weight_pr AND is_1rm_pr THEN 'weight_and_1rm'
        WHEN is_weight_pr THEN 'weight'
        WHEN is_1rm_pr THEN '1rm'
    END AS pr_type,
    logged_at,
    _created_at
FROM {{ ref('int_sets__with_anomalies') }}
WHERE is_pr = true
ORDER BY exercise_id, logged_at
```
  </action>
  <verify>Run `cd dbt && dbt compile --select fact_sets fact_workouts fact_prs` - should compile without errors</verify>
  <done>Three fact tables exist and compile successfully</done>
</task>

<task type="auto">
  <name>Task 2: Create exercise history view and schema docs</name>
  <files>
    dbt/models/marts/analytics/vw_exercise_history.sql
    dbt/models/marts/core/_core__models.yml
  </files>
  <action>
1. Create **dbt/models/marts/analytics/** directory if not exists.

2. Create **vw_exercise_history.sql** - 2-week history with gym filtering (HIST-01, HIST-02):
```sql
-- Mart view: Exercise history for last 2 weeks (HIST-01, HIST-02)
{{
    config(
        materialized='view'
    )
}}

WITH recent_sets AS (
    SELECT
        s.set_id,
        s.workout_id,
        s.exercise_id,
        s.weight_kg,
        s.reps,
        s.rir,
        s.estimated_1rm,
        s.is_pr,
        s.is_anomaly,
        s.logged_at,
        w.gym_id AS workout_gym_id,
        e.name AS exercise_name,
        e.is_global,
        e.gym_id AS exercise_gym_id
    FROM {{ ref('fact_sets') }} s
    JOIN {{ ref('fact_workouts') }} w ON s.workout_id = w.workout_id
    JOIN {{ ref('dim_exercise') }} e ON s.exercise_id = e.exercise_id
    WHERE s.logged_at >= CURRENT_DATE - INTERVAL '14 days'
)

SELECT
    set_id,
    workout_id,
    exercise_id,
    exercise_name,
    weight_kg,
    reps,
    rir,
    estimated_1rm,
    is_pr,
    is_anomaly,
    logged_at,
    workout_gym_id,
    is_global,
    exercise_gym_id,
    -- Gym filtering flag for runtime use
    {{ filter_exercise_by_gym('is_global', 'exercise_gym_id', 'workout_gym_id') }} AS matches_gym_context
FROM recent_sets
```

3. Update **_core__models.yml** with documentation for all models (DATA-06):
```yaml
version: 2

models:
  - name: dim_exercise
    description: "Exercise dimension - current state of all active exercises"
    columns:
      - name: exercise_id
        description: "Primary key - UUID"
        tests:
          - unique
          - not_null
      - name: name
        description: "Exercise name"
        tests:
          - not_null
      - name: is_global
        description: "If true, history shown across all gyms. If false, gym-specific."

  - name: dim_gym
    description: "Gym dimension - current state of all active gyms"
    columns:
      - name: gym_id
        description: "Primary key - UUID"
        tests:
          - unique
          - not_null

  - name: fact_sets
    description: "Fact table for logged workout sets with analytics (1RM, PR, anomaly)"
    columns:
      - name: set_id
        description: "Primary key - UUID"
        tests:
          - unique
          - not_null
      - name: workout_id
        description: "Foreign key to fact_workouts"
        tests:
          - not_null
          - relationships:
              to: ref('fact_workouts')
              field: workout_id
      - name: exercise_id
        description: "Foreign key to dim_exercise"
        tests:
          - not_null
      - name: weight_kg
        description: "Weight lifted in kilograms"
        tests:
          - not_null
      - name: reps
        description: "Number of repetitions completed"
        tests:
          - not_null
      - name: estimated_1rm
        description: "Estimated one-rep max using Epley formula (NULL if reps > 15)"
      - name: is_pr
        description: "True if this set is a personal record (weight or 1RM)"

  - name: fact_workouts
    description: "Fact table for workout sessions"
    columns:
      - name: workout_id
        description: "Primary key - UUID"
        tests:
          - unique
          - not_null
      - name: gym_id
        description: "Foreign key to dim_gym"
        tests:
          - not_null

  - name: fact_prs
    description: "Historical personal records per exercise (HIST-05)"
    columns:
      - name: set_id
        description: "Primary key - references fact_sets"
        tests:
          - unique
          - not_null
      - name: pr_type
        description: "Type of PR: weight, 1rm, or weight_and_1rm"
```
  </action>
  <verify>Run `cd dbt && dbt compile --select vw_exercise_history` and `dbt docs generate` - both should succeed</verify>
  <done>History view filters by 2 weeks and includes gym context, schema docs describe all models</done>
</task>

<task type="auto">
  <name>Task 3: Create custom dbt tests for data quality</name>
  <files>
    dbt/tests/custom/test_weight_positive.sql
    dbt/tests/custom/test_reps_reasonable.sql
  </files>
  <action>
Create the tests directory and custom tests (DATA-05):

1. Create **dbt/tests/custom/** directory.

2. Create **test_weight_positive.sql**:
```sql
-- Custom test: Ensure no negative weights in fact_sets
-- Returns rows that FAIL the test (negative weights)
SELECT
    set_id,
    weight_kg,
    logged_at
FROM {{ ref('fact_sets') }}
WHERE weight_kg < 0
```

3. Create **test_reps_reasonable.sql**:
```sql
-- Custom test: Ensure reps are in reasonable range (1-100)
-- Returns rows that FAIL the test
SELECT
    set_id,
    reps,
    logged_at
FROM {{ ref('fact_sets') }}
WHERE reps < 1 OR reps > 100
```

These are singular tests - they pass if they return 0 rows.
  </action>
  <verify>Run `cd dbt && dbt test --select test_weight_positive test_reps_reasonable` - tests should pass (0 failures)</verify>
  <done>Custom tests exist and validate data quality rules</done>
</task>

</tasks>

<verification>
- [ ] All mart models compile with `dbt compile`
- [ ] Schema documentation includes descriptions for all columns
- [ ] `dbt test` runs all generic and custom tests
- [ ] `dbt docs generate` produces catalog.json
- [ ] vw_exercise_history filters to last 14 days
- [ ] fact_prs only contains rows where is_pr = true
</verification>

<success_criteria>
- fact_sets, fact_workouts, fact_prs tables created
- vw_exercise_history view with 2-week filter and gym context
- Schema docs describe all models and columns (DATA-06)
- Custom tests validate positive weights and reasonable reps (DATA-05)
- `dbt docs generate` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/03-history-analytics/03-03-SUMMARY.md`
</output>
