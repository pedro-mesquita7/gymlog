---
phase: 03-history-analytics
plan: 06
type: execute
wave: 5
depends_on: ["03-04"]
files_modified:
  - src/components/history/PRIndicator.tsx
  - src/components/history/PRList.tsx
  - src/components/history/EstimatedMaxDisplay.tsx
  - src/components/workout/SetLogger.tsx
autonomous: true

must_haves:
  truths:
    - "User sees automatic PR detection when logging a new PR"
    - "User can view estimated 1RM for exercises"
    - "User can view list of all PRs per exercise"
  artifacts:
    - path: "src/components/history/PRIndicator.tsx"
      provides: "Real-time PR detection notification"
      contains: "New PR"
    - path: "src/components/history/PRList.tsx"
      provides: "List of all PRs for an exercise"
      contains: "PRList"
    - path: "src/components/history/EstimatedMaxDisplay.tsx"
      provides: "1RM display component"
      contains: "1RM"
  key_links:
    - from: "src/components/workout/SetLogger.tsx"
      to: "src/hooks/useHistory.ts"
      via: "useExerciseMax for PR detection"
      pattern: "useExerciseMax"
---

<objective>
Create PR detection, PR list, and 1RM display components for the workout logging flow.

Purpose: Implements HIST-03 (automatic PR detection during logging), HIST-04 (estimated 1RM display), and HIST-05 (PR list per exercise).
Output: 3 new components + SetLogger integration for real-time PR feedback.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-history-analytics/03-RESEARCH.md

# Hooks from 03-05
@src/hooks/useHistory.ts

# Types from 03-05
@src/types/analytics.ts

# SetLogger to integrate with
@src/components/workout/SetLogger.tsx

# Existing UI patterns
@src/components/workout/ExerciseView.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PR detection and display components</name>
  <files>
    src/components/history/PRIndicator.tsx
    src/components/history/EstimatedMaxDisplay.tsx
  </files>
  <action>
Create components in src/components/history/:

1. **PRIndicator.tsx** - Animated PR notification (HIST-03):
```typescript
import { useEffect, useState } from 'react';

interface PRIndicatorProps {
  type: 'weight' | '1rm' | 'weight_and_1rm';
  previousValue: number;
  newValue: number;
  show: boolean;
  onDismiss?: () => void;
}

export function PRIndicator({
  type,
  previousValue,
  newValue,
  show,
  onDismiss,
}: PRIndicatorProps) {
  const [isVisible, setIsVisible] = useState(false);

  useEffect(() => {
    if (show) {
      setIsVisible(true);
      // Auto-dismiss after 3 seconds
      const timer = setTimeout(() => {
        setIsVisible(false);
        onDismiss?.();
      }, 3000);
      return () => clearTimeout(timer);
    }
  }, [show, onDismiss]);

  if (!isVisible) return null;

  const improvement = newValue - previousValue;
  const typeLabel = type === 'weight'
    ? 'Weight PR!'
    : type === '1rm'
    ? '1RM PR!'
    : 'Weight & 1RM PR!';

  return (
    <div className="fixed inset-x-0 top-20 flex justify-center z-50 animate-bounce">
      <div className="bg-amber-500 text-black px-6 py-3 rounded-full shadow-lg flex items-center gap-3">
        <span className="text-2xl">üèÜ</span>
        <div>
          <div className="font-bold">{typeLabel}</div>
          <div className="text-sm">
            +{improvement.toFixed(1)}kg from {previousValue.toFixed(1)}kg
          </div>
        </div>
      </div>
    </div>
  );
}

// Simpler inline badge version for history lists
export function PRBadge({ type }: { type: 'weight' | '1rm' | 'weight_and_1rm' }) {
  const label = type === 'weight_and_1rm' ? 'PR' : type === 'weight' ? 'W' : '1RM';
  const title = type === 'weight_and_1rm'
    ? 'Weight and 1RM Personal Record'
    : type === 'weight'
    ? 'Weight Personal Record'
    : '1RM Personal Record';

  return (
    <span
      title={title}
      className="px-2 py-0.5 bg-amber-500/20 text-amber-400 text-xs font-bold rounded"
    >
      {label}
    </span>
  );
}
```

2. **EstimatedMaxDisplay.tsx** - 1RM display component (HIST-04):
```typescript
import { useExerciseMax } from '../../hooks/useHistory';

interface EstimatedMaxDisplayProps {
  exerciseId: string;
  className?: string;
}

export function EstimatedMaxDisplay({
  exerciseId,
  className = '',
}: EstimatedMaxDisplayProps) {
  const max = useExerciseMax(exerciseId);

  if (!max || (max.max_weight === null && max.max_1rm === null)) {
    return null;
  }

  return (
    <div className={`text-sm text-zinc-400 ${className}`}>
      {max.max_weight !== null && (
        <span>
          Max: <span className="text-white font-medium">{max.max_weight}kg</span>
        </span>
      )}
      {max.max_1rm !== null && (
        <span className="ml-3">
          Est. 1RM: <span className="text-white font-medium">{max.max_1rm.toFixed(1)}kg</span>
        </span>
      )}
    </div>
  );
}

// Compact version for exercise cards
export function CompactMaxDisplay({
  maxWeight,
  max1RM,
}: {
  maxWeight: number | null;
  max1RM: number | null;
}) {
  if (maxWeight === null && max1RM === null) return null;

  return (
    <div className="text-xs text-zinc-500">
      {maxWeight !== null && <span>Max {maxWeight}kg</span>}
      {maxWeight !== null && max1RM !== null && <span> ‚Ä¢ </span>}
      {max1RM !== null && <span>~{max1RM.toFixed(0)}kg 1RM</span>}
    </div>
  );
}
```
  </action>
  <verify>Components render without errors, check TypeScript compilation</verify>
  <done>PRIndicator shows animated PR notification, EstimatedMaxDisplay shows max weight and 1RM</done>
</task>

<task type="auto">
  <name>Task 2: Create PRList component</name>
  <files>src/components/history/PRList.tsx</files>
  <action>
Create PR list component (HIST-05):

```typescript
import { usePRList } from '../../hooks/useHistory';
import { PRBadge } from './PRIndicator';

interface PRListProps {
  exerciseId: string;
  exerciseName: string;
  onClose?: () => void;
}

export function PRList({ exerciseId, exerciseName, onClose }: PRListProps) {
  const { prs, isLoading, error } = usePRList(exerciseId);

  const formatDate = (dateStr: string) => {
    return new Date(dateStr).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
    });
  };

  if (isLoading) {
    return (
      <div className="p-4 text-center text-zinc-400">
        Loading PRs...
      </div>
    );
  }

  if (error) {
    return (
      <div className="p-4 text-center text-red-400">
        Error: {error}
      </div>
    );
  }

  return (
    <div className="bg-zinc-900 rounded-lg">
      {/* Header */}
      <div className="flex items-center justify-between p-4 border-b border-zinc-800">
        <h3 className="text-lg font-semibold flex items-center gap-2">
          <span className="text-amber-400">üèÜ</span>
          {exerciseName} - PRs
        </h3>
        {onClose && (
          <button
            onClick={onClose}
            className="text-zinc-400 hover:text-white"
          >
            Close
          </button>
        )}
      </div>

      {/* PR list */}
      <div className="p-4 max-h-96 overflow-y-auto">
        {prs.length === 0 ? (
          <p className="text-center text-zinc-500 py-8">
            No PRs yet. Keep training!
          </p>
        ) : (
          <div className="space-y-3">
            {prs.map((pr, idx) => (
              <div
                key={pr.set_id}
                className="flex items-center justify-between py-3 px-4 bg-zinc-800 rounded-lg"
              >
                <div className="flex items-center gap-4">
                  <span className="text-amber-400 font-bold text-lg">
                    #{prs.length - idx}
                  </span>
                  <div>
                    <div className="font-medium">
                      {pr.weight_kg}kg x {pr.reps}
                    </div>
                    {pr.estimated_1rm && (
                      <div className="text-sm text-zinc-400">
                        Est. 1RM: {pr.estimated_1rm.toFixed(1)}kg
                      </div>
                    )}
                  </div>
                </div>
                <div className="flex items-center gap-3">
                  <PRBadge type={pr.pr_type} />
                  <span className="text-sm text-zinc-500">
                    {formatDate(pr.logged_at)}
                  </span>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Summary */}
      {prs.length > 0 && (
        <div className="p-4 border-t border-zinc-800 text-sm text-zinc-400">
          Total PRs: {prs.length}
        </div>
      )}
    </div>
  );
}
```
  </action>
  <verify>Component renders PR list correctly with badges and dates</verify>
  <done>PRList displays all PRs for an exercise with type badges and dates</done>
</task>

<task type="auto">
  <name>Task 3: Integrate PR detection into SetLogger</name>
  <files>src/components/workout/SetLogger.tsx</files>
  <action>
Update SetLogger to detect and display PRs during logging:

1. Import useExerciseMax hook and PRIndicator component
2. Add PR detection logic when logging a set
3. Show PR notification when a new PR is detected

Key changes:
```typescript
// Add imports
import { useExerciseMax } from '../../hooks/useHistory';
import { PRIndicator } from '../history/PRIndicator';

// Inside component, add:
const exerciseMax = useExerciseMax(exerciseId);
const [showPR, setShowPR] = useState(false);
const [prInfo, setPrInfo] = useState<{
  type: 'weight' | '1rm' | 'weight_and_1rm';
  previousValue: number;
  newValue: number;
} | null>(null);

// In handleSubmit, before calling onLogSet:
// Calculate if this is a PR
const estimated1rm = reps >= 1 && reps <= 15 ? weight * (1 + reps / 30) : null;
const isWeightPR = exerciseMax?.max_weight === null || weight > (exerciseMax?.max_weight ?? 0);
const is1rmPR = estimated1rm !== null && (exerciseMax?.max_1rm === null || estimated1rm > (exerciseMax?.max_1rm ?? 0));

if (isWeightPR || is1rmPR) {
  const prType = isWeightPR && is1rmPR
    ? 'weight_and_1rm'
    : isWeightPR
    ? 'weight'
    : '1rm';

  setPrInfo({
    type: prType,
    previousValue: prType === '1rm' ? (exerciseMax?.max_1rm ?? 0) : (exerciseMax?.max_weight ?? 0),
    newValue: prType === '1rm' ? estimated1rm! : weight,
  });
  setShowPR(true);
}

// In JSX, add PRIndicator at top of return:
{prInfo && (
  <PRIndicator
    type={prInfo.type}
    previousValue={prInfo.previousValue}
    newValue={prInfo.newValue}
    show={showPR}
    onDismiss={() => setShowPR(false)}
  />
)}

// Also add EstimatedMaxDisplay below "Last session reference":
<EstimatedMaxDisplay exerciseId={exerciseId} className="text-center mb-2" />
```

Note: Keep all existing functionality. Only ADD PR detection without removing any existing code.
  </action>
  <verify>SetLogger shows PR notification when weight exceeds previous max</verify>
  <done>SetLogger detects PRs in real-time and shows animated notification (HIST-03)</done>
</task>

</tasks>

<verification>
- [ ] PRIndicator shows animated notification on new PR
- [ ] PRBadge displays correctly in history views
- [ ] EstimatedMaxDisplay shows max weight and 1RM
- [ ] PRList shows all PRs for an exercise
- [ ] SetLogger detects and notifies on weight PR
- [ ] SetLogger detects and notifies on 1RM PR
- [ ] TypeScript compiles without errors
</verification>

<success_criteria>
- PR detection happens in real-time during set logging (HIST-03)
- 1RM displayed using Epley formula (HIST-04)
- PR list shows all historical PRs per exercise (HIST-05)
- PRs auto-dismiss after 3 seconds
- All components follow existing styling patterns
</success_criteria>

<output>
After completion, create `.planning/phases/03-history-analytics/03-06-SUMMARY.md`
</output>
