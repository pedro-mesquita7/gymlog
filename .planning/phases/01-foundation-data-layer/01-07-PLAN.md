---
phase: 01-foundation-data-layer
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/db/duckdb-init.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Data persists across page refresh"
    - "DuckDB uses OPFS storage instead of memory"
    - "App reports 'persistent mode' in status"
  artifacts:
    - path: "package.json"
      provides: "Stable DuckDB-WASM dependency"
      contains: "1.32.0"
    - path: "src/db/duckdb-init.ts"
      provides: "OPFS persistence initialization"
      contains: "opfs://"
  key_links:
    - from: "src/db/duckdb-init.ts"
      to: "OPFS filesystem"
      via: "db.open({ path: 'opfs://gymlog.db' })"
      pattern: "opfs://"
---

<objective>
Enable OPFS persistence by upgrading to stable DuckDB-WASM and re-enabling persistent storage.

Purpose: DATA-02 requirement (DuckDB-WASM with Parquet files in OPFS) is currently blocked because v1.33.1-dev18.0 has file locking bugs. Without persistence, the app is demo-only - data is lost on refresh.

Output: Working OPFS persistence where data survives page refresh.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation-data-layer/01-VERIFICATION.md
@src/db/duckdb-init.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upgrade DuckDB-WASM to stable version</name>
  <files>package.json</files>
  <action>
Update @duckdb/duckdb-wasm from "^1.33.1-dev18.0" to "1.32.0" (latest stable release).

Why 1.32.0:
- Last stable release without -dev suffix
- Dev versions (1.33.1-dev*) have known OPFS file locking issues causing "function signature mismatch" errors
- Pin exact version (no caret) to avoid accidental upgrade to dev versions

Run `npm install` after updating package.json to download the new version.
  </action>
  <verify>
Run: `npm list @duckdb/duckdb-wasm`
Expected: `@duckdb/duckdb-wasm@1.32.0`
  </verify>
  <done>package.json shows "1.32.0" and node_modules has this version installed</done>
</task>

<task type="auto">
  <name>Task 2: Re-enable OPFS persistence in DuckDB initialization</name>
  <files>src/db/duckdb-init.ts</files>
  <action>
Modify `initDuckDB()` to use OPFS persistence:

1. Change line 33 from:
   `await db.open({ path: ':memory:' });`
   to:
   `await db.open({ path: 'opfs://gymlog.db' });`

2. Set `isPersistent = true;` (line 34)

3. Update console.log message to say "DuckDB initialized (OPFS persistent mode)"

4. Remove or update the TODO comment on line 31-32 since we're re-enabling OPFS

The `opfs://` protocol tells DuckDB-WASM to use the Origin Private File System for storage.
  </action>
  <verify>
Run: `npm run dev`
Open browser console, look for "DuckDB initialized (OPFS persistent mode)"
Create an exercise, refresh page, exercise should still be there
  </verify>
  <done>
- duckdb-init.ts uses `opfs://gymlog.db` path
- App shows "persistent mode" status (not "demo mode")
- Data survives page refresh
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify persistence with functional test</name>
  <files>None (verification only)</files>
  <action>
Test the persistence workflow:

1. Start dev server with `npm run dev`
2. Open http://localhost:5173 in browser
3. Create a gym named "Test Gym"
4. Create an exercise named "Test Exercise"
5. Check browser DevTools console for "OPFS persistent mode" message
6. Refresh the page (F5 or Ctrl+R)
7. Verify gym and exercise still exist after refresh
8. Check that header does NOT show "demo mode" badge

If data is lost after refresh:
- Check console for OPFS errors
- Verify browser supports OPFS (Chrome 89+, Firefox 111+, Safari 15.2+)
- May need to clear browser storage and retry
  </action>
  <verify>
After page refresh:
- Gym "Test Gym" still visible
- Exercise "Test Exercise" still visible
- No "demo mode" badge in header
- Console shows "OPFS persistent mode"
  </verify>
  <done>Data persists across page refresh, DATA-02 requirement satisfied</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `npm list @duckdb/duckdb-wasm` shows `1.32.0`
2. `grep -n "opfs://" src/db/duckdb-init.ts` returns a match
3. Browser test: data survives page refresh
4. No "demo mode" badge in header when running
</verification>

<success_criteria>
- DuckDB-WASM upgraded to stable 1.32.0
- OPFS persistence enabled with `opfs://gymlog.db` path
- Data survives browser refresh
- App shows "persistent mode" (no demo mode badge)
- DATA-02 requirement satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-data-layer/01-07-SUMMARY.md`
</output>
