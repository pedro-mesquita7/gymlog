---
phase: 01-foundation-data-layer
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/database.ts
  - src/db/queries.ts
  - src/components/GymList.tsx
  - src/App.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User sees exercise count for each gym in the gym list"
    - "User sees total event count in the header"
  artifacts:
    - path: "src/types/database.ts"
      provides: "Gym type with exercise_count field"
      contains: "exercise_count"
    - path: "src/db/queries.ts"
      provides: "Query that calculates exercise count per gym"
      contains: "COUNT"
    - path: "src/components/GymList.tsx"
      provides: "Exercise count display per gym"
      contains: "exercise"
    - path: "src/App.tsx"
      provides: "Event count display in header"
      contains: "eventCount"
  key_links:
    - from: "src/components/GymList.tsx"
      to: "Gym.exercise_count"
      via: "render exercise count text"
      pattern: "exercise_count"
    - from: "src/App.tsx"
      to: "useDuckDB.eventCount"
      via: "display in header"
      pattern: "eventCount"
---

<objective>
Add exercise count to gym list display and show event count in header for user feedback.

Purpose: Two minor UX gaps identified in verification - (1) no exercise count per gym makes it hard to know impact before deletion, (2) eventCount is fetched but never displayed, missing visual feedback on event sourcing activity.

Output: Enhanced UI showing exercise counts on gyms and event count in header.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation-data-layer/01-VERIFICATION.md
@src/types/database.ts
@src/db/queries.ts
@src/components/GymList.tsx
@src/App.tsx
@src/hooks/useDuckDB.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add exercise count to Gym type and query</name>
  <files>src/types/database.ts, src/db/queries.ts</files>
  <action>
1. In `src/types/database.ts`, add `exercise_count` field to the Gym interface:
   ```typescript
   export interface Gym {
     gym_id: string;
     name: string;
     location: string | null;
     exercise_count: number;  // Count of gym-specific exercises
   }
   ```

2. In `src/db/queries.ts`, update `getGyms()` to calculate exercise count:
   - Replace the simple `DIM_GYM_SQL` query with a custom query that:
   - LEFT JOINs to exercises (non-deleted, where is_global = false AND gym_id matches)
   - Groups by gym and counts exercises
   - Returns exercise_count alongside other gym fields

   Use this SQL pattern:
   ```sql
   WITH gyms AS (
     -- existing DIM_GYM_SQL logic (deduplicate gym events)
     ...
   ),
   gym_exercises AS (
     SELECT
       -- extract gym_id from exercise events where is_global = false
       JSON_EXTRACT_STRING(payload, '$.gym_id') as gym_id,
       JSON_EXTRACT_STRING(payload, '$.exercise_id') as exercise_id
     FROM events
     WHERE event_type = 'exercise_created'
       AND JSON_EXTRACT_STRING(payload, '$.is_global') = 'false'
       AND JSON_EXTRACT_STRING(payload, '$.exercise_id') NOT IN (
         SELECT JSON_EXTRACT_STRING(payload, '$.exercise_id')
         FROM events
         WHERE event_type = 'exercise_deleted'
       )
   )
   SELECT
     g.gym_id,
     g.name,
     g.location,
     COALESCE(COUNT(ge.exercise_id), 0) as exercise_count
   FROM gyms g
   LEFT JOIN gym_exercises ge ON g.gym_id = ge.gym_id
   GROUP BY g.gym_id, g.name, g.location
   ```

   Note: Since we're using event sourcing, we need to query the events table directly rather than relying on a dimension table for the count. This is a trade-off for simplicity - a more optimized approach would maintain a separate count in a materialized view.

3. Update the result mapping in `getGyms()` to include `exercise_count`:
   ```typescript
   return result.toArray().map(row => ({
     gym_id: row.gym_id as string,
     name: row.name as string,
     location: row.location as string | null,
     exercise_count: Number(row.exercise_count) || 0,
   }));
   ```
  </action>
  <verify>
After updating, run `npm run dev` and check browser console for any query errors.
Create a gym, create an exercise with is_global=false for that gym, verify the count updates.
  </verify>
  <done>
- Gym interface has exercise_count: number field
- getGyms() query calculates exercise count via JOIN
- No TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Display exercise count in GymList component</name>
  <files>src/components/GymList.tsx</files>
  <action>
Update GymList.tsx to display exercise count for each gym:

1. In the gym item render (around line 80-85), add exercise count display below the location:
   ```tsx
   <div>
     <h3 className="font-medium">{gym.name}</h3>
     {gym.location && (
       <p className="text-sm text-zinc-500 mt-0.5">{gym.location}</p>
     )}
     <p className="text-xs text-zinc-600 mt-0.5">
       {gym.exercise_count} {gym.exercise_count === 1 ? 'exercise' : 'exercises'}
     </p>
   </div>
   ```

2. Also update the delete confirmation message to show exercise count impact:
   ```tsx
   message={`Delete "${deletingGym?.name}"?${deletingGym?.exercise_count ? ` This will affect ${deletingGym.exercise_count} gym-specific exercise${deletingGym.exercise_count === 1 ? '' : 's'}.` : ''} This cannot be undone.`}
   ```

The exercise count helps users understand which gyms have gym-specific exercises before deletion.
  </action>
  <verify>
Run `npm run dev`, view the gym list:
- Each gym shows "N exercises" text
- Gyms with 0 exercises show "0 exercises"
- Delete confirmation shows exercise count warning
  </verify>
  <done>
- GymList displays exercise count for each gym
- Singular/plural grammar is correct (1 exercise vs 2 exercises)
- Delete confirmation mentions affected exercises
  </done>
</task>

<task type="auto">
  <name>Task 3: Display event count in App header</name>
  <files>src/App.tsx</files>
  <action>
Update App.tsx to display the event count that's already being fetched:

1. On line 8, ensure `eventCount` is destructured from useDuckDB():
   ```typescript
   const { status, eventCount, refreshEventCount } = useDuckDB();
   ```

2. In the header section (around line 85-93), add event count display next to the demo mode badge:
   ```tsx
   <header className="border-b border-zinc-800">
     <div className="max-w-2xl mx-auto px-6 py-6 flex items-baseline justify-between">
       <h1 className="text-2xl font-bold tracking-tight">
         Gym<span className="text-accent">Log</span>
       </h1>
       <div className="flex items-baseline gap-3">
         {eventCount > 0 && (
           <span className="text-xs text-zinc-500 font-mono">
             {eventCount} events
           </span>
         )}
         {!status.isPersistent && (
           <span className="text-xs text-zinc-500 font-mono">demo mode</span>
         )}
       </div>
     </div>
   </header>
   ```

This shows users that event sourcing is working and gives feedback that their actions are being recorded.
  </action>
  <verify>
Run `npm run dev`:
- Header shows "N events" when events exist
- Event count updates after creating/editing/deleting items
- Badge is visible but subtle (zinc-500 color)
  </verify>
  <done>
- App.tsx renders eventCount in header
- Event count updates after each operation
- Visual style matches demo mode badge
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `npm run dev` starts without errors
2. Create a gym - "0 exercises" shown
3. Create a gym-specific exercise - count updates to "1 exercise"
4. Header shows event count (e.g., "3 events")
5. Delete gym - confirmation shows exercise count warning
6. TypeScript: `npx tsc --noEmit` passes
</verification>

<success_criteria>
- Gym interface includes exercise_count field
- getGyms() calculates exercise count per gym
- GymList displays exercise count for each gym
- Delete confirmation shows exercise count impact
- Header displays total event count
- All TypeScript types are correct
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-data-layer/01-08-SUMMARY.md`
</output>
