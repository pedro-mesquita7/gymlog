---
phase: 23-analytics-simplification
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - src/components/analytics/AnalyticsPage.tsx
  - src/hooks/useWeekComparisonSubtitle.ts (NEW)
  - src/db/compiled-queries.ts
autonomous: false

must_haves:
  truths:
    - "Exercise progress section shows week-over-week subtitle with weight and volume change percentages"
    - "When no previous week data exists, subtitle shows 'First session' instead of hiding"
    - "Subtitle updates when exercise selection changes"
    - "Subtitle updates when time range changes"
  artifacts:
    - path: "src/hooks/useWeekComparisonSubtitle.ts"
      provides: "Lightweight hook returning formatted subtitle string for week comparison"
      exports: ["useWeekComparisonSubtitle"]
  key_links:
    - from: "src/components/analytics/AnalyticsPage.tsx"
      to: "src/hooks/useWeekComparisonSubtitle.ts"
      via: "hook call in exercise progress section"
      pattern: "useWeekComparisonSubtitle"
    - from: "src/hooks/useWeekComparisonSubtitle.ts"
      to: "src/db/compiled-queries.ts"
      via: "SQL query for week comparison data"
      pattern: "getDuckDB|compiled-queries"
---

<objective>
Build a lightweight week-over-week comparison subtitle for the exercise progress section. The old WeekComparisonCard was a full standalone section -- now the useful data (weight/volume % changes) becomes a single line of text below the exercise progress chart title.

Purpose: Retain the valuable week-over-week insight without the UI weight of a dedicated card.
Output: New hook + wired subtitle in AnalyticsPage exercise progress section.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/23-analytics-simplification/23-CONTEXT.md
@.planning/phases/23-analytics-simplification/23-01-SUMMARY.md
@src/components/analytics/AnalyticsPage.tsx
@src/db/compiled-queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useWeekComparisonSubtitle hook and wire into AnalyticsPage</name>
  <files>
    src/hooks/useWeekComparisonSubtitle.ts (NEW)
    src/db/compiled-queries.ts
    src/components/analytics/AnalyticsPage.tsx
  </files>
  <action>
    1. Create src/hooks/useWeekComparisonSubtitle.ts:
       - Accepts `{ exerciseId: string }` parameter
       - Runs a SQL query comparing the most recent 2 weeks of data for the given exercise
       - SQL approach: take all sets for this exercise in the last 14 days, split into current week (last 7 days) and previous week (8-14 days ago). Calculate max weight and total volume for each week. Compute percentage changes.
       - Add the SQL as a function in compiled-queries.ts (e.g., `weekComparisonSubtitleSQL(exerciseId: string)`) or inline it in the hook -- Claude's discretion.
       - Returns `{ subtitle: string; isLoading: boolean }`:
         - If both weeks have data: format as "+5% weight, +12% volume vs last week" (or "-3% weight, +8% volume vs last week"). Use green/red color hints in the string or return raw data for the component to style.
         - If only current week has data: return "First session" (or "First week")
         - If no data at all: return empty string
       - The hook should NOT depend on the global time range -- it always compares the last 2 calendar weeks (this is about recent momentum, not filtered history)

    2. Wire into AnalyticsPage.tsx:
       - Import useWeekComparisonSubtitle
       - Call it with the selected exercise ID: `const { subtitle: weekSubtitle, isLoading: subtitleLoading } = useWeekComparisonSubtitle({ exerciseId: selectedExerciseId })`
       - Display the subtitle below the exercise selector dropdown, above the ExerciseProgressChart component
       - Use small muted text styling (text-sm text-text-secondary) for the subtitle
       - If subtitle is empty or loading, render nothing (no empty space)
       - Format: show percentage changes with directional arrows or +/- signs. Color-code if desired (green for positive, red for negative) using text-success/text-error or similar existing utility classes.

    3. Handle edge cases:
       - Exercise with only one session ever: show "First session"
       - Exercise done this week but not last week: show week stats without comparison (e.g., "3 sets, 60kg max this week")
       - Exercise not done this week at all: show empty string (no subtitle)
  </action>
  <verify>
    Run `npx tsc --noEmit` -- passes.
    Run `npm run build` -- succeeds.
    Run `npm run dev` and check:
    - Select an exercise with 2+ weeks of data -- subtitle shows percentage changes
    - Select an exercise with only 1 week of data -- subtitle shows "First session" or equivalent
    - Change exercise selection -- subtitle updates
  </verify>
  <done>
    Exercise progress section shows a subtitle line with week-over-week weight and volume change percentages. "First session" shown when no previous week data. Build passes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Simplified analytics page: removed comparison/progression/plateau sections, added collapsible sections, 3-card summary stats, week comparison subtitle on exercise progress, new section order.</what-built>
  <how-to-verify>
    1. Run `npm run dev` and navigate to Analytics tab
    2. Verify page sections top to bottom: Time Range Picker, Summary Stats (3 cards: Workouts, Volume, PRs), Exercise Progress (collapsible, with week comparison subtitle), PRs (collapsible), Volume Overview (collapsible), Training Balance / Heat Map (collapsible)
    3. Verify NO comparison section, NO progression dashboard, NO standalone week comparison card
    4. Change time range (1M/3M/6M/1Y/All) -- charts and stats update
    5. Select different exercises -- progress chart and subtitle update
    6. Collapse/expand sections -- all work
    7. Check mobile layout -- 3 stat cards fit in a row
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. Week comparison subtitle appears below exercise selector dropdown, above the chart
4. Subtitle shows "+X% weight, +Y% volume vs last week" format
5. Subtitle shows "First session" when no previous week data
6. Subtitle is empty/hidden when exercise has no data this week
7. No console errors on analytics page
</verification>

<success_criteria>
- useWeekComparisonSubtitle hook exists and returns formatted subtitle
- Exercise progress section displays the subtitle when data is available
- Full analytics page passes visual inspection (human checkpoint)
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/23-analytics-simplification/23-02-SUMMARY.md`
</output>
