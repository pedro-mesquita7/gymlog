---
phase: 17-pwa-performance-readme-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vite.config.ts
  - package.json
  - src/sw.ts
  - index.html
  - public/manifest.webmanifest
  - public/pwa-192x192.png
  - public/pwa-512x512.png
  - public/maskable-icon-512x512.png
  - public/apple-touch-icon-180x180.png
  - public/favicon.ico
autonomous: true

must_haves:
  truths:
    - "App works fully offline after first load -- all assets cached by service worker"
    - "DuckDB-WASM CDN resources are cached for offline use via runtime caching"
    - "COI headers (COOP/COEP) are injected by the new combined service worker, replacing coi-serviceworker.js"
    - "PWA manifest produces installable prompt with correct name, icons, and theme color"
  artifacts:
    - path: "src/sw.ts"
      provides: "Combined COI + Workbox service worker"
      contains: "precacheAndRoute"
    - path: "vite.config.ts"
      provides: "vite-plugin-pwa configuration with injectManifest strategy"
      contains: "VitePWA"
    - path: "public/pwa-192x192.png"
      provides: "192x192 PWA icon"
    - path: "public/pwa-512x512.png"
      provides: "512x512 PWA icon"
    - path: "public/maskable-icon-512x512.png"
      provides: "512x512 maskable PWA icon"
  key_links:
    - from: "src/sw.ts"
      to: "workbox-precaching"
      via: "precacheAndRoute(self.__WB_MANIFEST)"
      pattern: "precacheAndRoute.*__WB_MANIFEST"
    - from: "src/sw.ts"
      to: "cdn.jsdelivr.net"
      via: "CacheFirst runtime caching for DuckDB WASM"
      pattern: "cdn\\.jsdelivr\\.net"
    - from: "vite.config.ts"
      to: "src/sw.ts"
      via: "injectManifest strategy pointing to sw.ts"
      pattern: "strategies.*injectManifest"
---

<objective>
Set up a production-ready PWA with offline support by combining the existing COI service worker with Workbox precaching into a single service worker, adding a proper web manifest with icons, and configuring vite-plugin-pwa.

Purpose: The app must work fully offline after first load (PWA-01) and be installable on mobile devices (PWA-02). The existing coi-serviceworker.js must be replaced with a combined SW that handles both COI headers and asset caching.

Output: Working PWA configuration with offline support, installable manifest, and proper icons.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/17-pwa-performance-readme-polish/17-RESEARCH.md
@vite.config.ts
@index.html
@package.json
@public/coi-serviceworker.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install vite-plugin-pwa and create combined service worker</name>
  <files>package.json, src/sw.ts, vite.config.ts</files>
  <action>
1. Install vite-plugin-pwa: `npm install -D vite-plugin-pwa`

2. Create `src/sw.ts` -- a combined service worker that replaces `coi-serviceworker.js`:

```typescript
import { precacheAndRoute, cleanupOutdatedCaches } from 'workbox-precaching';
import { clientsClaim } from 'workbox-core';
import { registerRoute } from 'workbox-routing';
import { CacheFirst } from 'workbox-strategies';
import { ExpirationPlugin } from 'workbox-expiration';

declare let self: ServiceWorkerGlobalScope;

// Auto-update: new SW activates immediately, takes control of all clients
self.skipWaiting();
clientsClaim();

// Workbox precaching -- caches all Vite-built assets
cleanupOutdatedCaches();
precacheAndRoute(self.__WB_MANIFEST);

// Runtime caching for DuckDB-WASM CDN resources (jsDelivr)
registerRoute(
  ({ url }) => url.hostname === 'cdn.jsdelivr.net' &&
    (url.pathname.includes('duckdb') || url.pathname.endsWith('.wasm')),
  new CacheFirst({
    cacheName: 'duckdb-wasm-cdn',
    plugins: [
      new ExpirationPlugin({ maxEntries: 10, maxAgeSeconds: 30 * 24 * 60 * 60 }),
    ],
  })
);

// COI header injection -- replaces public/coi-serviceworker.js
// Required for SharedArrayBuffer (DuckDB-WASM OPFS persistence)
self.addEventListener('fetch', (event: FetchEvent) => {
  const request = event.request;
  // Workaround for Chrome DevTools bug
  if (request.cache === 'only-if-cached' && request.mode !== 'same-origin') return;

  if (request.mode === 'navigate') {
    event.respondWith(
      (async () => {
        const response = await fetch(request);
        const newHeaders = new Headers(response.headers);
        newHeaders.set('Cross-Origin-Embedder-Policy', 'require-corp');
        newHeaders.set('Cross-Origin-Opener-Policy', 'same-origin');
        return new Response(response.body, {
          status: response.status,
          statusText: response.statusText,
          headers: newHeaders,
        });
      })()
    );
  }
});
```

3. Update `vite.config.ts`:
- Import `VitePWA` from `vite-plugin-pwa`
- Add VitePWA plugin with `injectManifest` strategy:
  - `strategies: 'injectManifest'`
  - `srcDir: 'src'`
  - `filename: 'sw.ts'`
  - `registerType: 'autoUpdate'`
  - `injectRegister: 'script-defer'` (avoids CSP issues with inline scripts)
  - `manifest: false` (we'll use a static manifest file for more control)
  - `injectManifest.globPatterns: ['**/*.{js,css,html,ico,png,svg,woff,woff2}']`
  - `devOptions.enabled: false`

- Update CSP in the `strip-csp-dev` plugin comment to note that connect-src needs `https://cdn.jsdelivr.net` for DuckDB CDN.

DO NOT remove the existing `strip-csp-dev` plugin -- it's still needed for dev mode HMR.
  </action>
  <verify>
- `npm ls vite-plugin-pwa` shows installed
- `src/sw.ts` exists and contains `precacheAndRoute`, `__WB_MANIFEST`, `Cross-Origin-Embedder-Policy`
- `vite.config.ts` imports VitePWA and configures injectManifest strategy
- `npx tsc --noEmit` passes (SW types resolve correctly -- may need `WebWorker` lib in tsconfig or declare)
  </verify>
  <done>vite-plugin-pwa installed and configured with injectManifest strategy; combined SW file handles precaching + CDN caching + COI headers</done>
</task>

<task type="auto">
  <name>Task 2: Create PWA manifest, icons, and update index.html</name>
  <files>public/manifest.webmanifest, public/pwa-192x192.png, public/pwa-512x512.png, public/maskable-icon-512x512.png, public/apple-touch-icon-180x180.png, public/favicon.ico, index.html</files>
  <action>
1. Create PWA icons. Since this is a gym/fitness app with an orange accent color, generate simple solid-color icons programmatically using a canvas approach or SVG-to-PNG conversion. The icons should feature a dumbbell or "GL" text on the app's dark background (#1a1a2e equivalent in sRGB) with the orange accent.

Use a simple approach: create an SVG icon and convert it, OR use the existing vite.svg as a base and create properly sized PNGs. At minimum, create placeholder PNG files at the required sizes (192x192, 512x512, 180x180). These can be simple colored squares with text if needed -- the important thing is they exist at the correct sizes for PWA installability.

For generating icons, use a Node.js script or find a way to create valid PNGs. If generating real icons is too complex, create them as simple solid-color PNGs using a shell approach:
- Use ImageMagick if available (`convert -size 512x512 xc:'#1a1a2e' ...`)
- Or create a minimal valid PNG using Node.js Buffer
- Or use the `@vite-pwa/assets-generator` if available

The maskable icon needs extra padding (safe zone is inner 80%).

2. Create `public/manifest.webmanifest`:
```json
{
  "name": "GymLog - Workout Tracker",
  "short_name": "GymLog",
  "description": "Event-sourced workout tracker with DuckDB-WASM analytics",
  "theme_color": "#1a1a2e",
  "background_color": "#1a1a2e",
  "display": "standalone",
  "orientation": "portrait",
  "scope": "./",
  "start_url": "./",
  "icons": [
    { "src": "pwa-192x192.png", "sizes": "192x192", "type": "image/png" },
    { "src": "pwa-512x512.png", "sizes": "512x512", "type": "image/png" },
    { "src": "maskable-icon-512x512.png", "sizes": "512x512", "type": "image/png", "purpose": "maskable" }
  ]
}
```

Use `./` for scope and start_url so it works with any base path (Vite's base config handles the prefix).

3. Update `index.html`:
- Remove the `<script src="coi-serviceworker.js"></script>` line (replaced by combined SW)
- Add `<link rel="manifest" href="manifest.webmanifest">` in head
- Add `<link rel="apple-touch-icon" href="apple-touch-icon-180x180.png">` in head
- Add `<meta name="theme-color" content="#1a1a2e">` in head
- Add `<meta name="apple-mobile-web-app-capable" content="yes">` in head
- Update CSP `connect-src` to include `https://cdn.jsdelivr.net` for DuckDB CDN fetches through SW
- Add `manifest-src 'self'` to CSP (for web manifest)
- Update the page title to "GymLog - Workout Tracker"

4. Delete `public/coi-serviceworker.js` since it's now replaced by the combined SW.

5. Update `.github/workflows/ci.yml`: Remove the "Copy COI serviceworker" step since vite-plugin-pwa handles SW output in the build.

IMPORTANT: Use relative paths (`./`) in manifest scope/start_url, not absolute paths. The Vite base path configuration handles the prefix at build time.
  </action>
  <verify>
- `public/manifest.webmanifest` exists with correct JSON
- `public/pwa-192x192.png`, `public/pwa-512x512.png`, `public/maskable-icon-512x512.png` exist and are valid PNGs
- `index.html` has manifest link, theme-color meta, apple-touch-icon link, NO coi-serviceworker.js script
- `index.html` CSP includes `connect-src 'self' https://cdn.jsdelivr.net` and `manifest-src 'self'`
- `public/coi-serviceworker.js` is deleted
- `npm run build` succeeds and `dist/` contains SW file, manifest, and icons
- The CI workflow no longer references coi-serviceworker.js copy step
  </verify>
  <done>PWA manifest with icons exists; index.html updated with manifest link, theme-color, and apple-touch-icon; COI serviceworker replaced by combined SW; CI updated; build succeeds with SW in dist</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `ls dist/sw.js` (or similar SW output) exists in build output
3. `ls dist/manifest.webmanifest` exists in build output
4. `dist/` contains PWA icon files
5. `grep -r "coi-serviceworker" dist/` returns nothing (old SW fully replaced)
6. `npx tsc --noEmit` passes
</verification>

<success_criteria>
- App builds successfully with vite-plugin-pwa generating a service worker
- Combined SW handles COI headers + Workbox precaching + DuckDB CDN caching
- PWA manifest is present with correct metadata and icon references
- All PWA icons exist at required sizes
- Old coi-serviceworker.js is removed from public/ and CI workflow
- CSP updated to allow CDN connections and manifest
</success_criteria>

<output>
After completion, create `.planning/phases/17-pwa-performance-readme-polish/17-01-SUMMARY.md`
</output>
