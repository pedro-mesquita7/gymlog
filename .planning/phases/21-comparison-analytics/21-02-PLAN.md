---
phase: 21-comparison-analytics
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - src/components/analytics/ExerciseMultiSelect.tsx
  - src/components/analytics/ComparisonStatCard.tsx
  - src/components/analytics/ComparisonSection.tsx
  - src/components/analytics/AnalyticsPage.tsx
autonomous: false

must_haves:
  truths:
    - "User can select 2-4 exercises from a multi-select picker on the Analytics page"
    - "Selected exercises display side-by-side stat cards showing PR weight and estimated 1RM"
    - "Stat cards show total volume per exercise for the selected time range"
    - "Stat cards show training frequency (sessions per week) per exercise"
    - "Stat cards show progression status (progressing/plateau/regressing) per exercise"
  artifacts:
    - path: "src/components/analytics/ExerciseMultiSelect.tsx"
      provides: "Multi-select exercise picker with chip/tag UI"
      exports: ["ExerciseMultiSelect"]
    - path: "src/components/analytics/ComparisonStatCard.tsx"
      provides: "Per-exercise stat card with PR, volume, frequency, status"
      exports: ["ComparisonStatCard"]
    - path: "src/components/analytics/ComparisonSection.tsx"
      provides: "Orchestrator component wiring multi-select, hook, and stat cards"
      exports: ["ComparisonSection"]
    - path: "src/components/analytics/AnalyticsPage.tsx"
      provides: "Updated page with comparison section integrated"
      contains: "ComparisonSection"
  key_links:
    - from: "src/components/analytics/ComparisonSection.tsx"
      to: "src/hooks/useComparisonStats.ts"
      via: "calls useComparisonStats with selected IDs"
      pattern: "useComparisonStats"
    - from: "src/components/analytics/ComparisonSection.tsx"
      to: "src/components/analytics/ExerciseMultiSelect.tsx"
      via: "renders ExerciseMultiSelect for selection"
      pattern: "ExerciseMultiSelect"
    - from: "src/components/analytics/ComparisonSection.tsx"
      to: "src/components/analytics/ComparisonStatCard.tsx"
      via: "renders ComparisonStatCard per exercise"
      pattern: "ComparisonStatCard"
    - from: "src/components/analytics/AnalyticsPage.tsx"
      to: "src/components/analytics/ComparisonSection.tsx"
      via: "renders ComparisonSection with days and exercises props"
      pattern: "ComparisonSection"
---

<objective>
Build the comparison UI: multi-select exercise picker, stat cards, orchestrator section, and integrate into AnalyticsPage.

Purpose: Delivers the user-facing comparison feature (COMP-01 through COMP-05). Users select 2-4 exercises and see side-by-side stat cards with PRs, volume, frequency, and progression status.
Output: ExerciseMultiSelect, ComparisonStatCard, ComparisonSection components + AnalyticsPage integration
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-comparison-analytics/21-RESEARCH.md
@.planning/phases/21-comparison-analytics/21-01-SUMMARY.md

@src/components/analytics/AnalyticsPage.tsx
@src/components/analytics/ProgressionDashboard.tsx
@src/components/analytics/ProgressionStatusCard.tsx
@src/components/analytics/SectionHeading.tsx
@src/components/ui/FeatureErrorBoundary.tsx
@src/hooks/useComparisonStats.ts
@src/types/analytics.ts
@src/index.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExerciseMultiSelect and ComparisonStatCard components</name>
  <files>src/components/analytics/ExerciseMultiSelect.tsx, src/components/analytics/ComparisonStatCard.tsx</files>
  <action>
**ExerciseMultiSelect.tsx:**
Create a multi-select exercise picker component:
- Props: `exercises: Exercise[]`, `selectedIds: string[]`, `onChange: (ids: string[]) => void`, `maxSelections?: number` (default 4)
- State: `isOpen` (boolean) for dropdown visibility
- UI structure:
  1. Trigger button/area showing selected exercise chips (accent/20 bg, rounded-full, with x remove button each). If none selected, show placeholder "Select exercises to compare..."
  2. Dropdown panel (toggled by clicking trigger area): scrollable list of exercises with checkboxes
  3. Each exercise row: checkbox + exercise name + muscle group in parentheses (text-xs text-text-muted)
  4. Checkboxes disabled when maxSelections reached and exercise is not already selected
  5. Click outside closes dropdown (useEffect with document click listener)
- Styling: Follow existing select styling from AnalyticsPage (bg-bg-tertiary, border-border-primary, rounded-xl). Dropdown: max-h-60 overflow-y-auto, bg-bg-tertiary. Each row: px-4 py-2.5 hover:bg-bg-elevated
- Toggle logic: if selected, remove from array. If not selected and under max, add. If at max, do nothing.
- Add `data-testid="comparison-exercise-select"` on the trigger element
- Show count indicator: "N/4 selected" in small text next to chips

**ComparisonStatCard.tsx:**
Create a stat card component for a single exercise's comparison data:
- Props: `stat: ComparisonStats` (from types/analytics.ts)
- UI structure (vertical card):
  1. Header: exercise name (font-semibold text-sm truncate) + muscle group below (text-xs text-text-muted)
  2. PR section: label "PR" (text-xs text-text-muted), value as "Xkg" (text-lg font-bold), sub-text "Est 1RM: X.Xkg" (text-xs text-text-secondary)
  3. Volume section: label "Volume", value formatted (>= 1000 show as "X.Xt", else "Xkg"), sub-text "N sets"
  4. Frequency section: label "Frequency", value "X.X/wk" (text-lg font-bold), sub-text "N sessions"
  5. Progression status badge at bottom: colored bg pill with status text. Use same status config pattern from ProgressionStatusCard (progressing=success, plateau=warning, regressing=error, unknown=text-muted)
- Card styling: bg-bg-secondary border border-border-primary rounded-2xl p-4 space-y-3
- Handle zero values gracefully: show "---" for maxWeight/maxEstimated1rm if 0, "No data" if totalVolume is 0
- Add `data-testid="comparison-stat-card"` on the card root
  </action>
  <verify>Run `npx tsc --noEmit 2>&1 | head -30` -- no new errors from the two components</verify>
  <done>ExerciseMultiSelect renders a dropdown with checkboxes, enforces 2-4 selection limit. ComparisonStatCard renders all 5 metric sections (PR, volume, frequency, progression) with proper formatting.</done>
</task>

<task type="auto">
  <name>Task 2: Create ComparisonSection and integrate into AnalyticsPage</name>
  <files>src/components/analytics/ComparisonSection.tsx, src/components/analytics/AnalyticsPage.tsx</files>
  <action>
**ComparisonSection.tsx:**
Create an orchestrator component that wires multi-select, hook, and stat cards:
- Props: `days: number | null`, `exercises: Exercise[]`, `progressionData: ProgressionStatus[]`
- State: `selectedIds: string[]` (initially empty)
- Toggle function for exercise selection (same as in ExerciseMultiSelect description)
- Call `useComparisonStats(selectedIds.length >= 2 ? selectedIds : [], days, progressionData)` -- only fetch when 2+ selected
- Render:
  1. ExerciseMultiSelect component with exercises, selectedIds, onChange
  2. If selectedIds.length < 2: show hint "Select at least 2 exercises to compare" (text-sm text-text-muted text-center py-4)
  3. If loading: "Loading comparison..." (text-center py-8 text-text-muted)
  4. If error: error message in text-error
  5. If data: responsive grid of ComparisonStatCards. Use `grid grid-cols-2 gap-3` layout (works for 2, 3, or 4 cards as a 2-column grid)
- Add `data-testid="comparison-section"` on the root div

**AnalyticsPage.tsx:**
Integrate the comparison section:
1. Add imports: ComparisonSection, useProgressionStatus
2. Add `useProgressionStatus(days)` call to get progression data for passing to ComparisonSection
3. Add new section AFTER "Progression Intelligence" section (bottom of page -- comparison is an exploratory deep-dive feature, best placed after the overview sections):
   ```
   {/* SECTION 6: Exercise Comparison */}
   <SectionHeading title="Exercise Comparison" subtitle="Select 2-4 exercises to compare side-by-side" />
   <FeatureErrorBoundary feature="Exercise Comparison">
     <ComparisonSection days={days} exercises={exercises} progressionData={progressionStatusData} />
   </FeatureErrorBoundary>
   ```
4. Pass the progression data from the hook to ComparisonSection to avoid duplicate queries

Note: The ProgressionDashboard already calls useProgressionStatus internally. To avoid calling useProgressionStatus twice (once in AnalyticsPage and once inside ProgressionDashboard), lift the hook call to AnalyticsPage and pass data down to both ProgressionDashboard and ComparisonSection. Update ProgressionDashboard to accept optional progressionData prop, or just accept the minor duplication if refactoring ProgressionDashboard is too disruptive. Prefer the simpler approach: call useProgressionStatus in AnalyticsPage and pass to ComparisonSection only. ProgressionDashboard keeps its own internal call (the DuckDB cache makes this cheap).
  </action>
  <verify>
1. Run `npx tsc --noEmit 2>&1 | head -30` -- no new errors
2. Run `npx vite build 2>&1 | tail -20` -- build succeeds
3. Run `npx vitest run 2>&1 | tail -20` -- existing tests still pass
  </verify>
  <done>ComparisonSection renders multi-select + stat card grid. AnalyticsPage shows "Exercise Comparison" section at bottom with SectionHeading and FeatureErrorBoundary wrapping. Build passes.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete exercise comparison feature: multi-select picker (2-4 exercises), side-by-side stat cards showing PR, volume, frequency, and progression status per exercise, integrated at the bottom of the Analytics page.</what-built>
  <how-to-verify>
1. Open the app and navigate to the Analytics tab
2. Scroll to the bottom -- you should see "Exercise Comparison" section heading with subtitle "Select 2-4 exercises to compare side-by-side"
3. Click the multi-select picker -- a dropdown should appear with all exercises listed with checkboxes
4. Select 1 exercise -- you should see a hint "Select at least 2 exercises to compare"
5. Select a 2nd exercise -- stat cards should appear in a 2-column grid
6. Verify each stat card shows: exercise name, muscle group, PR (weight + est 1RM), Volume (formatted), Frequency (sessions/wk), and Progression status badge
7. Select a 3rd and 4th exercise -- grid should show 4 cards in 2x2 layout
8. Try selecting a 5th exercise -- should be disabled/prevented
9. Remove an exercise by clicking the x on its chip
10. Change the time range picker at the top -- comparison data should update
11. Check mobile responsiveness (narrow browser) -- cards should remain in 2-col grid, not overflow
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript build: `npx tsc --noEmit` -- no new errors
2. Vite build: `npx vite build` -- succeeds
3. Tests: `npx vitest run` -- all existing tests pass
4. Visual: Exercise Comparison section visible on Analytics page
5. Functional: Multi-select works with 2-4 exercise limit, stat cards display all metrics
6. Requirements coverage:
   - COMP-01: Multi-select picker allows 2-4 exercise selection
   - COMP-02: Stat cards show PR weight and estimated 1RM
   - COMP-03: Stat cards show total volume
   - COMP-04: Stat cards show frequency (sessions/week)
   - COMP-05: Stat cards show progression status
</verification>

<success_criteria>
- User can select 2-4 exercises from dropdown on Analytics page
- Selected exercises show side-by-side stat cards in 2-column grid
- Each card displays: PR, estimated 1RM, total volume, frequency, progression status
- Time range picker controls comparison data
- Empty/loading/error states handled gracefully
- Build passes, existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/21-comparison-analytics/21-02-SUMMARY.md`
</output>
