---
phase: 21-comparison-analytics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/analytics.ts
  - src/db/compiled-queries.ts
  - src/hooks/useComparisonStats.ts
autonomous: true

must_haves:
  truths:
    - "useComparisonStats hook returns per-exercise PR, volume, frequency data for an array of exercise IDs"
    - "comparisonStatsSQL generates a single combined query with IN clause for multiple exercises"
    - "ComparisonStats type defines all fields needed for stat cards (PR, volume, frequency, progression status)"
  artifacts:
    - path: "src/types/analytics.ts"
      provides: "ComparisonStats and UseComparisonStatsReturn interfaces"
      contains: "ComparisonStats"
    - path: "src/db/compiled-queries.ts"
      provides: "comparisonStatsSQL function"
      contains: "comparisonStatsSQL"
    - path: "src/hooks/useComparisonStats.ts"
      provides: "useComparisonStats hook"
      exports: ["useComparisonStats"]
  key_links:
    - from: "src/hooks/useComparisonStats.ts"
      to: "src/db/compiled-queries.ts"
      via: "imports comparisonStatsSQL"
      pattern: "comparisonStatsSQL"
    - from: "src/hooks/useComparisonStats.ts"
      to: "src/db/duckdb-init.ts"
      via: "getDuckDB for connection"
      pattern: "getDuckDB"
    - from: "src/hooks/useComparisonStats.ts"
      to: "src/types/analytics.ts"
      via: "imports ComparisonStats type"
      pattern: "ComparisonStats"
---

<objective>
Create the data layer for exercise comparison: TypeScript interfaces, DuckDB SQL query, and React hook.

Purpose: Provides all data primitives needed by the comparison UI (Plan 02). The hook fetches PR, volume, frequency, and progression status for 2-4 selected exercises in a single DuckDB query.
Output: ComparisonStats type, comparisonStatsSQL function, useComparisonStats hook
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-comparison-analytics/21-RESEARCH.md

@src/types/analytics.ts
@src/db/compiled-queries.ts
@src/hooks/useProgressionStatus.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ComparisonStats types and comparisonStatsSQL query</name>
  <files>src/types/analytics.ts, src/db/compiled-queries.ts</files>
  <action>
1. In `src/types/analytics.ts`, add at the end:
   - `ComparisonStats` interface with fields: exerciseId (string), exerciseName (string), muscleGroup (string), maxWeight (number), maxEstimated1rm (number), totalVolume (number), totalSets (number), sessionCount (number), sessionsPerWeek (number), progressionStatus ('progressing' | 'plateau' | 'regressing' | 'unknown')
   - `UseComparisonStatsReturn` interface with: data (ComparisonStats[]), isLoading (boolean), error (string | null), refresh (() => Promise<void>)

2. In `src/db/compiled-queries.ts`, add a new exported function `comparisonStatsSQL(exerciseIds: string[], days: number | null): string` that:
   - Validates each ID matches `/^[0-9a-f-]+$/i` before interpolation (throw if invalid to prevent SQL injection)
   - Builds an `IN (${idList})` clause from validated IDs
   - Uses a time filter on `CAST(fs.logged_at AS TIMESTAMPTZ) >= CURRENT_DATE - INTERVAL '${days} days'` when days is not null, else `1=1`
   - Uses CTEs: fact_sets (from FACT_SETS_SQL), exercise_dim (from DIM_EXERCISE_ALL_SQL), workout_events for session dates
   - pr_stats CTE: MAX(weight_kg) and MAX(estimated_1rm) per original_exercise_id
   - volume_stats CTE: SUM(weight_kg * reps) as total_volume, COUNT(*) as total_sets per original_exercise_id
   - frequency_stats CTE: COUNT(DISTINCT workout_id) as session_count, calculate weeks_span for sessions_per_week using GREATEST(1, EXTRACT(EPOCH FROM (MAX-MIN timestamp)) / 604800)
   - Final SELECT joins exercise_dim with all stats CTEs, filters by IN clause, orders by name
   - Does NOT include progression status in SQL (will be merged from useProgressionStatus in the hook -- see Pitfall 5 in research)

Follow the exact SQL composition pattern from `summaryStatsSQL` and `volumeByMuscleGroupSQL` in the same file. Use FACT_SETS_SQL and DIM_EXERCISE_ALL_SQL constants directly in CTEs.
  </action>
  <verify>Run `npx tsc --noEmit 2>&1 | head -30` -- no new errors introduced in analytics.ts or compiled-queries.ts (pre-existing errors in QuickStartCard/StartWorkout are expected)</verify>
  <done>ComparisonStats interface exported from analytics.ts. comparisonStatsSQL function exported from compiled-queries.ts, generates valid SQL for 1+ exercise IDs with time filtering.</done>
</task>

<task type="auto">
  <name>Task 2: Create useComparisonStats hook</name>
  <files>src/hooks/useComparisonStats.ts</files>
  <action>
Create `src/hooks/useComparisonStats.ts` following the exact pattern from `useProgressionStatus.ts`:
- Import getDuckDB, comparisonStatsSQL, types
- Accept `exerciseIds: string[]` and `days: number | null` parameters
- Also accept `progressionData: ProgressionStatus[]` as a parameter (to avoid duplicate queries -- reuse data from ProgressionDashboard)
- Use `exerciseIds.join(',')` as the useCallback dependency key (Pitfall 1 from research -- prevents infinite re-renders from array reference changes)
- Short-circuit: if exerciseIds.length === 0, set data to [] and isLoading to false, return early
- Use abortRef pattern (useRef(false)) for cleanup on unmount
- In fetchData:
  - Get db via getDuckDB(), handle null
  - Connect, run comparisonStatsSQL(exerciseIds, days), map rows to ComparisonStats[]
  - For progressionStatus field: look up each exercise in the progressionData array by exerciseId, default to 'unknown'
  - Close connection in finally block (Pitfall 6)
- Return { data, isLoading, error, refresh: fetchData }

Key detail: The hook merges SQL query results (PR, volume, frequency) with progressionData prop (status). This avoids re-running the complex 9-week progression SQL and ensures consistency with the Progression Intelligence section (Pitfall 5).
  </action>
  <verify>Run `npx tsc --noEmit 2>&1 | head -30` -- no new errors from useComparisonStats.ts</verify>
  <done>useComparisonStats hook exists, accepts exercise IDs + days + progression data, returns ComparisonStats[] with PR/volume/frequency from DuckDB and progression status from prop data.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no new errors (pre-existing QuickStartCard/StartWorkout errors acceptable)
2. ComparisonStats type is importable: `grep -r "ComparisonStats" src/types/analytics.ts`
3. comparisonStatsSQL is importable: `grep -r "comparisonStatsSQL" src/db/compiled-queries.ts`
4. useComparisonStats is importable: `grep -r "useComparisonStats" src/hooks/useComparisonStats.ts`
</verification>

<success_criteria>
- ComparisonStats interface has all 10 fields (exerciseId, exerciseName, muscleGroup, maxWeight, maxEstimated1rm, totalVolume, totalSets, sessionCount, sessionsPerWeek, progressionStatus)
- comparisonStatsSQL validates IDs, uses single combined query with FACT_SETS_SQL, handles time filtering
- useComparisonStats follows established hook pattern (getDuckDB, connect, query, close, abortRef)
- No duplicate progression SQL query -- status merged from prop data
</success_criteria>

<output>
After completion, create `.planning/phases/21-comparison-analytics/21-01-SUMMARY.md`
</output>
