---
phase: 15-analytics-redesign
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/analytics.ts
  - src/db/compiled-queries.ts
  - src/index.css
autonomous: true

must_haves:
  truths:
    - "VolumeZoneThresholds type with 4 boundaries (mev, mavLow, mavHigh, mrv) exists"
    - "VOLUME_ZONE_DEFAULTS constant maps all 6 muscle groups to research-backed thresholds"
    - "All 5 parameterized SQL query functions accept days parameter and return correct SQL"
    - "OKLCH volume zone color tokens are available in CSS"
  artifacts:
    - path: "src/types/analytics.ts"
      provides: "VolumeZoneThresholds type, TimeRange type, SummaryStats interface, VOLUME_ZONE_DEFAULTS"
      contains: "VolumeZoneThresholds"
    - path: "src/db/compiled-queries.ts"
      provides: "5 parameterized SQL factory functions"
      contains: "exerciseProgressSQL"
    - path: "src/index.css"
      provides: "OKLCH volume zone color tokens"
      contains: "chart-zone-optimal"
  key_links:
    - from: "src/db/compiled-queries.ts"
      to: "src/types/analytics.ts"
      via: "TimeRange type used in day mapping"
      pattern: "days: number \\| null"
---

<objective>
Establish the data foundation for the analytics redesign: new TypeScript types, parameterized SQL query functions, and OKLCH color tokens for the 5-zone volume system.

Purpose: Every subsequent plan depends on these types, SQL functions, and color tokens. This is the foundation layer.
Output: Updated analytics types, 5 parameterized SQL factory functions (replacing 5 of 6 constants), and 7 new OKLCH CSS custom properties.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-analytics-redesign/15-CONTEXT.md
@.planning/phases/15-analytics-redesign/15-RESEARCH.md
@src/types/analytics.ts
@src/db/compiled-queries.ts
@src/index.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add new analytics types and volume zone constants</name>
  <files>src/types/analytics.ts</files>
  <action>
Add the following to `src/types/analytics.ts` (keep all existing types, add new ones at the end):

1. **TimeRange type:**
```typescript
export type TimeRange = '1M' | '3M' | '6M' | '1Y' | 'ALL';

export const TIME_RANGE_DAYS: Record<TimeRange, number | null> = {
  '1M': 30, '3M': 90, '6M': 180, '1Y': 365, 'ALL': null,
};
```

2. **VolumeZoneThresholds type** (replaces old VolumeThresholds for the 5-zone system):
```typescript
export interface VolumeZoneThresholds {
  mev: number;       // Minimum Effective Volume
  mavLow: number;    // MAV range start
  mavHigh: number;   // MAV range end
  mrv: number;       // Maximum Recoverable Volume
}

export const VOLUME_ZONE_DEFAULTS: Record<string, VolumeZoneThresholds> = {
  Chest:     { mev: 10, mavLow: 12, mavHigh: 20, mrv: 22 },
  Back:      { mev: 10, mavLow: 14, mavHigh: 22, mrv: 25 },
  Shoulders: { mev: 8,  mavLow: 16, mavHigh: 22, mrv: 26 },
  Legs:      { mev: 8,  mavLow: 12, mavHigh: 18, mrv: 20 },
  Arms:      { mev: 6,  mavLow: 10, mavHigh: 16, mrv: 20 },
  Core:      { mev: 0,  mavLow: 16, mavHigh: 20, mrv: 25 },
};
```

3. **VolumeZone enum and helper:**
```typescript
export type VolumeZone = 'under' | 'minimum' | 'optimal' | 'high' | 'over';

export function getVolumeZone(sets: number, thresholds: VolumeZoneThresholds): VolumeZone {
  if (sets < thresholds.mev) return 'under';
  if (sets < thresholds.mavLow) return 'minimum';
  if (sets <= thresholds.mavHigh) return 'optimal';
  if (sets <= thresholds.mrv) return 'high';
  return 'over';
}
```

4. **SummaryStats interface:**
```typescript
export interface SummaryStats {
  totalWorkouts: number;
  totalVolumeKg: number;
  totalPrs: number;
  streakWeeks: number;
}
```

5. **VolumeByMuscleGroupAvg interface** (for the new averaged volume query):
```typescript
export interface VolumeByMuscleGroupAvg {
  muscleGroup: string;
  avgWeeklySets: number;
}
```

Do NOT remove existing `VolumeThresholds`, `MuscleGroupThresholds`, or `UseVolumeThresholdsReturn` types yet -- they are still referenced by components that will be updated in later plans. They will become deprecated.
  </action>
  <verify>Run `npx tsc --noEmit` and confirm no type errors in analytics.ts</verify>
  <done>New types exported: TimeRange, TIME_RANGE_DAYS, VolumeZoneThresholds, VOLUME_ZONE_DEFAULTS, VolumeZone, getVolumeZone, SummaryStats, VolumeByMuscleGroupAvg. Existing types remain intact.</done>
</task>

<task type="auto">
  <name>Task 2: Parameterize SQL query functions and add summary stats query</name>
  <files>src/db/compiled-queries.ts</files>
  <action>
Convert 5 of the 6 SQL query constants to factory functions that accept `days: number | null`. Keep the old constants as deprecated aliases to avoid breaking existing code (hooks will be updated in Plan 02).

**For each query, follow this pattern:**
- Create a new function: `export function queryNameSQL(days: number | null): string`
- The function builds a time filter: `days !== null ? \`WHERE CAST(... AS TIMESTAMPTZ) >= CURRENT_DATE - INTERVAL '${days} days'\` : \`WHERE 1=1\``
- Keep the original constant exported but have it call the function with the old default value

**Queries to parameterize (5 of 6):**

1. **`exerciseProgressSQL(days: number | null)`** — replaces `EXERCISE_PROGRESS_SQL` (was 28 days). Time filter is on `fact_sets.logged_at`. Keep `$1` placeholder for exercise_id.

2. **`volumeByMuscleGroupSQL(days: number | null)`** — replaces `VOLUME_BY_MUSCLE_GROUP_SQL` (was 28 days). IMPORTANT: Change the SQL to return `AVG(set_count)` grouped only by `muscle_group` (not by week). The new query computes weekly volume first, then averages across weeks. Return columns: `muscle_group`, `avg_weekly_sets`. See RESEARCH.md Pattern 3 / parameterized volume query for the exact SQL with `weekly_volume` and `avg_volume` CTEs.

3. **`muscleHeatMapSQL(days: number | null)`** — replaces `MUSCLE_HEAT_MAP_SQL` (was 28 days). Time filter on `fs.logged_at`.

4. **`progressionStatusSQL(days: number | null)`** — replaces `PROGRESSION_STATUS_SQL` (was 9 weeks / 4 weeks). Use `max(days, 63)` for the 9-week window and `max(days, 28)` for the 4-week window. When `days` is null (ALL), keep original intervals unchanged.

5. **`exerciseHistorySQL(days: number | null)`** — replaces `EXERCISE_HISTORY_SQL` (was 14 days). Time filter on `f.logged_at`.

**DO NOT parameterize:**
- `WEEKLY_COMPARISON_SQL` — per CONTEXT.md decision, always compares most recent 2 weeks regardless of time range. Keep it as a constant with 14 days.

**Also add new summary stats query function:**

```typescript
export function summaryStatsSQL(days: number | null): string {
  const timeFilter = days !== null
    ? `CAST(COALESCE(payload->>'logged_at', CAST(_created_at AS VARCHAR)) AS TIMESTAMPTZ) >= CURRENT_DATE - INTERVAL '${days} days'`
    : `1=1`;
  const setsTimeFilter = days !== null
    ? `CAST(logged_at AS TIMESTAMPTZ) >= CURRENT_DATE - INTERVAL '${days} days'`
    : `1=1`;

  return `
    WITH fact_sets AS (${FACT_SETS_SQL}),
    workout_events AS (
      SELECT DISTINCT
        payload->>'workout_id' AS workout_id,
        COALESCE(payload->>'logged_at', CAST(_created_at AS VARCHAR)) AS logged_at
      FROM events
      WHERE event_type = 'workout_started'
        AND ${timeFilter}
    )
    SELECT
      (SELECT COUNT(DISTINCT workout_id) FROM workout_events) AS total_workouts,
      (SELECT COALESCE(SUM(weight_kg * reps), 0) FROM fact_sets WHERE ${setsTimeFilter}) AS total_volume_kg,
      (SELECT COUNT(*) FROM fact_sets WHERE is_pr = true AND ${setsTimeFilter}) AS total_prs
  `;
}
```

**Backward compatibility aliases** (keep existing constants working for any un-migrated code):
```typescript
// DEPRECATED: Use function versions. These will be removed after Plan 02 migrates hooks.
export const EXERCISE_PROGRESS_SQL = exerciseProgressSQL(28);
export const VOLUME_BY_MUSCLE_GROUP_SQL = volumeByMuscleGroupSQL(28);
export const MUSCLE_HEAT_MAP_SQL = muscleHeatMapSQL(28);
export const PROGRESSION_STATUS_SQL = progressionStatusSQL(null);
export const EXERCISE_HISTORY_SQL = exerciseHistorySQL(14);
```

Note: Move the constant assignments BELOW the function definitions. The function definitions should come first.
  </action>
  <verify>Run `npx tsc --noEmit` to confirm no type errors. Run `npm run build` to confirm the app still builds (existing hooks use the constant aliases).</verify>
  <done>6 SQL factory functions exported (5 parameterized + 1 new summaryStatsSQL). Old constant names still work as aliases. App builds without errors.</done>
</task>

<task type="auto">
  <name>Task 3: Add OKLCH volume zone and chart tooltip color tokens</name>
  <files>src/index.css</files>
  <action>
Add the following CSS custom properties inside the existing `@theme { }` block in `src/index.css`, after the existing `--color-chart-muted` line and before the legacy HSL section:

```css
  /* Volume zone colors - 5-zone research-backed system (Phase 15) */
  --color-chart-zone-under: oklch(63% 0.22 25);     /* red - not enough stimulus */
  --color-chart-zone-minimum: oklch(75% 0.15 85);    /* yellow - minimum effective */
  --color-chart-zone-optimal: oklch(65% 0.17 145);   /* green - optimal growth */
  --color-chart-zone-high: oklch(70% 0.15 65);       /* orange - approaching limit */
  --color-chart-zone-over: oklch(63% 0.22 25);       /* red - exceeding recovery */

  /* Chart tooltip (replacing hardcoded HSL in chart components) */
  --color-chart-tooltip-bg: oklch(15% 0.01 270);
  --color-chart-tooltip-border: oklch(22% 0.01 270);
```

This adds 7 new tokens. The zone colors intentionally match the existing semantic colors (error=red, warning=yellow, success=green) for consistency.
  </action>
  <verify>Run `npm run build` to confirm CSS is valid and Tailwind processes without errors. Visually confirm by checking the built CSS output contains `chart-zone-optimal`.</verify>
  <done>7 new OKLCH color tokens added to index.css @theme block. Build succeeds.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- `npm run build` succeeds
- `grep -r "VolumeZoneThresholds" src/types/analytics.ts` returns the new type
- `grep -r "exerciseProgressSQL" src/db/compiled-queries.ts` returns the new function
- `grep -r "chart-zone-optimal" src/index.css` returns the new token
- Old constant exports (`EXERCISE_PROGRESS_SQL`, etc.) still exist for backward compatibility
</verification>

<success_criteria>
- VolumeZoneThresholds type with 4 boundaries exists and exports
- VOLUME_ZONE_DEFAULTS maps all 6 muscle groups to research data from CONTEXT.md
- getVolumeZone utility function correctly classifies sets into 5 zones
- 5 SQL query functions accept `days: number | null` parameter
- summaryStatsSQL function generates valid SQL for summary stats
- OKLCH volume zone tokens available in CSS
- Existing code still builds (backward-compatible aliases in place)
</success_criteria>

<output>
After completion, create `.planning/phases/15-analytics-redesign/15-01-SUMMARY.md`
</output>
