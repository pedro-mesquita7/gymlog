---
phase: 15-analytics-redesign
plan: 04
type: execute
wave: 3
depends_on: ["15-01", "15-02"]
files_modified:
  - src/components/analytics/VolumeBarChart.tsx
  - src/components/analytics/MuscleHeatMap.tsx
  - src/components/analytics/ChartContainer.tsx
  - src/components/analytics/ExerciseProgressChart.tsx
autonomous: true

must_haves:
  truths:
    - "Volume bar chart shows one bar per muscle group with per-bar color based on 5-zone thresholds"
    - "Each muscle group bar is colored according to its specific thresholds (not global thresholds)"
    - "Muscle heat map uses 5-zone colors matching the volume zone tokens"
    - "Chart tooltip uses OKLCH tokens instead of hardcoded HSL"
  artifacts:
    - path: "src/components/analytics/VolumeBarChart.tsx"
      provides: "5-zone per-bar colored volume bar chart"
      contains: "Cell"
    - path: "src/components/analytics/MuscleHeatMap.tsx"
      provides: "5-zone colored muscle heat map"
      contains: "getVolumeZone"
    - path: "src/components/analytics/ChartContainer.tsx"
      provides: "minHeight prop support"
      contains: "minHeight"
  key_links:
    - from: "src/components/analytics/VolumeBarChart.tsx"
      to: "src/types/analytics.ts"
      via: "getVolumeZone function + VOLUME_ZONE_DEFAULTS"
      pattern: "getVolumeZone"
    - from: "src/components/analytics/VolumeBarChart.tsx"
      to: "src/index.css"
      via: "OKLCH chart-zone-* tokens"
      pattern: "chart-zone"
---

<objective>
Rewrite VolumeBarChart to use per-bar 5-zone coloring with Recharts Cell component, update MuscleHeatMap to use 5-zone OKLCH colors, update ChartContainer for flexible heights, and migrate chart tooltip colors to OKLCH.

Purpose: These chart components are the core visual elements of the analytics dashboard. The volume bar chart is the centerpiece showing research-backed training zones (ANLT-03).
Output: VolumeBarChart with per-bar zone colors, MuscleHeatMap with 5-zone colors, ChartContainer with minHeight support, chart tooltips using OKLCH tokens.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/15-analytics-redesign/15-CONTEXT.md
@.planning/phases/15-analytics-redesign/15-RESEARCH.md
@src/components/analytics/VolumeBarChart.tsx
@src/components/analytics/MuscleHeatMap.tsx
@src/components/analytics/ChartContainer.tsx
@src/components/analytics/ExerciseProgressChart.tsx
@src/types/analytics.ts
@src/index.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite VolumeBarChart with per-bar 5-zone coloring</name>
  <files>src/components/analytics/VolumeBarChart.tsx</files>
  <action>
Rewrite VolumeBarChart to show a single bar per muscle group (not grouped by week) with per-bar colors based on the muscle group's specific zone thresholds.

**New props interface:**
```typescript
import { Cell, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip } from 'recharts';
import { ChartContainer } from './ChartContainer';
import { getVolumeZone, VOLUME_ZONE_DEFAULTS, type VolumeByMuscleGroupAvg, type VolumeZone } from '../../types/analytics';

interface VolumeBarChartProps {
  data: VolumeByMuscleGroupAvg[];  // avg weekly sets per muscle group
}
```

**Zone color mapping function:**
```typescript
const ZONE_COLORS: Record<VolumeZone, string> = {
  under: 'var(--color-chart-zone-under)',
  minimum: 'var(--color-chart-zone-minimum)',
  optimal: 'var(--color-chart-zone-optimal)',
  high: 'var(--color-chart-zone-high)',
  over: 'var(--color-chart-zone-over)',
};

function getBarColor(muscleGroup: string, avgWeeklySets: number): string {
  const thresholds = VOLUME_ZONE_DEFAULTS[muscleGroup] || VOLUME_ZONE_DEFAULTS['Chest'];
  const zone = getVolumeZone(avgWeeklySets, thresholds);
  return ZONE_COLORS[zone];
}
```

**Chart structure — use Recharts `Cell` for per-bar coloring:**
```typescript
export function VolumeBarChart({ data }: VolumeBarChartProps) {
  if (data.length === 0) {
    return (
      <div className="text-center py-8 text-text-muted">
        No volume data yet. Log workouts to see muscle group training volume.
      </div>
    );
  }

  return (
    <ChartContainer height={350}>
      <BarChart data={data} margin={{ top: 20, right: 20, left: 0, bottom: 5 }}>
        <CartesianGrid strokeDasharray="3 3" stroke="var(--color-chart-muted)" strokeOpacity={0.3} />
        <XAxis
          dataKey="muscleGroup"
          stroke="var(--color-chart-muted)"
          fontSize={12}
          tickLine={false}
        />
        <YAxis
          label={{ value: 'Avg Sets/Week', angle: -90, position: 'insideLeft', style: { fill: 'var(--color-chart-muted)' } }}
          stroke="var(--color-chart-muted)"
          fontSize={12}
          width={55}
          tickLine={false}
          axisLine={false}
        />
        <Tooltip
          contentStyle={{
            backgroundColor: 'var(--color-chart-tooltip-bg)',
            border: '1px solid var(--color-chart-tooltip-border)',
            borderRadius: '8px',
            color: 'var(--color-text-primary)',
          }}
          formatter={(value: number) => [`${value} sets/week`, 'Avg Weekly Volume']}
          cursor={{ fill: 'var(--color-bg-elevated)', fillOpacity: 0.3 }}
        />
        <Bar dataKey="avgWeeklySets" radius={[4, 4, 0, 0]}>
          {data.map((entry, index) => (
            <Cell key={index} fill={getBarColor(entry.muscleGroup, entry.avgWeeklySets)} />
          ))}
        </Bar>
      </BarChart>
    </ChartContainer>
  );
}
```

Key changes from current:
- Remove `ReferenceArea` global zones (replaced by per-bar colors)
- Remove grouped bar chart (one bar per week per muscle) -- now single bar per muscle group showing average
- Remove `Legend` (no longer multiple data series per chart; zone explanation is in VolumeLegend component)
- Use OKLCH tokens for grid lines, axes, tooltips (no more `hsl(var(--chart-muted))`)
- Add `radius={[4, 4, 0, 0]}` for rounded top corners on bars
- Remove the old `transformVolumeData` function (no longer needed)
- Remove the `thresholds` prop -- thresholds come from VOLUME_ZONE_DEFAULTS directly
  </action>
  <verify>Run `npx tsc --noEmit`. Run `npm run build`.</verify>
  <done>VolumeBarChart shows single bar per muscle group with per-bar zone colors via Recharts Cell. Uses OKLCH tokens for all styling. No global ReferenceArea zones.</done>
</task>

<task type="auto">
  <name>Task 2: Update MuscleHeatMap, ChartContainer, and ExerciseProgressChart colors</name>
  <files>src/components/analytics/MuscleHeatMap.tsx, src/components/analytics/ChartContainer.tsx, src/components/analytics/ExerciseProgressChart.tsx</files>
  <action>
**MuscleHeatMap.tsx — Update to 5-zone OKLCH colors:**

1. Replace `getColorForVolume` function with a 5-zone version using OKLCH tokens:
```typescript
import { getVolumeZone, VOLUME_ZONE_DEFAULTS, type VolumeZoneThresholds } from '../../types/analytics';

function getColorForVolume(totalSets: number, thresholds: VolumeZoneThresholds): string {
  if (totalSets === 0) return 'rgba(100, 100, 100, 0.3)'; // No data - neutral gray

  const zone = getVolumeZone(totalSets, thresholds);
  // Use direct OKLCH values for SVG compatibility (CSS variables may not work in SVG fill)
  const colors = {
    under:   'oklch(63% 0.22 25 / 0.7)',    // red
    minimum: 'oklch(75% 0.15 85 / 0.7)',    // yellow
    optimal: 'oklch(65% 0.17 145 / 0.8)',   // green
    high:    'oklch(70% 0.15 65 / 0.7)',    // orange
    over:    'oklch(63% 0.22 25 / 0.8)',    // red
  };
  return colors[zone];
}
```

2. Update the component props — accept `VolumeZoneThresholds` getter instead of old `UseVolumeThresholdsReturn`:
```typescript
interface MuscleHeatMapProps {
  data: MuscleHeatMapData[];
  getThresholds: (muscleGroup: string) => VolumeZoneThresholds;
}
```

3. Update the internal usage to call `getThresholds(muscleData.muscleGroup)` instead of `thresholds.getThreshold(...)`.

4. Update the zone legend at the bottom to show 5 zones (under/minimum/optimal/high/over) with OKLCH colors matching the body diagram. Update the zone label text:
   - Under MEV
   - MEV-MAV (Minimum)
   - MAV Range (Optimal)
   - MAV-MRV (High)
   - Over MRV

5. Update the heading from "Training Volume (Last 28 Days)" to just "Training Volume" (time range is now global, not hardcoded).

**ChartContainer.tsx — Add minHeight support:**

Update the interface and component:
```typescript
interface ChartContainerProps {
  children: ReactElement;
  height?: number;
  minHeight?: number;
}

export function ChartContainer({ children, height = 300, minHeight }: ChartContainerProps) {
  return (
    <div
      style={{ width: '100%', height, minHeight: minHeight || height, minWidth: 0 }}
      className="relative"
    >
      <ResponsiveContainer width="100%" height="100%" minWidth={0}>
        {children}
      </ResponsiveContainer>
    </div>
  );
}
```

This is a small change but important: allows Plan 05 to pass different heights per chart section.

**ExerciseProgressChart.tsx — Migrate tooltip to OKLCH tokens:**

Find the `Tooltip` `contentStyle` in ExerciseProgressChart and update from hardcoded HSL:
```typescript
// FROM:
contentStyle={{
  backgroundColor: 'hsl(240 6% 10%)',
  border: '1px solid hsl(240 4% 16%)',
  borderRadius: '8px',
}}

// TO:
contentStyle={{
  backgroundColor: 'var(--color-chart-tooltip-bg)',
  border: '1px solid var(--color-chart-tooltip-border)',
  borderRadius: '8px',
  color: 'var(--color-text-primary)',
}}
```

Also migrate any `hsl(var(--chart-muted))` references in ExerciseProgressChart to `var(--color-chart-muted)`. Check CartesianGrid stroke, XAxis stroke, YAxis stroke. Replace:
- `hsl(var(--chart-muted) / 0.3)` -> `var(--color-chart-muted)` with `strokeOpacity={0.3}`
- `hsl(var(--chart-muted))` -> `var(--color-chart-muted)`
  </action>
  <verify>Run `npx tsc --noEmit`. Run `npm run build`.</verify>
  <done>MuscleHeatMap uses 5-zone OKLCH colors per muscle group. ChartContainer accepts minHeight prop. ExerciseProgressChart tooltip and axes use OKLCH tokens. No more hardcoded HSL in chart components.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npm run build` succeeds
- `grep -r "hsl(" src/components/analytics/VolumeBarChart.tsx` returns nothing (fully migrated to OKLCH)
- `grep -r "Cell" src/components/analytics/VolumeBarChart.tsx` confirms Cell import and usage
- `grep -r "getVolumeZone" src/components/analytics/MuscleHeatMap.tsx` confirms 5-zone usage
- `grep -r "chart-tooltip" src/components/analytics/ExerciseProgressChart.tsx` confirms OKLCH tooltip
</verification>

<success_criteria>
- VolumeBarChart: single bar per muscle group, per-bar zone colors via Cell, OKLCH tokens for all styling, no ReferenceArea
- MuscleHeatMap: 5-zone color function using getVolumeZone + VOLUME_ZONE_DEFAULTS, updated zone legend
- ChartContainer: supports height and minHeight props
- ExerciseProgressChart: tooltips and axes migrated to OKLCH tokens
- No hardcoded HSL colors remain in any modified chart component
</success_criteria>

<output>
After completion, create `.planning/phases/15-analytics-redesign/15-04-SUMMARY.md`
</output>
