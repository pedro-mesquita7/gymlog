---
phase: 15-analytics-redesign
plan: 05
type: execute
wave: 4
depends_on: ["15-02", "15-03", "15-04"]
files_modified:
  - src/components/analytics/AnalyticsPage.tsx
  - src/components/analytics/ProgressionDashboard.tsx
autonomous: true

must_haves:
  truths:
    - "Analytics page is a single scrollable dashboard with no collapsible sections"
    - "Time range pills at top affect all charts and stats globally"
    - "Selected time range persists in localStorage across sessions"
    - "Dashboard sections appear in order: summary stats, volume overview + legend, heat map, exercise detail, progression"
    - "Exercise selector is scoped to exercise detail section (not at page top)"
  artifacts:
    - path: "src/components/analytics/AnalyticsPage.tsx"
      provides: "Complete scrollable analytics dashboard"
      contains: "TimeRangePicker"
    - path: "src/components/analytics/ProgressionDashboard.tsx"
      provides: "Time-range-aware progression dashboard"
      contains: "days"
  key_links:
    - from: "src/components/analytics/AnalyticsPage.tsx"
      to: "src/hooks/useSummaryStats.ts"
      via: "useSummaryStats(days) hook call"
      pattern: "useSummaryStats"
    - from: "src/components/analytics/AnalyticsPage.tsx"
      to: "src/hooks/useVolumeAnalytics.ts"
      via: "useVolumeAnalytics(days) hook call"
      pattern: "useVolumeAnalytics"
    - from: "src/components/analytics/AnalyticsPage.tsx"
      to: "src/components/analytics/TimeRangePicker.tsx"
      via: "TimeRangePicker component with state"
      pattern: "TimeRangePicker"
    - from: "src/components/analytics/AnalyticsPage.tsx"
      to: "localStorage"
      via: "gymlog-analytics-timerange key"
      pattern: "localStorage"
---

<objective>
Rewrite AnalyticsPage.tsx as a single scrollable dashboard with global time range state, and update ProgressionDashboard to accept time range. This is the final integration plan that assembles all components from Plans 01-04.

Purpose: This plan fulfills ANLT-01 (single scrollable dashboard), ANLT-02 (time range selector affects all charts), and ties together ANLT-03 (volume zones visible in chart) and ANLT-04 (legend below chart). It is the culmination of the phase.
Output: Complete analytics dashboard, ready for visual verification.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/15-analytics-redesign/15-CONTEXT.md
@.planning/phases/15-analytics-redesign/15-RESEARCH.md
@src/components/analytics/AnalyticsPage.tsx
@src/components/analytics/ProgressionDashboard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update ProgressionDashboard to accept days parameter</name>
  <files>src/components/analytics/ProgressionDashboard.tsx</files>
  <action>
Modify ProgressionDashboard to accept a `days` prop and pass it to useProgressionStatus:

1. Add props interface:
```typescript
interface ProgressionDashboardProps {
  days: number | null;
}
```

2. Update component signature:
```typescript
export function ProgressionDashboard({ days }: ProgressionDashboardProps) {
```

3. Pass days to hook:
```typescript
const { data: progressionData, isLoading, error } = useProgressionStatus(days);
```

4. When days is less than 63 (under 9 weeks), show an info note below the summary counts:
```typescript
{days !== null && days < 63 && (
  <p className="text-xs text-text-muted bg-bg-secondary rounded-lg p-3">
    Progression analysis uses at least 9 weeks of data for accurate detection, regardless of the selected time range.
  </p>
)}
```

No other changes to ProgressionDashboard needed -- the existing summary counts, sorting, and status card rendering all stay the same.
  </action>
  <verify>Run `npx tsc --noEmit`.</verify>
  <done>ProgressionDashboard accepts `days` prop, passes to useProgressionStatus, shows info note for short ranges.</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite AnalyticsPage as single scrollable dashboard</name>
  <files>src/components/analytics/AnalyticsPage.tsx</files>
  <action>
Complete rewrite of AnalyticsPage.tsx. Remove all CollapsibleSection wrappers. Add timeRange state with localStorage persistence. Wire all hooks with days parameter. Layout follows CONTEXT.md dashboard wireframe.

**Imports (replace existing):**
```typescript
import { useState, useMemo, useEffect } from 'react';
import { useExercises } from '../../hooks/useExercises';
import { useExerciseProgress, useWeeklyComparison } from '../../hooks/useAnalytics';
import { useVolumeAnalytics } from '../../hooks/useVolumeAnalytics';
import { useVolumeZoneThresholds } from '../../hooks/useVolumeThresholds';
import { useSummaryStats } from '../../hooks/useSummaryStats';
import { TimeRangePicker } from './TimeRangePicker';
import { SummaryStatsCards } from './SummaryStatsCards';
import { SectionHeading } from './SectionHeading';
import { VolumeLegend } from './VolumeLegend';
import { VolumeBarChart } from './VolumeBarChart';
import { MuscleHeatMap } from './MuscleHeatMap';
import { ExerciseProgressChart } from './ExerciseProgressChart';
import { WeekComparisonCard } from './WeekComparisonCard';
import { PRListCard } from './PRListCard';
import { ProgressionDashboard } from './ProgressionDashboard';
import { FeatureErrorBoundary } from '../ui/FeatureErrorBoundary';
import type { TimeRange } from '../../types/analytics';
import { TIME_RANGE_DAYS } from '../../types/analytics';
```

**Time range state with localStorage persistence:**
```typescript
const STORAGE_KEY = 'gymlog-analytics-timerange';

function AnalyticsPage() {
  // Time range state - persisted in localStorage
  const [timeRange, setTimeRange] = useState<TimeRange>(() => {
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored && ['1M', '3M', '6M', '1Y', 'ALL'].includes(stored)) {
        return stored as TimeRange;
      }
    } catch {}
    return '3M'; // default
  });

  useEffect(() => {
    try { localStorage.setItem(STORAGE_KEY, timeRange); } catch {}
  }, [timeRange]);

  const days = TIME_RANGE_DAYS[timeRange];
```

**Hook calls with days parameter:**
```typescript
  const { exercises, isLoading: exercisesLoading } = useExercises();
  const [selectedExerciseId, setSelectedExerciseId] = useState<string>('');

  // Summary stats
  const { data: summaryStats, isLoading: summaryLoading } = useSummaryStats(days);

  // Volume analytics (averaged data for bar chart + heat map)
  const { volumeAvgData, heatMapData, isLoading: volumeLoading, error: volumeError } = useVolumeAnalytics(days);
  const { getThresholds } = useVolumeZoneThresholds();

  // Exercise-specific data
  const { data: progressData, isLoading: progressLoading, error: progressError } = useExerciseProgress({
    exerciseId: selectedExerciseId,
    days,
  });
  const { data: weeklyData, isLoading: weeklyLoading, error: weeklyError } = useWeeklyComparison();

  // Derived data
  const selectedExercise = useMemo(
    () => exercises.find(e => e.exercise_id === selectedExerciseId),
    [exercises, selectedExerciseId]
  );
  const currentWeekComparison = useMemo(() => {
    const filtered = weeklyData.filter(w => w.exerciseId === selectedExerciseId);
    return filtered.length > 0 ? filtered[0] : null;
  }, [weeklyData, selectedExerciseId]);
```

**Auto-select first exercise:**
```typescript
  if (!selectedExerciseId && exercises.length > 0 && !exercisesLoading) {
    setSelectedExerciseId(exercises[0].exercise_id);
  }
```

**Loading and empty states** (keep existing patterns):
```typescript
  if (exercisesLoading) {
    return <div className="text-center py-12 text-text-muted">Loading exercises...</div>;
  }

  if (exercises.length === 0) {
    return (
      <div data-testid="analytics-empty" className="text-center py-12 space-y-4">
        <p className="text-text-muted">No exercises yet.</p>
        <p className="text-sm text-text-muted">Create exercises and log workouts to see analytics.</p>
      </div>
    );
  }
```

**Dashboard layout** (single scrollable page, no CollapsibleSection):
```typescript
  return (
    <div data-testid="analytics-charts" className="space-y-6">
      {/* Time Range Picker - sticky at top */}
      <div className="sticky top-0 z-10 bg-bg-primary py-3 -mx-4 px-4">
        <TimeRangePicker value={timeRange} onChange={setTimeRange} />
      </div>

      {/* SECTION 1: Summary Stats */}
      <FeatureErrorBoundary feature="Summary Stats">
        <SummaryStatsCards stats={summaryStats} isLoading={summaryLoading} />
      </FeatureErrorBoundary>

      {/* SECTION 2: Volume Overview */}
      <SectionHeading title="Volume Overview" subtitle="Average weekly sets per muscle group" />

      {volumeError ? (
        <div className="text-center py-8 text-error">Error: {volumeError}</div>
      ) : volumeLoading ? (
        <div className="text-center py-8 text-text-muted">Loading volume data...</div>
      ) : (
        <div className="space-y-4">
          <FeatureErrorBoundary feature="Volume Chart">
            <div className="bg-bg-tertiary/30 rounded-lg p-4">
              <VolumeBarChart data={volumeAvgData} />
            </div>
          </FeatureErrorBoundary>
          <FeatureErrorBoundary feature="Volume Legend">
            <VolumeLegend />
          </FeatureErrorBoundary>
        </div>
      )}

      {/* SECTION 3: Training Balance Heat Map */}
      <SectionHeading title="Training Balance" />

      {volumeError ? (
        <div className="text-center py-8 text-error">Error: {volumeError}</div>
      ) : volumeLoading ? (
        <div className="text-center py-8 text-text-muted">Loading heat map...</div>
      ) : (
        <FeatureErrorBoundary feature="Muscle Heat Map">
          <div className="bg-bg-tertiary/30 rounded-lg p-4">
            <MuscleHeatMap data={heatMapData} getThresholds={getThresholds} />
          </div>
        </FeatureErrorBoundary>
      )}

      {/* SECTION 4: Exercise Detail */}
      <SectionHeading title="Exercise Detail" subtitle="Select an exercise to view progress" />

      {/* Exercise Selector - scoped to this section */}
      <div>
        <select
          data-testid="analytics-exercise-select"
          id="exercise-select"
          value={selectedExerciseId}
          onChange={(e) => setSelectedExerciseId(e.target.value)}
          className="w-full bg-bg-tertiary border border-border-primary rounded-lg px-4 py-3 text-text-primary focus:outline-none focus:ring-2 focus:ring-accent"
          aria-label="Select exercise"
        >
          {exercises.map((exercise) => (
            <option key={exercise.exercise_id} value={exercise.exercise_id}>
              {exercise.name} ({exercise.muscle_group})
            </option>
          ))}
        </select>
      </div>

      {/* Exercise Progress Chart */}
      {progressError ? (
        <div className="text-center py-8 text-error">Error: {progressError}</div>
      ) : progressLoading ? (
        <div className="text-center py-8 text-text-muted">Loading chart...</div>
      ) : (
        <FeatureErrorBoundary feature="Exercise Progress Chart">
          <div className="bg-bg-tertiary/30 rounded-lg p-4">
            <ExerciseProgressChart
              data={progressData}
              exerciseName={selectedExercise?.name || 'Exercise'}
              showVolume={true}
            />
          </div>
        </FeatureErrorBoundary>
      )}

      {/* Week Comparison */}
      {weeklyError ? (
        <div className="text-center py-8 text-error">Error: {weeklyError}</div>
      ) : weeklyLoading ? (
        <div className="text-center py-8 text-text-muted">Loading comparison...</div>
      ) : currentWeekComparison ? (
        <FeatureErrorBoundary feature="Week Comparison">
          <WeekComparisonCard data={currentWeekComparison} />
        </FeatureErrorBoundary>
      ) : (
        <div className="text-center py-8 text-text-muted">
          No data yet for this week. Log a workout to see comparison.
        </div>
      )}

      {/* PR List */}
      {selectedExercise && (
        <FeatureErrorBoundary feature="Personal Records">
          <PRListCard
            exerciseId={selectedExercise.exercise_id}
            exerciseName={selectedExercise.name}
          />
        </FeatureErrorBoundary>
      )}

      {/* SECTION 5: Progression Intelligence */}
      <SectionHeading title="Progression Intelligence" subtitle="Exercise-level progression detection" />

      <FeatureErrorBoundary feature="Progression Dashboard">
        <ProgressionDashboard days={days} />
      </FeatureErrorBoundary>
    </div>
  );
```

**Key architectural decisions:**
- `CollapsibleSection` import removed entirely (component file kept for potential use elsewhere)
- `VolumeZoneIndicator` import removed (replaced by `VolumeLegend`)
- Time range pills are `sticky top-0 z-10 bg-bg-primary` â€” uses negative margin (`-mx-4 px-4`) to extend to container edges. If this causes visual issues with the mobile nav, the executor should remove `sticky` and keep it static.
- Exercise selector moved DOWN into the Exercise Detail section (per CONTEXT.md decision)
- `data-testid="analytics-charts"` and `data-testid="analytics-exercise-select"` preserved for E2E tests
- `data-testid="analytics-empty"` preserved for empty state tests
- All FeatureErrorBoundary wrappers preserved for graceful error handling

**Remove unused imports:** `CollapsibleSection`, `VolumeZoneIndicator`, old `useVolumeThresholds` (now using `useVolumeZoneThresholds`).
  </action>
  <verify>
Run `npx tsc --noEmit`. Run `npm run build`. Run `npm run dev` and verify:
1. Analytics page loads as single scrollable page
2. Time range pills appear at top
3. Clicking a pill updates charts (check network/console for SQL queries)
4. Summary stats cards show at top
5. Volume bar chart shows per-muscle-group bars with zone colors
6. Volume legend appears below chart with 5 zones and citation
7. Exercise selector is in the exercise detail section (not top)
8. Progression dashboard appears at bottom
  </verify>
  <done>AnalyticsPage is a single scrollable dashboard. TimeRange state in localStorage drives all hooks. Layout: pills -> summary -> volume + legend -> heat map -> exercise detail -> progression. No CollapsibleSection. All ANLT requirements fulfilled.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- `npm run build` succeeds
- `npm run dev` shows analytics as single scrollable page
- Time range pills visible and functional (localStorage persists selection)
- Summary stats render (may show 0s if no data -- that's correct)
- Volume bar chart shows zone colors per bar
- VolumeLegend visible with 5 zones and Schoenfeld citation
- Exercise selector is in exercise detail section
- Progression dashboard at bottom with optional short-range note
- E2E test selectors preserved: `analytics-charts`, `analytics-exercise-select`, `analytics-empty`
- No console errors related to missing imports or type mismatches
</verification>

<success_criteria>
- ANLT-01: Analytics page is single scrollable dashboard (no collapsible sections, no drill-down navigation)
- ANLT-02: Time range pills affect all charts and stats globally (verified by switching range and seeing data change)
- ANLT-03: Volume per muscle group shows color-coded zones based on research ranges (per-bar colors in VolumeBarChart)
- ANLT-04: Volume zone legend explains MEV/MAV/MRV with Schoenfeld citation (VolumeLegend component visible)
- App builds, loads, and functions without errors
- E2E test selectors preserved for regression safety
</success_criteria>

<output>
After completion, create `.planning/phases/15-analytics-redesign/15-05-SUMMARY.md`
</output>
