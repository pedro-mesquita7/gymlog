---
phase: 27-production-polish
plan: 03
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - src/e2e/helpers/selectors.ts
  - src/e2e/notes.spec.ts
  - src/e2e/warmup.spec.ts
  - src/e2e/workout-rotation.spec.ts
  - src/e2e/batch-logging.spec.ts
  - src/e2e/demo-data.spec.ts
autonomous: true

must_haves:
  truths:
    - "All existing E2E tests pass against the updated UI structure"
    - "E2E tests cover the exercise notes feature (add note, see note in next session)"
    - "E2E tests cover the warmup hints feature (warmup hints visible during logging)"
    - "E2E selectors match current data-testid attributes in the UI"
  artifacts:
    - path: "src/e2e/notes.spec.ts"
      provides: "E2E test coverage for exercise notes feature"
      contains: "notes"
    - path: "src/e2e/warmup.spec.ts"
      provides: "E2E test coverage for warmup hints feature"
      contains: "warmup"
    - path: "src/e2e/helpers/selectors.ts"
      provides: "Updated selector constants for all data-testid attributes"
  key_links:
    - from: "src/e2e/notes.spec.ts"
      to: "src/e2e/fixtures/app.fixture.ts"
      via: "import test fixture and helpers"
      pattern: "import.*app\\.fixture"
    - from: "src/e2e/warmup.spec.ts"
      to: "src/e2e/fixtures/app.fixture.ts"
      via: "import test fixture and helpers"
      pattern: "import.*app\\.fixture"
    - from: "src/e2e/helpers/selectors.ts"
      to: "src/components"
      via: "data-testid attributes on DOM elements"
      pattern: "data-testid"
---

<objective>
Fix broken E2E tests and add new coverage for notes and warmup features.

Purpose: E2E tests validate that the app works end-to-end after phases 22-26 restructured settings, analytics, and logging UI. New notes and warmup features need test coverage for CI/CD confidence.
Output: All E2E tests passing, plus new specs for notes and warmup features.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-production-polish/27-RESEARCH.md
@src/e2e/fixtures/app.fixture.ts
@src/e2e/helpers/selectors.ts
@src/e2e/helpers/seed.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix existing E2E tests and update selectors</name>
  <files>
    src/e2e/helpers/selectors.ts
    src/e2e/workout-rotation.spec.ts
    src/e2e/batch-logging.spec.ts
    src/e2e/demo-data.spec.ts
    src/e2e/plan-crud.spec.ts
    src/e2e/parquet-roundtrip.spec.ts
  </files>
  <action>
    1. Run `npm run test:e2e` to identify which existing tests are broken.
    2. For each failure, diagnose the root cause:
       - Stale selectors: UI elements renamed or restructured in phases 22-26
       - Missing data-testid: new UI components that replaced old ones
       - Changed flow: settings restructure (developer mode), analytics simplification
    3. Update `src/e2e/helpers/selectors.ts`:
       - Audit every SEL entry against the current UI components
       - Add new selectors for any elements used by the existing tests that have changed
       - Remove selectors for elements that no longer exist
    4. Fix each broken spec file:
       - Update selectors to match current UI
       - Update flow steps if UI navigation changed (e.g., developer mode toggle needed before accessing debug sections)
       - If settings buttons (Load Demo, Clear Data) are now behind Developer toggle, update the test flow to enable developer mode first
    5. Add `data-testid` attributes to components where missing (only where needed for test fixes).
    6. Re-run `npm run test:e2e` to confirm all existing tests pass.

    IMPORTANT: Do NOT rewrite tests that already pass. Only fix broken ones.
    IMPORTANT: Follow existing patterns from app.fixture.ts (use appPage, loadDemoData, clearAllData).
    IMPORTANT: Settings restructure (phase 24) moved demo data behind developer toggle -- tests that click "Load Demo Data" may need to enable developer mode first.
  </action>
  <verify>
    - `npm run test:e2e` shows all existing specs passing (workout-rotation, batch-logging, demo-data, plan-crud, parquet-roundtrip)
  </verify>
  <done>
    All 5 existing E2E spec files pass. Selectors updated to match current UI. Any needed data-testid attributes added to components.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add E2E tests for notes and warmup features</name>
  <files>
    src/e2e/notes.spec.ts
    src/e2e/warmup.spec.ts
    src/e2e/helpers/selectors.ts
  </files>
  <action>
    1. Add data-testid attributes to notes and warmup components if not already present:
       - NoteInput/NoteSection: `data-testid="exercise-note-input"`, `data-testid="exercise-note-history"`
       - WarmupHint: `data-testid="warmup-hint"`, `data-testid="warmup-tier"`
       - WarmupTierEditor: `data-testid="warmup-tier-editor"`

    2. Add new selectors to `src/e2e/helpers/selectors.ts` for notes and warmup elements.

    3. Create `src/e2e/notes.spec.ts`:
       ```
       Test: "can add a note to an exercise during workout"
       - Load demo data
       - Start a workout (Quick Start or manual)
       - Find the note input for the first exercise
       - Type a note ("Test note from E2E")
       - Finish the workout
       - Start another workout with the same exercise
       - Verify the previous note is visible in note history
       ```

    4. Create `src/e2e/warmup.spec.ts`:
       ```
       Test: "warmup hints display during workout logging"
       - Load demo data (ensures exercises have prior workout history)
       - Start a workout
       - Verify warmup hint elements are visible for exercises
       - Verify warmup hints show calculated weights (not zero, not empty)
       ```

    5. Follow existing test patterns:
       - Import from `./fixtures/app.fixture` (test, expect, loadDemoData)
       - Import SEL from `./helpers/selectors`
       - Use `appPage` fixture
       - Use `loadDemoData(page)` for test data

    6. Run `npm run test:e2e` to verify all tests pass (existing + new).

    IMPORTANT: Tests run against demo/seed data, not custom fixtures.
    IMPORTANT: Notes are stored in Zustand (not DuckDB), so they persist in localStorage.
    IMPORTANT: Warmup hints require prior workout history to calculate weights -- demo data provides this.
    IMPORTANT: Explore the actual component source to find existing data-testid attrs before adding new ones.
  </action>
  <verify>
    - `npm run test:e2e -- notes.spec.ts` passes
    - `npm run test:e2e -- warmup.spec.ts` passes
    - `npm run test:e2e` (all specs) passes
  </verify>
  <done>
    Two new E2E spec files (notes.spec.ts, warmup.spec.ts) exist and pass. They cover: adding a note during workout, seeing note history in next session, and seeing warmup hints with calculated weights during logging. Full E2E suite passes.
  </done>
</task>

</tasks>

<verification>
- `npm run test:e2e` shows all specs passing (7 total: 5 existing + 2 new)
- notes.spec.ts covers add note + view history flow
- warmup.spec.ts covers warmup hints visibility with calculated weights
- No hardcoded selectors in spec files (all use SEL constants)
</verification>

<success_criteria>
All E2E tests pass against the v1.5 UI. Notes and warmup features have test coverage. The CI/CD pipeline will pass E2E checks on the next push.
</success_criteria>

<output>
After completion, create `.planning/phases/27-production-polish/27-03-SUMMARY.md`
</output>
