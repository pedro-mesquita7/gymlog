---
phase: 02-templates-logging
plan: 07
type: execute
wave: 5
depends_on: ["02-06"]
files_modified:
  - src/components/workout/RestTimer.tsx
  - src/components/workout/ExerciseSubstitution.tsx
  - src/components/workout/ExerciseView.tsx
  - src/hooks/useRestTimer.ts
  - src/hooks/useAudioNotification.ts
autonomous: true

must_haves:
  truths:
    - "User can start rest timer after logging a set"
    - "Timer notifies with sound when complete"
    - "User can skip or extend rest timer"
    - "User can substitute exercise from dropdown"
    - "User can revert substitution back to original"
  artifacts:
    - path: "src/components/workout/RestTimer.tsx"
      provides: "Countdown timer with controls"
      min_lines: 50
    - path: "src/components/workout/ExerciseSubstitution.tsx"
      provides: "Exercise substitution dropdown"
      contains: "substituteExercise"
    - path: "src/hooks/useRestTimer.ts"
      provides: "Timer countdown logic"
      exports: ["useRestTimer"]
    - path: "src/hooks/useAudioNotification.ts"
      provides: "Audio playback for timer"
      exports: ["useAudioNotification"]
  key_links:
    - from: "src/components/workout/RestTimer.tsx"
      to: "src/hooks/useRestTimer.ts"
      via: "useRestTimer hook"
      pattern: "useRestTimer"
    - from: "src/components/workout/ExerciseSubstitution.tsx"
      to: "src/stores/useWorkoutStore.ts"
      via: "substituteExercise action"
      pattern: "substituteExercise"
---

<objective>
Implement rest timer with audio notification and exercise substitution dropdown.

Purpose: Enable users to track rest between sets with configurable timer and substitute exercises when equipment is unavailable.

Output: RestTimer component with countdown and sound, ExerciseSubstitution dropdown, timer and audio hooks.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-templates-logging/02-CONTEXT.md
@.planning/phases/02-templates-logging/02-RESEARCH.md
@src/stores/useWorkoutStore.ts
@src/components/workout/ExerciseView.tsx
@src/types/template.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create timer and audio notification hooks</name>
  <files>src/hooks/useRestTimer.ts, src/hooks/useAudioNotification.ts</files>
  <action>
Create `src/hooks/useRestTimer.ts`:

```typescript
import { useState, useEffect, useCallback, useRef } from 'react';

interface UseRestTimerReturn {
  seconds: number;
  isRunning: boolean;
  start: (seconds?: number) => void;
  pause: () => void;
  resume: () => void;
  reset: () => void;
  extend: (additionalSeconds: number) => void;
  skip: () => void;
}

export function useRestTimer(initialSeconds: number = 90): UseRestTimerReturn {
  const [seconds, setSeconds] = useState(initialSeconds);
  const [isRunning, setIsRunning] = useState(false);
  const intervalRef = useRef<number | null>(null);

  // Clear interval on unmount (CRITICAL: prevents memory leak)
  useEffect(() => {
    return () => {
      if (intervalRef.current) {
        clearInterval(intervalRef.current);
      }
    };
  }, []);

  // Timer countdown effect
  useEffect(() => {
    if (!isRunning || seconds <= 0) {
      if (intervalRef.current) {
        clearInterval(intervalRef.current);
        intervalRef.current = null;
      }
      if (seconds <= 0 && isRunning) {
        setIsRunning(false);
      }
      return;
    }

    intervalRef.current = window.setInterval(() => {
      setSeconds(s => {
        if (s <= 1) {
          setIsRunning(false);
          return 0;
        }
        return s - 1;
      });
    }, 1000);

    return () => {
      if (intervalRef.current) {
        clearInterval(intervalRef.current);
        intervalRef.current = null;
      }
    };
  }, [isRunning, seconds]);

  const start = useCallback((newSeconds?: number) => {
    setSeconds(newSeconds ?? initialSeconds);
    setIsRunning(true);
  }, [initialSeconds]);

  const pause = useCallback(() => {
    setIsRunning(false);
  }, []);

  const resume = useCallback(() => {
    if (seconds > 0) {
      setIsRunning(true);
    }
  }, [seconds]);

  const reset = useCallback(() => {
    setSeconds(initialSeconds);
    setIsRunning(false);
  }, [initialSeconds]);

  const extend = useCallback((additionalSeconds: number) => {
    setSeconds(s => s + additionalSeconds);
    if (!isRunning) {
      setIsRunning(true);
    }
  }, [isRunning]);

  const skip = useCallback(() => {
    setSeconds(0);
    setIsRunning(false);
  }, []);

  return { seconds, isRunning, start, pause, resume, reset, extend, skip };
}
```

Create `src/hooks/useAudioNotification.ts`:

```typescript
import { useRef, useEffect, useCallback } from 'react';

export function useAudioNotification() {
  const audioRef = useRef<HTMLAudioElement | null>(null);

  useEffect(() => {
    // Create audio element with a simple beep (base64 encoded)
    // This is a short 440Hz beep tone, ~0.3 seconds
    const beepBase64 = 'data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU' +
      'tvT19/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/';

    audioRef.current = new Audio(beepBase64);
    audioRef.current.volume = 0.5;

    return () => {
      if (audioRef.current) {
        audioRef.current.pause();
        audioRef.current = null;
      }
    };
  }, []);

  const play = useCallback(async () => {
    if (audioRef.current) {
      try {
        audioRef.current.currentTime = 0;
        await audioRef.current.play();
      } catch (err) {
        console.warn('Audio playback failed:', err);
      }
    }
  }, []);

  return { play };
}

export function useVibration() {
  const vibrate = useCallback((pattern: number | number[]) => {
    if ('vibrate' in navigator) {
      try {
        navigator.vibrate(pattern);
      } catch {
        // Vibration not available or failed
      }
    }
  }, []);

  const isSupported = 'vibrate' in navigator;

  return { vibrate, isSupported };
}
```

Key patterns from RESEARCH.md:
- intervalRef for cleanup without memory leaks
- Feature detection for Vibration API (not supported on iOS)
- Base64 audio for built-in notification sound (no external file needed)
- Cleanup in useEffect return
  </action>
  <verify>Hooks import without errors. useRestTimer counts down. useAudioNotification plays sound.</verify>
  <done>Timer and audio hooks provide countdown logic and notification support</done>
</task>

<task type="auto">
  <name>Task 2: Create RestTimer component</name>
  <files>src/components/workout/RestTimer.tsx</files>
  <action>
Create `src/components/workout/RestTimer.tsx`:

```typescript
import { useEffect, useState } from 'react';
import { useRestTimer } from '../../hooks/useRestTimer';
import { useAudioNotification, useVibration } from '../../hooks/useAudioNotification';
import { useWorkoutStore } from '../../stores/useWorkoutStore';

interface RestTimerProps {
  restSeconds?: number | null;  // Override from template exercise
  onComplete?: () => void;
}

export function RestTimer({ restSeconds, onComplete }: RestTimerProps) {
  const defaultRestSeconds = useWorkoutStore(state => state.defaultRestSeconds);
  const [showTimer, setShowTimer] = useState(false);
  const [hasNotified, setHasNotified] = useState(false);

  const targetSeconds = restSeconds ?? defaultRestSeconds;
  const { seconds, isRunning, start, pause, resume, extend, skip } = useRestTimer(targetSeconds);
  const { play } = useAudioNotification();
  const { vibrate } = useVibration();

  // Notify when timer reaches 0
  useEffect(() => {
    if (seconds === 0 && !hasNotified && showTimer) {
      play();
      vibrate([200, 100, 200, 100, 200]);  // Triple vibration pattern
      setHasNotified(true);
      onComplete?.();
    }
  }, [seconds, hasNotified, showTimer, play, vibrate, onComplete]);

  const handleStart = () => {
    setShowTimer(true);
    setHasNotified(false);
    start(targetSeconds);
  };

  const handleExtend = (additionalSeconds: number) => {
    extend(additionalSeconds);
    setHasNotified(false);
  };

  const handleSkip = () => {
    skip();
    setShowTimer(false);
  };

  const handleDismiss = () => {
    setShowTimer(false);
    setHasNotified(false);
  };

  // Format seconds as M:SS
  const formatTime = (s: number) => {
    const mins = Math.floor(s / 60);
    const secs = s % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  // Not started yet - show start button
  if (!showTimer) {
    return (
      <button
        onClick={handleStart}
        className="w-full py-3 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-zinc-400 transition-colors"
      >
        Start Rest ({formatTime(targetSeconds)})
      </button>
    );
  }

  // Timer complete
  if (seconds === 0) {
    return (
      <div className="bg-green-600/20 border border-green-600 rounded-lg p-4 text-center">
        <div className="text-green-400 font-bold mb-2">Rest Complete!</div>
        <button
          onClick={handleDismiss}
          className="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-sm transition-colors"
        >
          Dismiss
        </button>
      </div>
    );
  }

  // Timer running
  return (
    <div className="bg-zinc-800 rounded-lg p-4">
      {/* Timer display */}
      <div className="text-center mb-4">
        <div className="text-4xl font-mono font-bold">{formatTime(seconds)}</div>
        <div className="text-sm text-zinc-500 mt-1">Rest Time</div>
      </div>

      {/* Controls */}
      <div className="flex gap-2">
        {isRunning ? (
          <button
            onClick={pause}
            className="flex-1 py-2 bg-zinc-700 hover:bg-zinc-600 rounded-lg text-sm transition-colors"
          >
            Pause
          </button>
        ) : (
          <button
            onClick={resume}
            className="flex-1 py-2 bg-zinc-700 hover:bg-zinc-600 rounded-lg text-sm transition-colors"
          >
            Resume
          </button>
        )}
        <button
          onClick={() => handleExtend(30)}
          className="flex-1 py-2 bg-zinc-700 hover:bg-zinc-600 rounded-lg text-sm transition-colors"
        >
          +30s
        </button>
        <button
          onClick={() => handleExtend(60)}
          className="flex-1 py-2 bg-zinc-700 hover:bg-zinc-600 rounded-lg text-sm transition-colors"
        >
          +1m
        </button>
        <button
          onClick={handleSkip}
          className="flex-1 py-2 bg-zinc-700 hover:bg-zinc-600 rounded-lg text-sm text-zinc-400 transition-colors"
        >
          Skip
        </button>
      </div>
    </div>
  );
}
```

Design decisions from CONTEXT.md:
- Manual start (not auto-start after set)
- Both vibration + sound on complete
- Skip + extend (+30s, +1min) controls
- Global default rest time from store, overridden by template exercise
  </action>
  <verify>RestTimer shows start button. Starting begins countdown. Sound plays at 0. Extend/skip work.</verify>
  <done>RestTimer provides countdown with sound/vibration notification and controls</done>
</task>

<task type="auto">
  <name>Task 3: Create ExerciseSubstitution and update ExerciseView</name>
  <files>src/components/workout/ExerciseSubstitution.tsx, src/components/workout/ExerciseView.tsx</files>
  <action>
Create `src/components/workout/ExerciseSubstitution.tsx`:

```typescript
import { useState } from 'react';
import { uuidv7 } from 'uuidv7';
import { useWorkoutStore } from '../../stores/useWorkoutStore';
import type { Exercise } from '../../types/database';

interface ExerciseSubstitutionProps {
  originalExerciseId: string;
  originalExerciseName: string;
  replacementExerciseId: string | null;  // Predefined replacement from template
  exercises: Exercise[];  // Full exercise library
  onClose: () => void;
}

export function ExerciseSubstitution({
  originalExerciseId,
  originalExerciseName,
  replacementExerciseId,
  exercises,
  onClose,
}: ExerciseSubstitutionProps) {
  const session = useWorkoutStore(state => state.session);
  const substituteExercise = useWorkoutStore(state => state.substituteExercise);
  const revertSubstitution = useWorkoutStore(state => state.revertSubstitution);
  const addCustomExercise = useWorkoutStore(state => state.addCustomExercise);

  const [showCustom, setShowCustom] = useState(false);
  const [customName, setCustomName] = useState('');

  const currentSubstitution = session?.exerciseSubstitutions[originalExerciseId];
  const replacementExercise = replacementExerciseId
    ? exercises.find(e => e.exercise_id === replacementExerciseId)
    : null;

  const handleSelectReplacement = (exerciseId: string) => {
    substituteExercise(originalExerciseId, exerciseId);
    onClose();
  };

  const handleRevert = () => {
    revertSubstitution(originalExerciseId);
    onClose();
  };

  const handleAddCustom = () => {
    if (!customName.trim()) return;
    const customId = uuidv7();
    addCustomExercise(customId, customName.trim());
    substituteExercise(originalExerciseId, customId);
    onClose();
  };

  return (
    <div className="fixed inset-0 bg-black/50 flex items-end justify-center z-50">
      <div className="bg-zinc-900 rounded-t-2xl w-full max-w-lg max-h-[70vh] overflow-hidden">
        <div className="p-4 border-b border-zinc-800 flex items-center justify-between">
          <h3 className="font-semibold">Substitute Exercise</h3>
          <button
            onClick={onClose}
            className="text-zinc-500 hover:text-zinc-300"
          >
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <div className="p-4 space-y-4 overflow-y-auto max-h-[50vh]">
          {/* Current selection */}
          <div className="text-sm text-zinc-500">
            Original: <span className="text-zinc-300">{originalExerciseName}</span>
            {currentSubstitution && (
              <span className="text-accent ml-2">(substituted)</span>
            )}
          </div>

          {/* Revert option */}
          {currentSubstitution && (
            <button
              onClick={handleRevert}
              className="w-full p-3 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-left transition-colors"
            >
              <div className="font-medium">Revert to Original</div>
              <div className="text-sm text-zinc-500">{originalExerciseName}</div>
            </button>
          )}

          {/* Predefined replacement */}
          {replacementExercise && (
            <div>
              <div className="text-xs text-zinc-500 mb-2">Suggested Replacement</div>
              <button
                onClick={() => handleSelectReplacement(replacementExercise.exercise_id)}
                className="w-full p-3 bg-accent/10 border border-accent/30 hover:bg-accent/20 rounded-lg text-left transition-colors"
              >
                <div className="font-medium">{replacementExercise.name}</div>
                <div className="text-sm text-zinc-500">{replacementExercise.muscle_group}</div>
              </button>
            </div>
          )}

          {/* Other exercises from library */}
          <div>
            <div className="text-xs text-zinc-500 mb-2">From Exercise Library</div>
            <div className="space-y-1 max-h-40 overflow-y-auto">
              {exercises
                .filter(e => e.exercise_id !== originalExerciseId && e.exercise_id !== replacementExerciseId)
                .map(exercise => (
                  <button
                    key={exercise.exercise_id}
                    onClick={() => handleSelectReplacement(exercise.exercise_id)}
                    className="w-full p-2 bg-zinc-800/50 hover:bg-zinc-700 rounded-lg text-left text-sm transition-colors"
                  >
                    <span className="font-medium">{exercise.name}</span>
                    <span className="text-zinc-500 ml-2">{exercise.muscle_group}</span>
                  </button>
                ))}
            </div>
          </div>

          {/* Custom one-off exercise */}
          <div>
            <div className="text-xs text-zinc-500 mb-2">Or add custom (one-time only)</div>
            {showCustom ? (
              <div className="flex gap-2">
                <input
                  type="text"
                  value={customName}
                  onChange={(e) => setCustomName(e.target.value)}
                  placeholder="Exercise name"
                  className="flex-1 bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent"
                  autoFocus
                />
                <button
                  onClick={handleAddCustom}
                  disabled={!customName.trim()}
                  className="px-4 py-2 bg-accent hover:bg-accent/90 text-black text-sm font-medium rounded-lg transition-colors disabled:opacity-50"
                >
                  Add
                </button>
              </div>
            ) : (
              <button
                onClick={() => setShowCustom(true)}
                className="w-full p-2 bg-zinc-800/50 hover:bg-zinc-700 rounded-lg text-sm text-zinc-400 transition-colors"
              >
                + Add custom exercise
              </button>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}
```

Update `src/components/workout/ExerciseView.tsx` to include RestTimer and substitution button:

Add imports:
```typescript
import { useState } from 'react';
import { RestTimer } from './RestTimer';
import { ExerciseSubstitution } from './ExerciseSubstitution';
```

Add state for substitution modal:
```typescript
const [showSubstitution, setShowSubstitution] = useState(false);
```

Add to ExerciseView (after exercise header, make name clickable):
```typescript
{/* Exercise header - clickable for substitution */}
<div className="text-center">
  <div className="text-xs text-zinc-500 mb-1">
    Exercise {exerciseIndex + 1} of {totalExercises}
  </div>
  <button
    onClick={() => setShowSubstitution(true)}
    className="text-2xl font-bold hover:text-accent transition-colors"
  >
    {exerciseName}
    {substitutedId && <span className="text-accent text-sm ml-2">(sub)</span>}
  </button>
  {/* ... rest of header */}
</div>
```

Add RestTimer after SetLogger:
```typescript
{/* Rest timer */}
<RestTimer restSeconds={templateExercise.rest_seconds} />
```

Add ExerciseSubstitution modal at end:
```typescript
{/* Substitution modal */}
{showSubstitution && (
  <ExerciseSubstitution
    originalExerciseId={templateExercise.exercise_id}
    originalExerciseName={exercises.find(e => e.exercise_id === templateExercise.exercise_id)?.name ?? 'Unknown'}
    replacementExerciseId={templateExercise.replacement_exercise_id}
    exercises={exercises}
    onClose={() => setShowSubstitution(false)}
  />
)}
```

Add `exercises` prop to ExerciseViewProps and update ActiveWorkout to pass it.
  </action>
  <verify>RestTimer appears in ExerciseView. Tapping exercise name shows substitution modal. Can substitute and revert.</verify>
  <done>ExerciseSubstitution provides dropdown with replacement, library, and custom options; RestTimer integrated</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Rest timer starts with "Start Rest" button
3. Timer counts down and plays sound at 0
4. Skip and extend buttons work
5. Tapping exercise name opens substitution modal
6. Can select predefined replacement, library exercise, or custom
7. Can revert substitution back to original
</verification>

<success_criteria>
- useRestTimer hook provides countdown with cleanup
- useAudioNotification plays sound on timer complete
- RestTimer shows start button, countdown, and controls
- Sound and vibration fire when timer reaches 0
- ExerciseSubstitution shows inline dropdown when tapping exercise name
- Predefined replacement highlighted
- Can pick from exercise library or add custom one-off
- Revert option available when substituted
- "(sub)" indicator shows on substituted exercises
</success_criteria>

<output>
After completion, create `.planning/phases/02-templates-logging/02-07-SUMMARY.md`
</output>
