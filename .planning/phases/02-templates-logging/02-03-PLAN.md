---
phase: 02-templates-logging
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - src/components/templates/TemplateBuilder.tsx
  - src/components/templates/ExerciseList.tsx
  - src/components/templates/ExerciseRow.tsx
autonomous: true

must_haves:
  truths:
    - "User can add exercises to template via checkbox selection"
    - "User can reorder exercises via drag-and-drop"
    - "User can set target rep range and suggested sets per exercise"
    - "User can specify optional replacement exercise"
  artifacts:
    - path: "src/components/templates/TemplateBuilder.tsx"
      provides: "Template create/edit form"
      min_lines: 100
    - path: "src/components/templates/ExerciseList.tsx"
      provides: "Sortable exercise list"
      contains: "DndContext"
    - path: "src/components/templates/ExerciseRow.tsx"
      provides: "Single exercise configuration"
      contains: "useSortable"
  key_links:
    - from: "src/components/templates/TemplateBuilder.tsx"
      to: "react-hook-form"
      via: "useForm with useFieldArray"
      pattern: "useFieldArray"
    - from: "src/components/templates/TemplateBuilder.tsx"
      to: "src/components/templates/ExerciseList.tsx"
      via: "imports and renders ExerciseList component"
      pattern: "import.*ExerciseList.*from.*ExerciseList"
    - from: "src/components/templates/ExerciseList.tsx"
      to: "@dnd-kit/sortable"
      via: "SortableContext for reordering"
      pattern: "SortableContext"
---

<objective>
Build the TemplateBuilder form component with exercise selection, drag-and-drop reordering, and rep range configuration.

Purpose: Enable users to create and edit workout templates. This is the core template management UI that implements TMPL-01 through TMPL-05.

Output: TemplateBuilder component with React Hook Form + Zod validation, drag-and-drop via dnd-kit, exercise selection via checkbox list.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-templates-logging/02-CONTEXT.md
@.planning/phases/02-templates-logging/02-RESEARCH.md
@src/types/template.ts
@src/types/events.ts
@src/hooks/useTemplates.ts
@src/hooks/useExercises.ts
@src/components/ExerciseForm.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExerciseRow sortable component</name>
  <files>src/components/templates/ExerciseRow.tsx</files>
  <action>
Create `src/components/templates/ExerciseRow.tsx` - a single exercise row in the template builder.

Uses useSortable from @dnd-kit/sortable for drag-and-drop. Shows:
- Drag handle (6-dot icon)
- Exercise name (from exercises list lookup)
- Target reps range (min-max inputs)
- Suggested sets input
- Rest time override (optional)
- Expand button to show replacement picker
- Remove button

```typescript
import { useState } from 'react';
import { useSortable } from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';
import { UseFormRegister, UseFormSetValue, UseFormWatch } from 'react-hook-form';
import type { Exercise } from '../../types/database';
import type { TemplateFormData } from './TemplateBuilder';

interface ExerciseRowProps {
  id: string;           // field.id from useFieldArray
  index: number;
  exercise: Exercise | undefined;  // Looked up from exercises list
  exercises: Exercise[];  // Full list for replacement picker
  register: UseFormRegister<TemplateFormData>;
  setValue: UseFormSetValue<TemplateFormData>;
  watch: UseFormWatch<TemplateFormData>;
  onRemove: () => void;
}

export function ExerciseRow({ id, index, exercise, exercises, register, setValue, watch, onRemove }: ExerciseRowProps) {
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
    isDragging,
  } = useSortable({ id });

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
    opacity: isDragging ? 0.5 : 1,
  };

  const [expanded, setExpanded] = useState(false);
  const currentReplacement = watch(`exercises.${index}.replacement_exercise_id`);

  return (
    <div
      ref={setNodeRef}
      style={style}
      className={`bg-zinc-800/50 rounded-lg p-4 ${isDragging ? 'ring-2 ring-accent' : ''}`}
    >
      <div className="flex items-center gap-3">
        {/* Drag handle */}
        <button
          type="button"
          {...attributes}
          {...listeners}
          className="cursor-grab touch-none text-zinc-500 hover:text-zinc-300"
        >
          <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path d="M7 2a2 2 0 1 0 0 4 2 2 0 0 0 0-4zM7 8a2 2 0 1 0 0 4 2 2 0 0 0 0-4zM7 14a2 2 0 1 0 0 4 2 2 0 0 0 0-4zM13 2a2 2 0 1 0 0 4 2 2 0 0 0 0-4zM13 8a2 2 0 1 0 0 4 2 2 0 0 0 0-4zM13 14a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/>
          </svg>
        </button>

        {/* Exercise name */}
        <div className="flex-1">
          <div className="font-medium">{exercise?.name ?? 'Unknown'}</div>
          <div className="text-xs text-zinc-500">{exercise?.muscle_group}</div>
        </div>

        {/* Rep range */}
        <div className="flex items-center gap-1">
          <input
            type="number"
            {...register(`exercises.${index}.target_reps_min`, { valueAsNumber: true })}
            className="w-12 bg-zinc-700 rounded px-2 py-1 text-center text-sm"
            min={1}
          />
          <span className="text-zinc-500">-</span>
          <input
            type="number"
            {...register(`exercises.${index}.target_reps_max`, { valueAsNumber: true })}
            className="w-12 bg-zinc-700 rounded px-2 py-1 text-center text-sm"
            min={1}
          />
          <span className="text-xs text-zinc-500 ml-1">reps</span>
        </div>

        {/* Sets */}
        <div className="flex items-center gap-1">
          <input
            type="number"
            {...register(`exercises.${index}.suggested_sets`, { valueAsNumber: true })}
            className="w-12 bg-zinc-700 rounded px-2 py-1 text-center text-sm"
            min={1}
          />
          <span className="text-xs text-zinc-500">sets</span>
        </div>

        {/* Expand/Remove buttons */}
        <button
          type="button"
          onClick={() => setExpanded(!expanded)}
          className="text-zinc-500 hover:text-zinc-300 p-1"
          title="Options"
        >
          <svg className={`w-4 h-4 transition-transform ${expanded ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
          </svg>
        </button>

        <button
          type="button"
          onClick={onRemove}
          className="text-zinc-500 hover:text-red-400 p-1"
          title="Remove"
        >
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      {/* Expanded options */}
      {expanded && (
        <div className="mt-4 pt-4 border-t border-zinc-700 space-y-3">
          {/* Rest time override */}
          <div className="flex items-center gap-2">
            <label className="text-sm text-zinc-400 w-24">Rest time:</label>
            <input
              type="number"
              {...register(`exercises.${index}.rest_seconds`, { valueAsNumber: true })}
              placeholder="Default"
              className="w-20 bg-zinc-700 rounded px-2 py-1 text-sm"
              min={0}
            />
            <span className="text-xs text-zinc-500">seconds</span>
          </div>

          {/* Replacement exercise */}
          <div className="flex items-center gap-2">
            <label className="text-sm text-zinc-400 w-24">Replacement:</label>
            <select
              {...register(`exercises.${index}.replacement_exercise_id`)}
              className="flex-1 bg-zinc-700 rounded px-2 py-1 text-sm"
            >
              <option value="">None</option>
              {exercises
                .filter(e => e.exercise_id !== exercise?.exercise_id)
                .map(e => (
                  <option key={e.exercise_id} value={e.exercise_id}>
                    {e.name}
                  </option>
                ))}
            </select>
          </div>
        </div>
      )}

      {/* Hidden field for exercise_id */}
      <input type="hidden" {...register(`exercises.${index}.exercise_id`)} />
      <input type="hidden" {...register(`exercises.${index}.order_index`)} value={index} />
    </div>
  );
}
```

Note: useState import is included at the top. Style with Tailwind for dark theme consistency.
  </action>
  <verify>Component imports without errors. useSortable hook integrates correctly.</verify>
  <done>ExerciseRow renders with drag handle, inputs for reps/sets, expandable options for rest/replacement</done>
</task>

<task type="auto">
  <name>Task 2: Create ExerciseList with dnd-kit SortableContext</name>
  <files>src/components/templates/ExerciseList.tsx</files>
  <action>
Create `src/components/templates/ExerciseList.tsx` - wraps ExerciseRow components in DndContext + SortableContext.

```typescript
import { DndContext, closestCenter, KeyboardSensor, PointerSensor, useSensor, useSensors, DragEndEvent } from '@dnd-kit/core';
import { SortableContext, sortableKeyboardCoordinates, verticalListSortingStrategy } from '@dnd-kit/sortable';
import { UseFieldArrayReturn, UseFormRegister, UseFormSetValue, UseFormWatch } from 'react-hook-form';
import { ExerciseRow } from './ExerciseRow';
import type { Exercise } from '../../types/database';
import type { TemplateFormData } from './TemplateBuilder';

interface ExerciseListProps {
  fieldArray: UseFieldArrayReturn<TemplateFormData, 'exercises'>;
  exercises: Exercise[];  // Full exercise list for lookups
  register: UseFormRegister<TemplateFormData>;
  setValue: UseFormSetValue<TemplateFormData>;
  watch: UseFormWatch<TemplateFormData>;
}

export function ExerciseList({ fieldArray, exercises, register, setValue, watch }: ExerciseListProps) {
  const { fields, move, remove } = fieldArray;

  const sensors = useSensors(
    useSensor(PointerSensor, {
      activationConstraint: { distance: 8 },  // Prevent accidental drags
    }),
    useSensor(KeyboardSensor, {
      coordinateGetter: sortableKeyboardCoordinates,
    })
  );

  const handleDragEnd = (event: DragEndEvent) => {
    const { active, over } = event;

    if (over && active.id !== over.id) {
      const oldIndex = fields.findIndex(f => f.id === active.id);
      const newIndex = fields.findIndex(f => f.id === over.id);
      move(oldIndex, newIndex);
    }
  };

  const getExercise = (exerciseId: string) =>
    exercises.find(e => e.exercise_id === exerciseId);

  if (fields.length === 0) {
    return (
      <div className="text-center py-8 text-zinc-500">
        No exercises added yet. Select exercises below.
      </div>
    );
  }

  return (
    <DndContext
      sensors={sensors}
      collisionDetection={closestCenter}
      onDragEnd={handleDragEnd}
    >
      <SortableContext
        items={fields.map(f => f.id)}
        strategy={verticalListSortingStrategy}
      >
        <div className="space-y-2">
          {fields.map((field, index) => (
            <ExerciseRow
              key={field.id}  // CRITICAL: Use field.id, not index
              id={field.id}
              index={index}
              exercise={getExercise(field.exercise_id)}
              exercises={exercises}
              register={register}
              setValue={setValue}
              watch={watch}
              onRemove={() => remove(index)}
            />
          ))}
        </div>
      </SortableContext>
    </DndContext>
  );
}
```

Key points:
- Use field.id as key (NOT array index) per RESEARCH.md pitfall warning
- PointerSensor with distance constraint prevents accidental drags
- verticalListSortingStrategy for vertical list reordering
- move() from useFieldArray handles state update
  </action>
  <verify>Component imports correctly. DndContext renders without errors.</verify>
  <done>ExerciseList wraps exercises in sortable context with drag-and-drop support</done>
</task>

<task type="auto">
  <name>Task 3: Create TemplateBuilder form component</name>
  <files>src/components/templates/TemplateBuilder.tsx</files>
  <action>
Create `src/components/templates/TemplateBuilder.tsx` - the main form for creating/editing templates.

**CRITICAL: Must import and render ExerciseList component:**
```typescript
import { ExerciseList } from './ExerciseList';
```

And render it:
```typescript
<ExerciseList
  fieldArray={fieldArray}
  exercises={exercises}
  register={register}
  setValue={setValue}
  watch={watch}
/>
```

Full component:

```typescript
import { useForm, useFieldArray } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { useState } from 'react';
import { ExerciseList } from './ExerciseList';
import type { Exercise } from '../../types/database';
import type { Template, TemplateExercise } from '../../types/template';

// Zod schema for validation
const templateExerciseSchema = z.object({
  exercise_id: z.string().min(1),
  order_index: z.number(),
  target_reps_min: z.number().min(1),
  target_reps_max: z.number().min(1),
  suggested_sets: z.number().min(1),
  rest_seconds: z.number().nullable(),
  replacement_exercise_id: z.string().nullable(),
});

const templateSchema = z.object({
  name: z.string().min(1, 'Template name is required'),
  exercises: z.array(templateExerciseSchema).min(1, 'Add at least one exercise'),
}).superRefine((data, ctx) => {
  // Validate each exercise appears only once
  const exerciseIds = data.exercises.map(e => e.exercise_id);
  const duplicates = exerciseIds.filter((id, i) => exerciseIds.indexOf(id) !== i);
  if (duplicates.length > 0) {
    ctx.addIssue({
      code: z.ZodIssueCode.custom,
      message: 'Each exercise can only appear once in template',
      path: ['exercises'],
    });
  }

  // Validate min <= max for each exercise
  data.exercises.forEach((ex, i) => {
    if (ex.target_reps_min > ex.target_reps_max) {
      ctx.addIssue({
        code: z.ZodIssueCode.custom,
        message: 'Min reps must be <= max reps',
        path: ['exercises', i, 'target_reps_max'],
      });
    }
  });
});

export type TemplateFormData = z.infer<typeof templateSchema>;

interface TemplateBuilderProps {
  exercises: Exercise[];  // Available exercises to add
  template?: Template;    // Existing template for edit mode
  onSubmit: (data: TemplateFormData) => Promise<void>;
  onCancel: () => void;
}

export function TemplateBuilder({ exercises, template, onSubmit, onCancel }: TemplateBuilderProps) {
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [showExercisePicker, setShowExercisePicker] = useState(false);

  const defaultExercises: TemplateFormData['exercises'] = template?.exercises.map((e, i) => ({
    exercise_id: e.exercise_id,
    order_index: i,
    target_reps_min: e.target_reps_min,
    target_reps_max: e.target_reps_max,
    suggested_sets: e.suggested_sets,
    rest_seconds: e.rest_seconds,
    replacement_exercise_id: e.replacement_exercise_id,
  })) ?? [];

  const { control, register, handleSubmit, setValue, watch, formState: { errors } } = useForm<TemplateFormData>({
    resolver: zodResolver(templateSchema),
    defaultValues: {
      name: template?.name ?? '',
      exercises: defaultExercises,
    },
  });

  const fieldArray = useFieldArray({
    control,
    name: 'exercises',
  });

  const selectedExerciseIds = new Set(fieldArray.fields.map(f => f.exercise_id));

  const handleAddExercise = (exerciseId: string) => {
    if (selectedExerciseIds.has(exerciseId)) return;

    fieldArray.append({
      exercise_id: exerciseId,
      order_index: fieldArray.fields.length,
      target_reps_min: 8,
      target_reps_max: 12,
      suggested_sets: 3,
      rest_seconds: null,
      replacement_exercise_id: null,
    });
  };

  const handleFormSubmit = async (data: TemplateFormData) => {
    setIsSubmitting(true);
    try {
      // Update order_index based on current position
      const exercises = data.exercises.map((e, i) => ({
        ...e,
        order_index: i,
      }));
      await onSubmit({ ...data, exercises });
    } finally {
      setIsSubmitting(false);
    }
  };

  // Sort exercises alphabetically for picker
  const sortedExercises = [...exercises].sort((a, b) => a.name.localeCompare(b.name));

  return (
    <form onSubmit={handleSubmit(handleFormSubmit)} className="space-y-6">
      {/* Template name */}
      <div>
        <label className="block text-sm font-medium text-zinc-400 mb-2">
          Template Name
        </label>
        <input
          {...register('name')}
          type="text"
          placeholder="e.g., Upper A, Push Day"
          className="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-accent"
        />
        {errors.name && (
          <p className="mt-1 text-sm text-red-400">{errors.name.message}</p>
        )}
      </div>

      {/* Exercise list with drag-drop */}
      <div>
        <div className="flex items-center justify-between mb-4">
          <label className="text-sm font-medium text-zinc-400">
            Exercises ({fieldArray.fields.length})
          </label>
          <button
            type="button"
            onClick={() => setShowExercisePicker(!showExercisePicker)}
            className="text-sm text-accent hover:text-accent/80"
          >
            {showExercisePicker ? 'Hide' : 'Add Exercises'}
          </button>
        </div>

        {errors.exercises && typeof errors.exercises.message === 'string' && (
          <p className="mb-2 text-sm text-red-400">{errors.exercises.message}</p>
        )}

        {/* CRITICAL: ExerciseList component renders here */}
        <ExerciseList
          fieldArray={fieldArray}
          exercises={exercises}
          register={register}
          setValue={setValue}
          watch={watch}
        />
      </div>

      {/* Exercise picker (checkbox list) */}
      {showExercisePicker && (
        <div className="bg-zinc-800/50 rounded-lg p-4 max-h-64 overflow-y-auto">
          <div className="space-y-2">
            {sortedExercises.map(exercise => (
              <label
                key={exercise.exercise_id}
                className="flex items-center gap-3 p-2 rounded hover:bg-zinc-700/50 cursor-pointer"
              >
                <input
                  type="checkbox"
                  checked={selectedExerciseIds.has(exercise.exercise_id)}
                  onChange={(e) => {
                    if (e.target.checked) {
                      handleAddExercise(exercise.exercise_id);
                    } else {
                      const index = fieldArray.fields.findIndex(f => f.exercise_id === exercise.exercise_id);
                      if (index >= 0) fieldArray.remove(index);
                    }
                  }}
                  className="rounded border-zinc-600 text-accent focus:ring-accent"
                />
                <span>{exercise.name}</span>
                <span className="text-xs text-zinc-500">{exercise.muscle_group}</span>
              </label>
            ))}
          </div>
        </div>
      )}

      {/* Form actions */}
      <div className="flex gap-3 pt-4">
        <button
          type="button"
          onClick={onCancel}
          className="flex-1 px-4 py-3 bg-zinc-800 hover:bg-zinc-700 rounded-lg transition-colors"
        >
          Cancel
        </button>
        <button
          type="submit"
          disabled={isSubmitting}
          className="flex-1 px-4 py-3 bg-accent hover:bg-accent/90 text-black font-medium rounded-lg transition-colors disabled:opacity-50"
        >
          {isSubmitting ? 'Saving...' : template ? 'Update Template' : 'Create Template'}
        </button>
      </div>
    </form>
  );
}
```

Key patterns from RESEARCH.md:
- zodResolver with superRefine for cross-field validation
- useFieldArray with field.id as key
- Complete defaultValues for append() to avoid controlled/uncontrolled errors
- Flat checkbox list for exercise selection (per CONTEXT.md decision)
- ExerciseList import and render is VERIFIED at lines 5 and ~93
  </action>
  <verify>
1. Component renders form
2. Zod validation triggers on submit
3. Drag-drop reorders exercises
4. **Verify ExerciseList import**: `grep -n "import.*ExerciseList" src/components/templates/TemplateBuilder.tsx`
5. **Verify ExerciseList render**: `grep -n "<ExerciseList" src/components/templates/TemplateBuilder.tsx`
  </verify>
  <done>TemplateBuilder provides full form with validation, drag-drop ordering, checkbox exercise selection. ExerciseList is imported and rendered.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. TemplateBuilder can be imported and rendered
3. Adding exercises updates field array
4. Drag-drop reorders exercises (visual verification in browser)
5. Form validation shows errors for empty name or exercises
6. **ExerciseList wiring verified**: TemplateBuilder imports ExerciseList and renders `<ExerciseList>` component
</verification>

<success_criteria>
- ExerciseRow renders with drag handle and all inputs
- ExerciseList wraps rows in DndContext + SortableContext
- TemplateBuilder integrates React Hook Form + Zod + useFieldArray
- TemplateBuilder imports and renders ExerciseList component
- Checkbox list allows adding/removing exercises
- Drag-and-drop reorders exercises correctly
- Form validation works (name required, at least one exercise, min <= max reps)
</success_criteria>

<output>
After completion, create `.planning/phases/02-templates-logging/02-03-SUMMARY.md`
</output>
