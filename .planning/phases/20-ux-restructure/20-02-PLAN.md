---
phase: 20-ux-restructure
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - src/components/backup/BackupSettings.tsx
  - src/components/settings/RotationSection.tsx
autonomous: true

must_haves:
  truths:
    - "Settings tab shows Rotations at top, then Default Gym, then TOON Export, then remaining settings collapsed"
    - "Top three settings sections (Rotations, Default Gym, TOON Export) are always visible"
    - "Remaining settings sections (Workout Preferences, Data Backup, Restore, Demo Data, Observability, Data Quality) are collapsed by default"
    - "Collapsed settings sections expand with same smooth animation as Workouts tab"
  artifacts:
    - path: "src/components/backup/BackupSettings.tsx"
      provides: "Reordered settings with collapsible lower sections"
      contains: "CollapsibleSection"
    - path: "src/components/settings/RotationSection.tsx"
      provides: "Rotation section without Default Gym (extracted to BackupSettings)"
  key_links:
    - from: "src/components/backup/BackupSettings.tsx"
      to: "src/components/ui/CollapsibleSection.tsx"
      via: "import and wrap lower settings sections"
      pattern: "CollapsibleSection.*title"
    - from: "src/components/backup/BackupSettings.tsx"
      to: "useRotationStore"
      via: "Default Gym selector reads from rotation store"
      pattern: "useRotationStore.*defaultGymId"
---

<objective>
Reorder the Settings tab: Rotations at top, then standalone Default Gym section, then TOON Export, then wrap all remaining settings sections in CollapsibleSection wrappers (collapsed by default).

Purpose: Put the most frequently accessed settings (rotation management, default gym, export) at the top, and reduce clutter from rarely-used settings like backup, demo data, observability.
Output: Restructured BackupSettings.tsx with reordered sections and collapsible wrappers, RotationSection.tsx with Default Gym extracted.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-ux-restructure/20-CONTEXT.md
@.planning/phases/20-ux-restructure/20-RESEARCH.md
@.planning/phases/20-ux-restructure/20-01-SUMMARY.md
@src/components/backup/BackupSettings.tsx
@src/components/settings/RotationSection.tsx
@src/components/ui/CollapsibleSection.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract Default Gym from RotationSection and reorder Settings tab</name>
  <files>
    src/components/settings/RotationSection.tsx
    src/components/backup/BackupSettings.tsx
  </files>
  <action>
**1. Modify `src/components/settings/RotationSection.tsx`:**

Remove the "Default Gym Selection" block (around lines 119-140 in the current file). This is the `<div className="bg-bg-secondary rounded-2xl p-4">` containing the Default Gym `<select>`. Also remove the `defaultGymId` and `setDefaultGym` store selectors and the `useGyms` import if Default Gym was the only consumer of gyms in this component. Keep everything else (rotation CRUD, Create Rotation button).

Check if `gyms` is used elsewhere in RotationSection besides Default Gym. The rotation editor may use gym data -- verify before removing `useGyms`. If gyms are used elsewhere, keep the import but remove only the Default Gym JSX block.

**2. Modify `src/components/backup/BackupSettings.tsx`:**

Reorder and restructure the entire component. New section order:

**Always visible (top, no CollapsibleSection wrapper):**
1. **Rotations** -- `<RotationSection />` (already first, keep it)
2. **Default Gym** -- NEW standalone section. Add imports for `useRotationStore` (for `defaultGymId`, `setDefaultGym`) and `useGyms` (for gym list). Render a section with heading "Default Gym" and the `<select>` element extracted from RotationSection. Only show if `gyms.length > 0`. Style consistently with existing settings sections.
3. **TOON Export** -- `<ToonExportSection />` (move up from its current position)

**Collapsible sections (below, collapsed by default):**

Import `CollapsibleSection` from `../ui/CollapsibleSection`. Wrap each remaining section:

4. **Workout Preferences** -- wrap in `<CollapsibleSection title="Workout Preferences">`. Move the existing Workout Preferences section (weight unit, rest timer, sound toggle) inside.
5. **Data Backup** -- wrap in `<CollapsibleSection title="Data Backup">`. Contains export button, last backup info.
6. **Restore from Backup** -- wrap in `<CollapsibleSection title="Restore from Backup">`. Contains import button and result feedback.
7. **Demo Data** -- wrap in `<CollapsibleSection title="Demo Data & Reset">`. Contains `<DemoDataSection />`.
8. **Observability** -- wrap in `<CollapsibleSection title="System Observability">`. Contains `<ObservabilitySection />`.
9. **Data Quality** -- wrap in `<CollapsibleSection title="Data Quality">`. Contains `<DataQualitySection />`.

Remove `<hr>` dividers between sections -- the CollapsibleSection cards provide visual separation. Keep a small `<hr>` or spacing between the always-visible top group and the collapsible group.

The Default Gym section JSX (extracted from RotationSection):
```tsx
{gyms.length > 0 && (
  <section>
    <h2 className="text-lg font-semibold mb-4 text-text-primary">Default Gym</h2>
    <div className="bg-bg-secondary rounded-2xl p-4">
      <select
        id="default-gym"
        value={defaultGymId || ''}
        onChange={(e) => setDefaultGym(e.target.value || null)}
        className="w-full bg-bg-tertiary rounded-xl px-3 py-2.5 text-sm text-text-primary"
      >
        <option value="">No default gym</option>
        {gyms.map((gym) => (
          <option key={gym.gym_id} value={gym.gym_id}>
            {gym.name}
          </option>
        ))}
      </select>
    </div>
  </section>
)}
```

Add these store selectors to BackupSettings:
```tsx
const defaultGymId = useRotationStore((state) => state.defaultGymId);
const setDefaultGym = useRotationStore((state) => state.setDefaultGym);
```

And import `useGyms`:
```tsx
const { gyms } = useGyms();
```

Note: `useRotationStore` is already imported via `RotationSection`, but BackupSettings needs its own import since it's reading the store directly now. Check if it's already imported.

Preserve all existing `data-testid` attributes for E2E test compatibility (btn-export-backup, btn-import-backup, file-input-parquet, import-result, event-count).
  </action>
  <verify>
1. `npm run build` completes without errors
2. `npm run lint` passes
3. `npm test` passes (unit tests)
4. Manual dev server check: Settings tab shows Rotations -> Default Gym -> TOON Export at top (always visible), then collapsible sections below for Preferences, Backup, Restore, Demo, Observability, Data Quality
5. Default Gym dropdown still works (selecting a gym persists in rotation store)
6. All collapsible settings sections expand/collapse with smooth animation
  </verify>
  <done>
- Settings tab reordered: Rotations -> Default Gym -> TOON Export at top
- Default Gym extracted from RotationSection into standalone section in BackupSettings
- Remaining 6 settings sections wrapped in CollapsibleSection (collapsed by default)
- All existing functionality preserved (backup, restore, preferences, etc.)
- Build passes, unit tests pass
  </done>
</task>

</tasks>

<verification>
1. `npm run build` -- no TypeScript or build errors
2. `npm test` -- all unit tests pass
3. Settings tab top 3 sections always visible, bottom 6 collapsed
4. Default Gym selector works correctly after extraction
5. Collapsible animations match Workouts tab behavior
</verification>

<success_criteria>
- Settings tab correctly reordered per CONTEXT.md specification
- Default Gym works as standalone section
- Lower settings collapsible with smooth animation
- No regression in backup/restore/preferences functionality
- Build and unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/20-ux-restructure/20-02-SUMMARY.md`
</output>
