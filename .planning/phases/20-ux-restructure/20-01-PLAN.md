---
phase: 20-ux-restructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ui/CollapsibleSection.tsx
  - src/components/ExerciseList.tsx
  - src/components/GymList.tsx
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "Exercises section on Workouts tab is collapsed by default, expandable with a single tap"
    - "Gyms section on Workouts tab is collapsed by default, expandable with a single tap"
    - "Quick Start remains the most prominent element on Workouts tab without scrolling past collapsed sections"
    - "Collapsed sections show item count badge (e.g. Exercises (12))"
    - "Expand/collapse has smooth ~200ms slide animation with rotating chevron"
  artifacts:
    - path: "src/components/ui/CollapsibleSection.tsx"
      provides: "Shared animated collapsible section component"
      exports: ["CollapsibleSection"]
      min_lines: 40
    - path: "src/App.tsx"
      provides: "Workouts tab layout with CollapsibleSection wrappers"
      contains: "CollapsibleSection"
    - path: "src/components/ExerciseList.tsx"
      provides: "Exercise list without internal header when wrapped"
    - path: "src/components/GymList.tsx"
      provides: "Gym list without internal header when wrapped"
  key_links:
    - from: "src/App.tsx"
      to: "src/components/ui/CollapsibleSection.tsx"
      via: "import and render wrapping ExerciseList and GymList"
      pattern: "CollapsibleSection.*title.*Exercises"
    - from: "src/components/ui/CollapsibleSection.tsx"
      to: "framer-motion"
      via: "m.div animate height auto"
      pattern: "animate.*height.*auto"
---

<objective>
Create a shared CollapsibleSection component using framer-motion and restructure the Workouts tab to wrap Exercises and Gyms in collapsible sections (collapsed by default) with Quick Start prominent at top.

Purpose: Reduce visual clutter on Workouts tab -- users see Quick Start immediately without scrolling past exercise/gym lists they rarely interact with during a session.
Output: CollapsibleSection.tsx component + restructured Workouts tab layout in App.tsx with modified ExerciseList/GymList headers.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-ux-restructure/20-CONTEXT.md
@.planning/phases/20-ux-restructure/20-RESEARCH.md
@src/App.tsx
@src/components/ExerciseList.tsx
@src/components/GymList.tsx
@src/components/ui/Card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CollapsibleSection component and restructure Workouts tab</name>
  <files>
    src/components/ui/CollapsibleSection.tsx
    src/components/ExerciseList.tsx
    src/components/GymList.tsx
    src/App.tsx
  </files>
  <action>
**1. Create `src/components/ui/CollapsibleSection.tsx`:**

Build a reusable collapsible section component with these specs:
- Props: `title: string`, `count?: number`, `defaultOpen?: boolean` (defaults false), `action?: ReactNode` (optional slot for "+ Add" button in header), `children: ReactNode`
- Uses `useState(defaultOpen)` for open/closed state (NO persistence -- per CONTEXT.md)
- Multiple sections can be open simultaneously (NOT accordion)
- Tappable header: `<button>` with `aria-expanded={isOpen}`, card-style background using `bg-bg-secondary hover:bg-bg-tertiary rounded-2xl`, full width flex layout
- Left side: title (text-base font-semibold text-text-primary) + count as parenthetical in muted text `(N)` if count provided
- Right side: optional action slot (rendered with `onClick` stopPropagation to prevent toggle) + animated chevron
- Chevron: Unicode right-pointing triangle `&#9654;` (or literal character), animated with `m.span animate={{ rotate: isOpen ? 90 : 0 }}`
- Content: `AnimatePresence initial={false}` wrapping `m.div` with `initial={{ height: 0, opacity: 0 }}`, `animate={{ height: 'auto', opacity: 1 }}`, `exit={{ height: 0, opacity: 0 }}`, transition duration 0.2s easeInOut, `style={{ overflow: 'hidden' }}`
- Inner content wrapped in `<div className="pt-3">` for spacing
- Respect `prefers-reduced-motion`: check `window.matchMedia('(prefers-reduced-motion: reduce)').matches` and set duration to 0 if true
- Import `m` and `AnimatePresence` from `framer-motion` (already available via LazyMotion in App.tsx)

**2. Modify `src/components/ExerciseList.tsx`:**

Add an optional `hideHeader?: boolean` prop to the ExerciseListProps interface. When `hideHeader` is true, skip rendering the entire header `<div>` block (lines ~58-71: the flex container with "Library" / "Exercises" heading and "+ Add" button). The outer `<section>` wrapper should also be removed when `hideHeader` is true (render as a fragment or plain div instead). This allows the CollapsibleSection in App.tsx to provide the header.

**3. Modify `src/components/GymList.tsx`:**

Same pattern as ExerciseList: add `hideHeader?: boolean` prop. When true, skip the header `<div>` block (lines ~52-65: "Locations" / "Your Gyms" heading and "+ Add" button). Remove outer `<section>` wrapper when `hideHeader` is true.

**4. Modify `src/App.tsx` `renderWorkoutsContent()` (no-active-workout branch, around line 134):**

Replace the current flat layout:
```tsx
<div className="space-y-8">
  <StartWorkout ... />
  <GymList ... />
  <ExerciseList ... />
</div>
```

With collapsible layout:
```tsx
<div className="space-y-4">
  {/* Quick Start - always prominent at top */}
  <StartWorkout plans={plans} gyms={gyms} onStarted={...} />

  {/* Collapsible sections */}
  <div className="space-y-3 pt-2">
    <CollapsibleSection
      title="Exercises"
      count={exercises.length}
      action={
        <button
          onClick={() => { /* trigger ExerciseList's showForm state */ }}
          className="text-sm font-medium text-accent hover:text-accent/80 transition-colors"
        >
          + Add
        </button>
      }
    >
      <ExerciseList
        exercises={exercises}
        isLoading={exercisesLoading}
        onCreateExercise={handleCreateExercise}
        onUpdateExercise={handleUpdateExercise}
        onDeleteExercise={handleDeleteExercise}
        hideHeader
      />
    </CollapsibleSection>

    <CollapsibleSection
      title="Gyms"
      count={gyms.length}
      action={
        <button
          onClick={() => { /* trigger GymList's showForm state */ }}
          className="text-sm font-medium text-accent hover:text-accent/80 transition-colors"
        >
          + Add
        </button>
      }
    >
      <GymList
        gyms={gyms}
        isLoading={gymsLoading}
        onCreateGym={handleCreateGym}
        onUpdateGym={handleUpdateGym}
        onDeleteGym={handleDeleteGym}
        hideHeader
      />
    </CollapsibleSection>
  </div>
</div>
```

**Important design decision for the "+ Add" action button in CollapsibleSection header:**

The `action` prop renders in the header. When clicked, it should NOT toggle the section. Use `e.stopPropagation()` on the action wrapper div inside CollapsibleSection to prevent the button click from bubbling to the header's onClick.

**Handling the "+ Add" button opening the form inside the collapsed section:**

When "+ Add" is clicked in the CollapsibleSection header and the section is collapsed, the section should auto-expand AND trigger the form. Two approaches:
- (a) Lift the `showForm` state up to App.tsx and pass it down as props. This is simpler.
- (b) Use a ref/callback pattern.

Use approach (a): Add `showForm`/`setShowForm` state in App.tsx for exercises and gyms. Pass `showForm` and `setShowForm` as optional props to ExerciseList/GymList. When the "+ Add" button in CollapsibleSection header is clicked, set showForm=true AND force the section open. To force open, the CollapsibleSection should accept an optional `isOpen` prop that overrides internal state (controlled mode) OR an `onOpenChange` callback.

Simplest approach: Make CollapsibleSection accept `forceOpen?: boolean` -- when this transitions from false to true, open the section. Use a `useEffect` to watch it. Alternatively, just have the "+ Add" button both (1) call `setShowExerciseForm(true)` on the parent state and (2) directly set the CollapsibleSection open via a ref or by making it controlled.

**Recommended simplest implementation:** Don't put "+ Add" in the CollapsibleSection header at all. Instead, keep "+ Add" inside ExerciseList/GymList but ALSO show it in the CollapsibleSection header as a convenience. When clicked in the header, auto-expand the section. Do this by making CollapsibleSection controllable:
- Accept optional `open` and `onToggle` props for controlled mode
- When `open` prop is provided, use it instead of internal state
- App.tsx manages `exerciseSectionOpen` and `gymSectionOpen` state
- "+ Add" click sets both `sectionOpen=true` and `showForm=true`

Actually, the simplest approach: Put the "+ Add" in the CollapsibleSection `action` slot. When clicked, it should expand the section and trigger the form. To do this cleanly:

1. ExerciseList/GymList get `externalShowForm?: boolean` and `onShowFormChange?: (show: boolean) => void` props
2. App.tsx holds `exerciseFormOpen` / `gymFormOpen` state
3. CollapsibleSection gets `onOpen?: () => void` callback that fires when section opens
4. The "+ Add" button click handler: sets formOpen=true, and the CollapsibleSection's controlled open ensures it expands

This is getting complex. **Use the simplest viable approach:**

- Keep ExerciseList/GymList headers as-is (don't use `hideHeader`)
- Instead, just wrap the ENTIRE ExerciseList/GymList (including their headers) inside CollapsibleSection
- CollapsibleSection title shows "Exercises (12)" / "Gyms (3)" as the collapsed view
- When expanded, the internal headers become visible with their "+ Add" buttons
- This avoids any prop threading or state lifting
- The internal "Library / Exercises" and "Locations / Your Gyms" headers serve as sub-headers within the expanded section

This is the simplest approach and avoids modifying ExerciseList/GymList internals. The CollapsibleSection header is the main interaction point; internal headers add context once expanded.

So the final plan for ExerciseList.tsx and GymList.tsx: **No changes needed.** Just wrap them as-is in CollapsibleSection in App.tsx.

Update App.tsx `renderWorkoutsContent()` no-active-workout branch to:
```tsx
<div className="space-y-4">
  <StartWorkout plans={plans} gyms={gyms} onStarted={...} />

  <div className="space-y-3 pt-2">
    <CollapsibleSection title="Exercises" count={exercises.length}>
      <ExerciseList
        exercises={exercises}
        isLoading={exercisesLoading}
        onCreateExercise={handleCreateExercise}
        onUpdateExercise={handleUpdateExercise}
        onDeleteExercise={handleDeleteExercise}
      />
    </CollapsibleSection>

    <CollapsibleSection title="Gyms" count={gyms.length}>
      <GymList
        gyms={gyms}
        isLoading={gymsLoading}
        onCreateGym={handleCreateGym}
        onUpdateGym={handleUpdateGym}
        onDeleteGym={handleDeleteGym}
      />
    </CollapsibleSection>
  </div>
</div>
```

Add the import for CollapsibleSection at top of App.tsx.

Note: The CollapsibleSection does NOT need an `action` prop for this plan. Keep it simple -- just title, count, defaultOpen, children. The "+ Add" button lives inside the expanded content via ExerciseList/GymList's own headers.

**Overflow concern:** ExerciseForm and GymForm render inline within the sections. When collapsed, `overflow: hidden` on the m.div could clip forms that are currently open when user collapses. This is acceptable -- if user collapses a section, any open form naturally hides. When they re-expand, the form state is preserved (React state persists). If forms extend beyond the section during animation, add `onAnimationComplete` callback to set overflow to 'visible' after expand animation finishes, and set back to 'hidden' before collapse starts.
  </action>
  <verify>
1. `npm run build` completes without errors
2. `npm run lint` passes (or only pre-existing warnings)
3. `npm test` passes (unit tests)
4. Manual dev server check: Workouts tab shows Quick Start at top, Exercises and Gyms sections collapsed with count badges, tapping expands with smooth animation, chevron rotates
  </verify>
  <done>
- CollapsibleSection.tsx exists with framer-motion animation, chevron rotation, count badge, aria-expanded
- Workouts tab: Quick Start prominent at top, Exercises and Gyms collapsed by default
- Expanding a section reveals the full ExerciseList/GymList with their "+ Add" buttons
- Multiple sections can be open simultaneously
- Smooth ~200ms slide animation (0 duration when prefers-reduced-motion)
- Build passes, unit tests pass
  </done>
</task>

</tasks>

<verification>
1. `npm run build` -- no TypeScript or build errors
2. `npm test` -- all unit tests pass
3. Dev server: Workouts tab shows collapsed Exercises and Gyms sections below Quick Start
4. Tapping section header expands with smooth animation
5. Chevron rotates from right-pointing to down-pointing
6. Count badge shows correct number (e.g., "Exercises (5)")
7. Multiple sections can be open at the same time
</verification>

<success_criteria>
- CollapsibleSection component created and functional
- Workouts tab restructured with collapsed Exercises and Gyms
- Quick Start is first/most prominent element (no scrolling needed)
- Animations smooth and respecting reduced-motion preference
- Build and unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/20-ux-restructure/20-01-SUMMARY.md`
</output>
