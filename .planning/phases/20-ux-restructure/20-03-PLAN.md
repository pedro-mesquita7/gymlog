---
phase: 20-ux-restructure
plan: 03
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - src/e2e/helpers/seed.ts
  - src/e2e/workout-rotation.spec.ts
  - src/e2e/plan-crud.spec.ts
  - src/e2e/batch-logging.spec.ts
autonomous: true

must_haves:
  truths:
    - "All E2E tests pass after Workouts tab sections are collapsed by default"
    - "E2E helpers expand collapsible sections before interacting with content inside"
  artifacts:
    - path: "src/e2e/helpers/seed.ts"
      provides: "Updated createGym and createExercise helpers that expand sections first"
      contains: "Exercises"
    - path: "src/e2e/workout-rotation.spec.ts"
      provides: "Updated E2E test that expands sections before clicking + Add"
  key_links:
    - from: "src/e2e/helpers/seed.ts"
      to: "src/components/ui/CollapsibleSection.tsx"
      via: "clicks CollapsibleSection header button to expand before interacting"
      pattern: "button.*has-text|aria-expanded"
---

<objective>
Update all E2E test helpers and specs to expand collapsed Exercises and Gyms sections before interacting with content inside them.

Purpose: Sections are now collapsed by default on the Workouts tab. E2E tests that click "+ Add" or interact with exercise/gym lists must first expand the relevant CollapsibleSection.
Output: Updated seed.ts helpers and all affected spec files with section expansion steps.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-ux-restructure/20-CONTEXT.md
@.planning/phases/20-ux-restructure/20-01-SUMMARY.md
@src/e2e/helpers/seed.ts
@src/e2e/helpers/selectors.ts
@src/e2e/workout-rotation.spec.ts
@src/e2e/plan-crud.spec.ts
@src/e2e/batch-logging.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update E2E seed helpers to expand collapsible sections</name>
  <files>
    src/e2e/helpers/seed.ts
  </files>
  <action>
Update `createGym` and `createExercise` functions in `seed.ts` to expand the relevant collapsible section before clicking "+ Add".

**`createGym`** (currently clicks `'text="+ Add"').first()`):
After navigating to Workouts tab, expand the Gyms CollapsibleSection by clicking its header button. The CollapsibleSection header is a `<button>` with `aria-expanded` attribute containing the text "Gyms". Use:
```typescript
await page.click(SEL.navWorkouts);
// Expand Gyms section (collapsed by default)
const gymsHeader = page.locator('button[aria-expanded]', { hasText: 'Gyms' });
await gymsHeader.click();
// Wait for content to be visible
await page.waitForTimeout(300); // animation duration + buffer
```

Then locate the "+ Add" button WITHIN the Gyms section content. Since the section is now expanded, the GymList's internal "+ Add" button is visible. Use the existing selector approach but be specific about which section:
```typescript
// Find the GymList's "+ Add" button
await page.locator('section').filter({ hasText: 'Your Gyms' }).locator('text="+ Add"').click();
```

Or simpler, since after expanding Gyms section and the gym list has a data-testid button:
```typescript
// The GymList's "+ Add" button is inside the expanded section
await page.locator('text="+ Add"').first().click();
```

Keep the existing form fill and submit logic unchanged.

**`createExercise`** (currently clicks `'text="+ Add"').nth(1)`):
After navigating to Workouts tab, expand the Exercises CollapsibleSection:
```typescript
await page.click(SEL.navWorkouts);
// Expand Exercises section (collapsed by default)
const exercisesHeader = page.locator('button[aria-expanded]', { hasText: 'Exercises' });
await exercisesHeader.click();
await page.waitForTimeout(300);
```

Then find the "+ Add" button within the Exercise section. Since Exercises section is expanded and Gyms may or may not be:
```typescript
// The ExerciseList's "+ Add" button
await page.locator('section').filter({ hasText: 'Library' }).locator('text="+ Add"').click();
```

Or if the Gyms section isn't expanded, the first visible "+ Add" may be in Exercises. Be explicit with section filtering to avoid brittle nth() selectors.

Keep existing form fill and submit logic unchanged.

**Important:** The `waitForTimeout(300)` accounts for the 200ms animation plus buffer. Alternatively, use `waitForSelector` to wait for the content to be visible inside the section.
  </action>
  <verify>
Run `npx playwright test src/e2e/` -- all E2E tests pass. If Playwright is not set up for quick local runs, verify by reading test output from `npm run test:e2e` or equivalent command.
  </verify>
  <done>
- `createGym` expands Gyms section before clicking "+ Add"
- `createExercise` expands Exercises section before clicking "+ Add"
- No more brittle `nth()` selectors -- uses section-specific locators
  </done>
</task>

<task type="auto">
  <name>Task 2: Update E2E spec files that directly interact with collapsed sections</name>
  <files>
    src/e2e/workout-rotation.spec.ts
    src/e2e/plan-crud.spec.ts
    src/e2e/batch-logging.spec.ts
  </files>
  <action>
Audit each E2E spec file for direct interactions with content inside the Exercises or Gyms sections on the Workouts tab. For each interaction, add a step to expand the relevant CollapsibleSection first.

**`workout-rotation.spec.ts`:**
- Lines ~42-43: Creates gym by finding `section` with "Your Gyms" and clicking "+ Add". Now the section is inside a CollapsibleSection. Need to first expand the Gyms section:
  ```typescript
  // Expand Gyms section
  await page.locator('button[aria-expanded]', { hasText: 'Gyms' }).click();
  await page.waitForTimeout(300);
  ```
  Then the existing `gymSection.locator('button:has-text("+ Add")')` should work since the content is now visible.

- Lines ~50-51: Creates exercise by finding `section` with "Library" and clicking "+ Add". Need to expand Exercises section first:
  ```typescript
  // Expand Exercises section
  await page.locator('button[aria-expanded]', { hasText: 'Exercises' }).click();
  await page.waitForTimeout(300);
  ```

- Lines ~58: Creates exercise B -- section may already be expanded from exercise A creation. Check if the section stays open. If `createExercise` closes and re-expands, this should be fine. If the test navigates away and comes back, the section resets to collapsed. Add expansion click if needed.

- Review any other interactions with the Workouts tab that assume visible gym/exercise content.

**`plan-crud.spec.ts`:**
- This test uses `seed.ts` helpers (`createGym`, `createExercise`) which will be updated in Task 1. Verify no direct section interactions remain in the spec itself. If the test directly locates exercise/gym elements on the Workouts tab (outside of seed helpers), add expansion clicks.

**`batch-logging.spec.ts`:**
- This test uses seed helpers and then interacts with the active workout view (which is NOT collapsible -- ActiveWorkout renders when workout is active). Verify that the initial setup (gym/exercise creation) goes through seed helpers. If it has direct interactions with collapsed sections, add expansion clicks.

**General pattern for all specs:**
Before any interaction with content inside a collapsible section:
```typescript
// Helper pattern: expand section if collapsed
const sectionButton = page.locator('button[aria-expanded="false"]', { hasText: 'SectionName' });
if (await sectionButton.count() > 0) {
  await sectionButton.click();
  await page.waitForTimeout(300);
}
```

This conditional pattern is defensive -- it only clicks if the section is collapsed (aria-expanded="false"), so it won't accidentally collapse an already-open section.
  </action>
  <verify>
1. `npx playwright test src/e2e/` -- all 5 E2E spec files pass
2. No timeout errors on selectors that interact with collapsed sections
  </verify>
  <done>
- All E2E specs updated to expand collapsible sections before interacting with content
- workout-rotation.spec.ts: gym and exercise creation steps expand sections first
- plan-crud.spec.ts: verified seed helpers handle expansion
- batch-logging.spec.ts: verified seed helpers handle expansion
- All E2E tests pass
  </done>
</task>

</tasks>

<verification>
1. `npx playwright test` -- all E2E tests pass
2. No flaky timeouts on section content selectors
3. Seed helpers reliably expand sections before form interactions
</verification>

<success_criteria>
- All E2E tests pass with collapsed-by-default sections
- No brittle nth() selectors remain for "+ Add" buttons
- Tests are resilient to section state (check and expand if needed)
</success_criteria>

<output>
After completion, create `.planning/phases/20-ux-restructure/20-03-SUMMARY.md`
</output>
