---
phase: 09-batch-logging-visual-polish
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/components/workout/ExerciseView.tsx
  - src/components/workout/ActiveWorkout.tsx
  - src/components/workout/RestTimer.tsx
  - src/components/workout/WorkoutComplete.tsx
  - src/stores/useWorkoutStore.ts
autonomous: true

must_haves:
  truths:
    - "User sees card-based set grid instead of single-set stepper when logging"
    - "User sees ghost text from last session in each input field"
    - "Sets auto-save to Zustand on blur (no explicit save button per set)"
    - "Rest timer auto-starts after a set row blur and displays as persistent banner"
    - "Completion dialog shows exercise count, set count, and volume summary"
    - "Cancel workout shows confirmation dialog before discarding"
  artifacts:
    - path: "src/components/workout/ExerciseView.tsx"
      provides: "Wires SetGrid into exercise view, replacing old SetLogger + logged sets list"
    - path: "src/components/workout/ActiveWorkout.tsx"
      provides: "Rest timer banner at top, completion/cancel dialogs using Dialog primitive"
    - path: "src/components/workout/WorkoutComplete.tsx"
      provides: "Updated completion flow using Dialog component"
  key_links:
    - from: "src/components/workout/ExerciseView.tsx"
      to: "src/components/workout/SetGrid.tsx"
      via: "renders SetGrid with exercise data and store callbacks"
      pattern: "SetGrid"
    - from: "src/components/workout/ActiveWorkout.tsx"
      to: "src/components/workout/RestTimer.tsx"
      via: "rest timer banner rendered at top of workout"
      pattern: "RestTimer|RestTimerBanner"
    - from: "SetGrid onBlur"
      to: "useWorkoutStore.logSet"
      via: "auto-save callback on field blur"
      pattern: "logSet|onBlur|onSaveSet"
---

<objective>
Wire the batch logging components into the active workout flow. Replace the single-set NumberStepper UI with the card-based SetGrid, integrate rest timer as a persistent banner, and add proper completion/cancel dialogs.

Purpose: This transforms the workout experience from logging one set at a time to seeing all sets in a grid with ghost data, matching the Strong Workout app feel.
Output: Updated ExerciseView, ActiveWorkout, RestTimer, WorkoutComplete, and useWorkoutStore
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-batch-logging-visual-polish/09-CONTEXT.md
@.planning/phases/09-batch-logging-visual-polish/09-RESEARCH.md
@.planning/phases/09-batch-logging-visual-polish/09-01-SUMMARY.md

@src/components/workout/ExerciseView.tsx
@src/components/workout/ActiveWorkout.tsx
@src/components/workout/RestTimer.tsx
@src/components/workout/WorkoutComplete.tsx
@src/components/workout/SetLogger.tsx
@src/stores/useWorkoutStore.ts
@src/types/workout-session.ts
@src/components/ui/Dialog.tsx
@src/components/ui/Button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewire ExerciseView to use SetGrid and update store for batch logging</name>
  <files>
    src/components/workout/ExerciseView.tsx
    src/stores/useWorkoutStore.ts
  </files>
  <action>
**useWorkoutStore updates** (`src/stores/useWorkoutStore.ts`):
- Add `updateSet` action: updates an existing set by set_id with new weight/reps/rir values. If set doesn't exist and data is non-null, creates it (upsert behavior for auto-save).
- Add `removeSetsByExercise` action: removes all sets for a given original_exercise_id at a specific index (for row removal in grid).
- Keep existing `logSet` and `removeSet` for backward compatibility during transition.

**ExerciseView rewrite** (`src/components/workout/ExerciseView.tsx`):
- Replace SetLogger + logged sets list with SetGrid component
- Pass SetGrid: exerciseId, originalExerciseId, templateSetCount (from templateExercise.sets count or a target_sets field -- use template exercise's target_sets if available, otherwise default to 3), gymId (from session.gym_id)
- Pass SetGrid: `sets` from store (filtered by original_exercise_id), `onSaveSet` callback that calls store.logSet or store.updateSet
- onSaveSet callback: On blur from SetRow, persist set data to Zustand store. If row already has a set_id in store, update it. If new row, create new set via logSet.
- Auto-start rest timer: When onBlur fires AND the row has valid weight+reps data, trigger rest timer start. Pass a `onSetComplete` callback to SetGrid that RestTimer listens to.
- Keep exercise header (name, muscle group, exercise count indicator)
- Keep swap exercise and history buttons
- Keep Previous/Next navigation buttons
- Remove the old NumberStepper-based SetLogger import (SetLogger.tsx stays for now but is no longer used here)
- Remove the manually-rendered "Sets logged" list (SetGrid handles display)
- Move RestTimer from inline in ExerciseView to parent ActiveWorkout (next task handles this)
  </action>
  <verify>
- `npx tsc --noEmit` passes
- ExerciseView imports and renders SetGrid (not SetLogger)
  </verify>
  <done>
- ExerciseView renders SetGrid with ghost data and auto-save on blur
- Store has updateSet action for editing existing sets
- Sets persist to Zustand sessionStorage automatically on blur
  </done>
</task>

<task type="auto">
  <name>Task 2: Rest timer banner, completion dialog, and cancel flow</name>
  <files>
    src/components/workout/ActiveWorkout.tsx
    src/components/workout/RestTimer.tsx
    src/components/workout/WorkoutComplete.tsx
  </files>
  <action>
**RestTimer as persistent banner** (`src/components/workout/RestTimer.tsx`):
- Refactor RestTimer to work as a sticky banner at top of workout screen
- Remove the "Start Rest" button approach -- timer auto-starts when triggered externally
- Add a `triggerCount` prop or expose a `start` method via ref/callback. Simplest: accept an `autoStartTrigger` prop (number that increments to trigger start).
- Banner style: `sticky top-0 z-10 bg-accent text-bg-primary px-4 py-3 rounded-b-lg` with timer display and Skip button
- When timer reaches 0: play audio + vibrate (existing hooks), show "Rest Complete!" briefly, then auto-hide after 3 seconds
- When not active: render nothing (null)
- Keep existing pause/resume/extend/skip functionality accessible via the banner

**ActiveWorkout updates** (`src/components/workout/ActiveWorkout.tsx`):
- Move RestTimer to top of workout layout as persistent banner (above exercise header)
- Track rest timer trigger: increment a counter when ExerciseView signals a set was completed (via callback prop)
- Replace the WorkoutComplete component rendering with Dialog-based flow:
  - "Finish Workout" button opens Dialog with workout summary (exercise count, set count, total volume, duration)
  - Dialog has "Go Back" and "Save Workout" buttons
  - On save: call existing event writing logic from WorkoutComplete, then completeWorkout()
- Replace cancel confirmation: Use Dialog primitive instead of DeleteConfirmation
  - "Cancel Workout" opens Dialog warning about data loss with set count
  - Confirm discards via cancelWorkout(), Cancel closes dialog
- Handle partial rows: Before showing completion dialog, check for rows with weight but no reps (or vice versa). If found, show warning in the dialog listing incomplete sets. User can "Go Back" to fix or "Save Anyway" (discards partial rows).
- Empty rows: Silently filter out rows where both weight and reps are null/0 before saving

**WorkoutComplete updates** (`src/components/workout/WorkoutComplete.tsx`):
- Refactor to be rendered inside a Dialog (receives isOpen/onClose from parent)
- Keep the event writing logic (writeEvent for workout_started, set_logged, workout_completed)
- Keep the stats display (total sets, exercises, volume, duration)
- Add partial row warning display if applicable
- Use Button primitives for actions (variant="primary" for save, variant="secondary" for go back)
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `npm run build` succeeds
- Rest timer component renders as banner (sticky top)
- Completion and cancel use Dialog primitive
  </verify>
  <done>
- Rest timer auto-starts after set completion, shows as persistent banner at top
- "Finish Workout" opens summary dialog with save/cancel
- "Cancel Workout" opens confirmation dialog
- Partial rows warned before save, empty rows silently discarded
- All dialogs use native HTML dialog via Dialog primitive
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npm run build` succeeds
- Active workout shows SetGrid (card-based) instead of NumberStepper
- Rest timer appears as banner at top after set blur
- Finish and cancel both use Dialog-based flows
- Sets auto-save to Zustand on blur (check sessionStorage key "gymlog-workout")
</verification>

<success_criteria>
- BLOG-01: User sees all sets in card-based grid with weight/reps/RIR columns
- BLOG-02: Ghost text from last session shows as placeholder in inputs
- BLOG-03: User can edit weight/reps/RIR inline in grid cells
- BLOG-04: User can add/remove set rows
- BLOG-05: Sets auto-save on blur, workout completes via dialog with summary
- Rest timer auto-starts after set completion, persistent banner UI
</success_criteria>

<output>
After completion, create `.planning/phases/09-batch-logging-visual-polish/09-02-SUMMARY.md`
</output>
