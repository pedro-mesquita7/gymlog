---
phase: 09-batch-logging-visual-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useLastSessionData.ts
  - src/components/workout/SetGrid.tsx
  - src/components/workout/SetRow.tsx
  - src/components/ui/Dialog.tsx
autonomous: true

must_haves:
  truths:
    - "SetGrid renders N rows matching template set count"
    - "SetRow shows ghost text from last session as placeholder"
    - "SetRow inputs select all text on focus for quick overwrite"
    - "Dialog component wraps native HTML dialog with showModal/close"
  artifacts:
    - path: "src/hooks/useLastSessionData.ts"
      provides: "Fetches last session sets for an exercise at a gym from DuckDB"
      exports: ["useLastSessionData"]
    - path: "src/components/workout/SetGrid.tsx"
      provides: "Card-based grid of SetRow components with add/remove row capability"
      exports: ["SetGrid"]
    - path: "src/components/workout/SetRow.tsx"
      provides: "Single set entry card with weight/reps/RIR inputs, ghost text, delta indicators"
      exports: ["SetRow"]
    - path: "src/components/ui/Dialog.tsx"
      provides: "Reusable native HTML dialog wrapper with showModal/close lifecycle"
      exports: ["Dialog"]
  key_links:
    - from: "src/hooks/useLastSessionData.ts"
      to: "DuckDB fact_sets + dim_workouts"
      via: "SQL query joining fact_sets and dim_workouts"
      pattern: "fact_sets.*dim_workouts|workout_id"
    - from: "src/components/workout/SetGrid.tsx"
      to: "src/components/workout/SetRow.tsx"
      via: "renders SetRow for each set in grid"
      pattern: "SetRow"
    - from: "src/components/workout/SetRow.tsx"
      to: "ghost data"
      via: "HTML placeholder attribute on inputs"
      pattern: "placeholder=.*ghost"
---

<objective>
Create the foundational components for batch set logging: a hook to fetch last session ghost data from DuckDB, card-based SetGrid/SetRow components with ghost text and delta indicators, and a reusable Dialog primitive using native HTML dialog.

Purpose: These are the building blocks that Plan 02 will wire into the active workout flow. Separating creation from integration keeps each plan focused.
Output: 4 new files - useLastSessionData hook, SetGrid, SetRow, Dialog primitive
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-batch-logging-visual-polish/09-CONTEXT.md
@.planning/phases/09-batch-logging-visual-polish/09-RESEARCH.md

@src/stores/useWorkoutStore.ts
@src/types/workout-session.ts
@src/hooks/useHistory.ts
@src/components/ui/Input.tsx
@src/components/ui/Button.tsx
@src/components/ui/Card.tsx
@src/index.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useLastSessionData hook and Dialog primitive</name>
  <files>
    src/hooks/useLastSessionData.ts
    src/components/ui/Dialog.tsx
  </files>
  <action>
**useLastSessionData hook** (`src/hooks/useLastSessionData.ts`):
- Create a hook that fetches the last session's sets for a given exercise at a given gym from DuckDB
- Signature: `useLastSessionData(exerciseId: string, gymId: string)` returns `{ data: LastSessionSet[] | null, isLoading: boolean }`
- `LastSessionSet` type: `{ set_number: number, weight_kg: number, reps: number, rir: number | null }`
- SQL query: Join fact_sets with dim_workouts to get the most recent workout_id for the exercise+gym combo, then fetch all sets from that workout ordered by logged_at ASC
- Use the existing `getDuckDB()` pattern from other hooks (see useHistory.ts for reference)
- Use string interpolation for SQL parameters (DuckDB-WASM limitation, established pattern)
- Handle loading state and errors gracefully (null data on error, log to console)
- Use type-only imports where applicable (verbatimModuleSyntax requirement)

**Dialog primitive** (`src/components/ui/Dialog.tsx`):
- Create a reusable wrapper around native HTML `<dialog>` element
- Props: `isOpen: boolean`, `onClose: () => void`, `title: string`, `children: ReactNode`
- Use useRef + useEffect to call `dialog.showModal()` when isOpen=true, `dialog.close()` when false
- Style with design tokens: `bg-bg-secondary`, rounded-lg, max-w-md, `backdrop:bg-black/50`
- Handle ESC key via native dialog onClose event (maps to onClose prop)
- Use ComponentPropsWithoutRef pattern for native prop forwarding (consistent with other UI primitives)
- Export named export `Dialog`
  </action>
  <verify>
- `npx tsc --noEmit` passes with no type errors
- Both files export their named exports correctly
  </verify>
  <done>
- useLastSessionData hook exists, accepts exerciseId+gymId, returns typed data
- Dialog primitive wraps native dialog with isOpen/onClose/title props
- Both follow established codebase patterns (design tokens, type-only imports)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SetGrid and SetRow components</name>
  <files>
    src/components/workout/SetGrid.tsx
    src/components/workout/SetRow.tsx
  </files>
  <action>
**SetRow component** (`src/components/workout/SetRow.tsx`):
- Mobile-first card layout for a single set entry (NOT a table row)
- Props: `setNumber: number`, `ghostData: { weight_kg: number, reps: number, rir: number | null } | null`, `previousGhostData: { weight_kg: number, reps: number, rir: number | null } | null` (for delta calc), `onChange: (data: { weight_kg: number | null, reps: number | null, rir: number | null }) => void`, `onBlur: () => void`, `onRemove: () => void`, `initialData?: { weight_kg: number | null, reps: number | null, rir: number | null }`
- Three input fields in a 3-column grid: Weight (kg, step=0.1, 1 decimal), Reps (integer), RIR (0-5 integer)
- Ghost text: Use HTML `placeholder` attribute showing last session values (e.g., placeholder="62.5")
- Delta indicators: If user has entered a value AND ghostData exists, show small arrow (up=text-success, down=text-muted) next to input
- Calculate delta by comparing ghostData with previousGhostData (the session before last) to show trend arrows on ghost values themselves. If no previousGhostData, don't show delta arrows on ghost text.
- Select-all-on-focus: `onFocus={(e) => e.target.select()}` on every input
- Use `<Input>` primitive from `src/components/ui/Input.tsx` for consistent styling
- Labels: "Weight (kg)", "Reps", "RIR" in text-xs text-text-secondary
- Set number badge: small circle or label showing set number
- Remove button: small X icon, text-error on hover
- Use local component state for input values (controlled inputs), call onChange on every keystroke, call onBlur when any field loses focus
- Style with design tokens: bg-bg-secondary for card, rounded-lg, p-4, space-y-3
- Hide number input spinners with CSS: `[appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none`

**SetGrid component** (`src/components/workout/SetGrid.tsx`):
- Props: `exerciseId: string`, `originalExerciseId: string`, `templateSetCount: number`, `gymId: string`, `sets: LoggedSet[]` (from store), `onSaveSet: (data: { weight_kg: number | null, reps: number | null, rir: number | null }, index: number) => void`, `onRemoveRow: (index: number) => void`
- Fetches ghost data using useLastSessionData(originalExerciseId, gymId)
- Initializes grid with `templateSetCount` rows (NOT last session count)
- Maintains local state for row data as array of `{ weight_kg: number | null, reps: number | null, rir: number | null }`
- Pre-fills rows that have matching logged sets from `sets` prop
- First-time exercise hint: if no ghost data and no logged sets, show "First time - no previous data" message above grid
- "Add Set" button at bottom: adds new empty row, uses Button primitive with variant="secondary"
- Loading state while ghost data fetches (show skeleton or "Loading..." text)
- Maps rows to SetRow components with appropriate ghostData per row index
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `npm run build` succeeds without errors
  </verify>
  <done>
- SetRow renders card with 3 input fields, ghost text placeholders, delta indicators, select-all-on-focus
- SetGrid renders N rows based on templateSetCount, fetches ghost data, supports add/remove rows
- Both use design tokens and UI primitives consistently
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes (all new files type-check)
- `npm run build` succeeds (no build errors)
- All 4 new files exist and export their components/hooks
- Components use design tokens (bg-bg-secondary, text-text-primary, etc.) not raw zinc classes
</verification>

<success_criteria>
- useLastSessionData fetches last session data from DuckDB for ghost text display
- SetGrid renders correct number of rows based on template set count
- SetRow shows ghost text via placeholder, supports decimal weight, has delta indicators
- Dialog wraps native HTML dialog with controlled isOpen/onClose
- All components follow Phase 8 design token conventions
</success_criteria>

<output>
After completion, create `.planning/phases/09-batch-logging-visual-polish/09-01-SUMMARY.md`
</output>
