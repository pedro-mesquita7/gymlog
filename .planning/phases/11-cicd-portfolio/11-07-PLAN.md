---
phase: 11-cicd-portfolio
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useDataQuality.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Data quality tests run without SQL errors on demo data"
    - "Custom tests (Weight Positive, Reps Reasonable) query fact_sets via CTE"
    - "Anomaly detection queries is_anomaly flag via CTE"
  artifacts:
    - path: "src/hooks/useDataQuality.ts"
      provides: "Data quality tests with inline CTEs"
      contains: "FACT_SETS_SQL"
  key_links:
    - from: "src/hooks/useDataQuality.ts"
      to: "src/db/compiled-queries.ts"
      via: "import FACT_SETS_SQL"
      pattern: "import.*FACT_SETS_SQL.*compiled-queries"
---

<objective>
Fix data quality tests that error because they query non-existent tables (fact_sets, int_sets__with_anomalies).

Purpose: The custom and anomaly data quality tests reference dbt mart tables that don't exist at runtime. Only the `events` table exists in DuckDB-WASM. The dbt logic is available as `FACT_SETS_SQL` in compiled-queries.ts and must be used as a CTE wrapper.
Output: Data quality tests that execute successfully against demo data.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/11-cicd-portfolio/11-UAT.md
@src/hooks/useDataQuality.ts
@src/db/compiled-queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wrap data quality test SQL with FACT_SETS_SQL CTEs</name>
  <files>src/hooks/useDataQuality.ts</files>
  <action>
1. Add import at top of file:
   ```ts
   import { FACT_SETS_SQL } from '../db/compiled-queries';
   ```

2. Replace the 'Weight Positive' test SQL (lines 36-44) with:
   ```ts
   sql: `
     WITH fact_sets AS (${FACT_SETS_SQL})
     SELECT set_id, exercise_id, weight_kg, logged_at
     FROM fact_sets
     WHERE weight_kg <= 0
   `,
   ```

3. Replace the 'Reps Reasonable' test SQL (lines 50-58) with:
   ```ts
   sql: `
     WITH fact_sets AS (${FACT_SETS_SQL})
     SELECT set_id, exercise_id, reps, logged_at
     FROM fact_sets
     WHERE reps < 1 OR reps > 100
   `,
   ```

4. Replace the 'Anomaly Count' test SQL (lines 87-91) with:
   ```ts
   sql: `
     WITH fact_sets AS (${FACT_SETS_SQL})
     SELECT COUNT(*) as anomaly_count
     FROM fact_sets
     WHERE is_anomaly = true
   `,
   ```

   Note: `FACT_SETS_SQL` already computes `is_anomaly` in its final SELECT (via the `sets_with_anomaly_flag` CTE inside it), so querying `WHERE is_anomaly = true` from the fact_sets CTE works directly. No need for a separate `int_sets__with_anomalies` reference.

5. Leave the schema tests (Events ID Not Null, Events ID Unique) unchanged -- they correctly query the `events` table directly.
  </action>
  <verify>
Run the dev server and open the Data Quality page. Click "Run Checks". All 5 tests should complete without "error" status. Custom tests should show "pass" (demo data has valid weights/reps). Schema tests should show "pass". Anomaly test should show "pass" with a count value.

Alternatively, verify no TypeScript errors: `npx tsc --noEmit 2>&1 | grep -i "useDataQuality"` returns nothing.
  </verify>
  <done>All 5 data quality tests execute without SQL errors. Tests querying fact_sets use FACT_SETS_SQL as CTE. Anomaly detection uses is_anomaly from the same CTE. No references to non-existent tables remain.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes without errors in useDataQuality.ts
- No references to bare `fact_sets` or `int_sets__with_anomalies` table names remain (all wrapped in CTEs)
- Data quality checks run successfully in the UI
</verification>

<success_criteria>
- All 5 data quality tests execute without SQL errors on demo data
- Custom tests correctly use FACT_SETS_SQL as CTE
- Anomaly detection uses is_anomaly from FACT_SETS_SQL
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-cicd-portfolio/11-07-SUMMARY.md`
</output>
