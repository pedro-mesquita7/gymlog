---
phase: 11-cicd-portfolio
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - vite.config.ts
  - index.html
  - public/coi-serviceworker.js
autonomous: true

must_haves:
  truths:
    - "App deploys to GitHub Pages with correct asset paths (no 404s)"
    - "DuckDB-WASM works on GitHub Pages via coi-serviceworker COOP/COEP headers"
    - "Local dev still works unchanged (base path is / locally)"
  artifacts:
    - path: "vite.config.ts"
      provides: "Conditional base path for GitHub Pages"
      contains: "VITE_BASE"
    - path: "public/coi-serviceworker.js"
      provides: "Service worker for SharedArrayBuffer on static hosts"
      min_lines: 10
    - path: "index.html"
      provides: "Service worker script tag before app scripts"
      contains: "coi-serviceworker"
  key_links:
    - from: "vite.config.ts"
      to: ".github/workflows/ci.yml"
      via: "VITE_BASE environment variable"
      pattern: "VITE_BASE"
    - from: "index.html"
      to: "public/coi-serviceworker.js"
      via: "script src tag"
      pattern: "coi-serviceworker"
---

<objective>
Configure Vite for GitHub Pages deployment with correct base path and add coi-serviceworker for SharedArrayBuffer support on static hosting.

Purpose: GitHub Pages serves from a subpath (/<repo-name>/), so Vite must generate correct asset URLs. DuckDB-WASM requires SharedArrayBuffer, which needs COOP/COEP headers that GitHub Pages cannot set natively - coi-serviceworker provides this.
Output: Updated vite.config.ts, index.html with service worker, coi-serviceworker.js in public/
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-cicd-portfolio/11-RESEARCH.md

Key existing files:
- vite.config.ts: current config with server COOP/COEP headers, optimizeDeps exclude duckdb-wasm, build target esnext
- index.html: standard Vite template, title "gymlog-temp"
- package.json: name "gymlog-temp"
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install coi-serviceworker and configure for Vite</name>
  <files>public/coi-serviceworker.js</files>
  <action>
Install coi-serviceworker as a dev dependency:
```bash
npm install --save-dev coi-serviceworker
```

Copy the service worker file to public/ so Vite includes it in dist/ as-is (it must NOT be bundled):
```bash
cp node_modules/coi-serviceworker/coi-serviceworker.js public/coi-serviceworker.js
```

IMPORTANT: The file must be a standalone JS file in public/, NOT imported into the app bundle. Vite copies public/ files to dist/ at build time.
  </action>
  <verify>File exists at public/coi-serviceworker.js and is a valid JS file (not empty).</verify>
  <done>coi-serviceworker.js exists in public/ directory, ready to be served alongside the app.</done>
</task>

<task type="auto">
  <name>Task 2: Update vite.config.ts and index.html for GitHub Pages</name>
  <files>vite.config.ts, index.html</files>
  <action>
**Update vite.config.ts:**
Add conditional `base` configuration. Read from `VITE_BASE` env var, defaulting to '/'. Keep ALL existing config (optimizeDeps, build target, server headers, react plugin).

```typescript
export default defineConfig({
  base: process.env.VITE_BASE || '/',
  plugins: [react()],
  // ... keep all existing config
})
```

The CI workflow (11-01) sets `VITE_BASE=/<repo-name>/` during build. Local dev uses the default '/'.

**Update index.html:**
1. Add coi-serviceworker script tag as the FIRST script in `<head>`, BEFORE any other scripts:
```html
<script src="coi-serviceworker.js"></script>
```

2. Update the title from "gymlog-temp" to "GymLog" for a polished portfolio appearance.

The service worker script tag does NOT use a leading slash because the base path varies between local dev (/) and GitHub Pages (/repo-name/). Vite handles the path resolution.

IMPORTANT: Do NOT move or change the existing `<script type="module" src="/src/main.tsx"></script>` in the body. The coi-serviceworker must load BEFORE the app to register and add headers on first page load.
  </action>
  <verify>
- `grep "VITE_BASE" vite.config.ts` shows the base path configuration
- `grep "coi-serviceworker" index.html` shows the script tag in head
- `npm run build` succeeds (validates Vite config)
- `grep "<title>" index.html` shows "GymLog"
  </verify>
  <done>
Vite uses VITE_BASE env var for base path (default '/' for local dev). index.html loads coi-serviceworker before app. Build succeeds. Title updated to GymLog.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds without errors
- public/coi-serviceworker.js exists and is non-empty
- dist/coi-serviceworker.js exists after build (Vite copied it)
- vite.config.ts has conditional base path
- index.html has coi-serviceworker script tag in head
- Local dev server still works (npm run dev)
</verification>

<success_criteria>
App builds successfully with GitHub Pages-compatible configuration. coi-serviceworker is included in the build output. Local development is unchanged.
</success_criteria>

<output>
After completion, create `.planning/phases/11-cicd-portfolio/11-02-SUMMARY.md`
</output>
