---
phase: 11-cicd-portfolio
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useObservability.ts
  - src/components/settings/ObservabilitySection.tsx
  - src/components/backup/BackupSettings.tsx
autonomous: true

must_haves:
  truths:
    - "User sees storage usage (used/quota/percent) in Settings"
    - "User sees total event count in Settings observability section"
    - "User sees average query performance metric"
    - "Observability section updates when user navigates to Settings"
  artifacts:
    - path: "src/hooks/useObservability.ts"
      provides: "Hook that queries storage API and DuckDB for metrics"
      exports: ["useObservability"]
    - path: "src/components/settings/ObservabilitySection.tsx"
      provides: "Observability dashboard UI in Settings"
      exports: ["ObservabilitySection"]
    - path: "src/components/backup/BackupSettings.tsx"
      provides: "Updated Settings page with observability section"
      contains: "ObservabilitySection"
  key_links:
    - from: "src/hooks/useObservability.ts"
      to: "navigator.storage.estimate"
      via: "Browser Storage API call"
      pattern: "navigator\\.storage\\.estimate"
    - from: "src/hooks/useObservability.ts"
      to: "src/db/duckdb-init.ts"
      via: "DuckDB query for event counts"
      pattern: "getDuckDB|SELECT COUNT"
    - from: "src/components/settings/ObservabilitySection.tsx"
      to: "src/hooks/useObservability.ts"
      via: "Hook import"
      pattern: "useObservability"
    - from: "src/components/backup/BackupSettings.tsx"
      to: "src/components/settings/ObservabilitySection.tsx"
      via: "Component import and render"
      pattern: "ObservabilitySection"
---

<objective>
Add an observability dashboard to the Settings page showing storage usage, query performance metrics, and event counts.

Purpose: Demonstrates system observability skills (monitoring, metrics collection) in a portfolio context. Users also benefit from understanding their data footprint.
Output: useObservability hook + ObservabilitySection component integrated into Settings
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-cicd-portfolio/11-RESEARCH.md
@src/components/backup/BackupSettings.tsx
@src/hooks/useDuckDB.ts

Settings page: BackupSettings.tsx renders RotationSection, Workout Preferences, Backup/Restore, and DemoDataSection.
DuckDB access: getDuckDB() from src/db/duckdb-init.ts returns the database instance.
Design tokens: bg-primary, bg-secondary, bg-tertiary, text-primary, text-muted, border-primary, text-accent.
UI primitives: Card from src/components/ui/Card.tsx.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useObservability hook</name>
  <files>src/hooks/useObservability.ts</files>
  <action>
Create a React hook `useObservability` that collects system metrics.

**Interface:**
```typescript
interface ObservabilityMetrics {
  storageUsageBytes: number;
  storageQuotaBytes: number;
  storageUsagePct: number;
  totalEvents: number;
  eventsByType: { event_type: string; count: number }[];
  queryTimeMs: number; // time taken to run the metrics queries themselves
  isLoading: boolean;
  error: string | null;
}
```

**Implementation:**
1. Use `useState` for metrics, `useEffect` to load on mount.
2. `navigator.storage.estimate()` for storage usage/quota. Handle browsers that don't support it (return 0).
3. Query DuckDB for total event count: `SELECT COUNT(*) as cnt FROM events`
4. Query DuckDB for events by type: `SELECT event_type, COUNT(*) as cnt FROM events GROUP BY event_type ORDER BY cnt DESC`
5. Wrap all DuckDB queries with `performance.now()` timing to measure queryTimeMs.
6. Use `getDuckDB()` from `src/db/duckdb-init.ts` for database access.
7. Return a `refresh` function so the UI can re-fetch metrics on demand.
8. Handle errors gracefully (set error string, don't crash).

**Pattern:** Follow existing hook patterns in the project (e.g., useDuckDB). Use `async function` inside useEffect with cleanup flag to prevent state updates after unmount.

Export: `export function useObservability(): ObservabilityMetrics & { refresh: () => void }`
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/hooks/useObservability.ts` (or full project check)</verify>
  <done>useObservability hook exports metrics interface with storage, events, and query timing data.</done>
</task>

<task type="auto">
  <name>Task 2: Create ObservabilitySection and integrate into Settings</name>
  <files>src/components/settings/ObservabilitySection.tsx, src/components/backup/BackupSettings.tsx</files>
  <action>
**Create ObservabilitySection.tsx:**

A Settings section component that displays observability metrics using the `useObservability` hook.

Layout (use existing Settings section styling - `<section>` with `<h2>` heading pattern matching other sections in BackupSettings.tsx):

```
System Observability
--------------------
Storage Usage:  [progress bar]  X.X MB / Y.Y GB (Z.Z%)
Total Events:   1,234
Events by Type: [compact list showing event_type: count]
Query Time:     12ms

[Refresh Metrics] button
```

Specific UI elements:
1. **Storage bar:** A simple div-based progress bar (bg-tertiary background, bg-accent fill). Show usage in human-readable format (formatBytes helper: bytes -> KB/MB/GB).
2. **Total Events:** Simple number with toLocaleString() formatting.
3. **Events by Type:** A compact grid or list showing each event_type and its count. Use text-muted for labels, text-primary for values.
4. **Query Time:** Show milliseconds with 1 decimal place.
5. **Refresh button:** Calls the hook's refresh function. Use ghost button variant if Button primitive is available, otherwise a simple styled button.
6. **Loading state:** Show "Loading metrics..." text while isLoading is true.
7. **Error state:** Show error message in text-error if error is set.

Use the project's design tokens (bg-secondary for the section card background, text-primary/text-muted for text, border-primary for borders). Match the visual style of existing Settings sections (RotationSection, DemoDataSection).

**Update BackupSettings.tsx:**
Import and render `<ObservabilitySection />` at the BOTTOM of the Settings page, after the DemoDataSection. Add an `<hr>` separator before it (matching the existing pattern between sections).

Do NOT modify any existing sections. Just add the import and render the new section.
  </action>
  <verify>
- `npx tsc --noEmit` passes (no type errors)
- ObservabilitySection.tsx exists and exports the component
- BackupSettings.tsx imports and renders ObservabilitySection
- `npm run build` succeeds
  </verify>
  <done>
Settings page shows observability section with storage usage bar, event counts by type, and query timing. User can refresh metrics on demand. Matches existing Settings visual style.
  </done>
</task>

</tasks>

<verification>
- useObservability hook compiles and exports correct interface
- ObservabilitySection renders in Settings page
- Storage usage displays with progress bar
- Event counts display with type breakdown
- Query time displays in milliseconds
- Refresh button triggers metric re-fetch
- `npm run build` succeeds
</verification>

<success_criteria>
User sees a complete observability dashboard in Settings with storage metrics, event counts, and query performance. The section matches the visual style of existing Settings sections.
</success_criteria>

<output>
After completion, create `.planning/phases/11-cicd-portfolio/11-04-SUMMARY.md`
</output>
