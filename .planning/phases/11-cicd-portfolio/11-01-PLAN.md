---
phase: 11-cicd-portfolio
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/ci.yml
  - dbt/requirements.txt
autonomous: true

must_haves:
  truths:
    - "Push to main triggers CI pipeline with lint, unit test, E2E test, and dbt check jobs"
    - "Developer sees clear failure attribution when any job fails"
    - "PR checks run lint, unit test, E2E, and dbt-check but do NOT deploy"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "CI pipeline configuration"
      contains: "jobs:"
    - path: "dbt/requirements.txt"
      provides: "Python dependency pinning for dbt in CI"
      contains: "dbt-duckdb"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "package.json scripts"
      via: "npm run lint, npm run test, npx playwright test"
      pattern: "npm run (lint|test)|npx playwright"
    - from: ".github/workflows/ci.yml"
      to: "dbt/dbt_project.yml"
      via: "dbt compile --target browser"
      pattern: "dbt compile"
---

<objective>
Create a GitHub Actions CI pipeline that runs lint, unit tests, E2E tests, and dbt compilation checks on every push to main and every PR.

Purpose: Automated quality gates ensure broken code never reaches deployment. Clear job separation means fast failure attribution.
Output: `.github/workflows/ci.yml` with 4 parallel check jobs (lint, test-unit, test-e2e, dbt-check)
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-cicd-portfolio/11-RESEARCH.md

Key existing files:
- package.json: scripts for lint, test, test:e2e
- playwright.config.ts: Chromium-only, SharedArrayBuffer args, CI-aware retries/workers
- vitest.config.ts: happy-dom, v8 coverage
- dbt/profiles.yml: target "browser" with :memory: DuckDB
- dbt/dbt_project.yml: project name "gymlog"
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dbt requirements file</name>
  <files>dbt/requirements.txt</files>
  <action>
Create `dbt/requirements.txt` with pinned dependency:
```
dbt-duckdb>=1.9,<2.0
```

This pins dbt-duckdb (which includes dbt-core as a dependency) to a stable range. Python 3.11 will be used in CI per research recommendation.
  </action>
  <verify>File exists at dbt/requirements.txt with dbt-duckdb dependency listed.</verify>
  <done>dbt/requirements.txt exists with dbt-duckdb pinned.</done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions CI workflow</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Create `.github/workflows/ci.yml` with a multi-job pipeline.

Trigger: on push to main AND on pull_request to main.

Permissions: contents read, pages write, id-token write.

Concurrency: group "pages", cancel-in-progress true.

**4 parallel check jobs (Wave 1 - no dependencies between them):**

**Job: lint**
- runs-on: ubuntu-latest
- steps: checkout@v5, setup-node@v6 (node lts/*, cache npm), npm ci, npm run lint

**Job: test-unit**
- runs-on: ubuntu-latest
- steps: checkout@v5, setup-node@v6 (node lts/*, cache npm), npm ci, npm run test

**Job: test-e2e**
- runs-on: ubuntu-latest
- steps: checkout@v5, setup-node@v6 (node lts/*, cache npm), npm ci, npx playwright install --with-deps chromium, npx playwright test
- Upload playwright-report as artifact (actions/upload-artifact@v4) with retention-days 7, if !cancelled()

**Job: dbt-check**
- runs-on: ubuntu-latest
- steps: checkout@v5, setup-python@v5 (python 3.11), pip install -r dbt/requirements.txt, run `cd dbt && dbt compile --target browser`
- NOTE: Do NOT run `dbt test` in CI - there's no data in :memory: so tests pass vacuously. `dbt compile` validates SQL syntax and DAG integrity, which is what we need.

**Job: build-deploy (Wave 2 - depends on all 4 check jobs)**
- needs: [lint, test-unit, test-e2e, dbt-check]
- if: github.ref == 'refs/heads/main' && github.event_name == 'push'
- runs-on: ubuntu-latest
- environment: name github-pages, url from deployment step
- steps:
  1. checkout@v5
  2. setup-node@v6 (node lts/*, cache npm)
  3. setup-python@v5 (python 3.11)
  4. npm ci
  5. Build: `npm run build` with env VITE_BASE set to `/${{ github.event.repository.name }}/`
  6. pip install -r dbt/requirements.txt
  7. Generate dbt docs: `cd dbt && dbt docs generate --static --target browser`
  8. Copy dbt docs: `cp dbt/target/index.html dist/dbt-docs.html || echo "dbt docs generation skipped"`
  9. Copy coi-serviceworker: `cp public/coi-serviceworker.js dist/` (Plan 11-02 will place this file)
  10. configure-pages@v5
  11. upload-pages-artifact@v4 with path './dist'
  12. deploy-pages@v4 (id: deployment)

Important: The build-deploy job uses VITE_BASE env var. Plan 11-02 will configure vite.config.ts to read this. The coi-serviceworker.js file will also be added by Plan 11-02. This workflow is designed to work with those changes.
  </action>
  <verify>
Validate YAML syntax: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))"` (or `npx yaml-lint .github/workflows/ci.yml` if available).
Verify the file contains: jobs.lint, jobs.test-unit, jobs.test-e2e, jobs.dbt-check, jobs.build-deploy with needs array.
  </verify>
  <done>
CI workflow exists with 4 parallel check jobs and 1 gated deploy job. Push to main triggers all 5 jobs. PRs trigger only the 4 check jobs (build-deploy skipped via if condition). Each job has clear failure isolation.
  </done>
</task>

</tasks>

<verification>
- `.github/workflows/ci.yml` exists with valid YAML
- 5 jobs defined: lint, test-unit, test-e2e, dbt-check, build-deploy
- build-deploy has `needs: [lint, test-unit, test-e2e, dbt-check]`
- build-deploy has `if: github.ref == 'refs/heads/main' && github.event_name == 'push'`
- dbt/requirements.txt exists
</verification>

<success_criteria>
GitHub Actions workflow file is valid YAML with 4 parallel check jobs gating a deploy job. PRs get checks only; pushes to main get checks + deploy.
</success_criteria>

<output>
After completion, create `.planning/phases/11-cicd-portfolio/11-01-SUMMARY.md`
</output>
