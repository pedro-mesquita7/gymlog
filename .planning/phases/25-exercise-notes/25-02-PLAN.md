---
phase: 25-exercise-notes
plan: 02
type: execute
wave: 2
depends_on: ["25-01"]
files_modified:
  - src/components/workout/ExerciseNote.tsx
  - src/hooks/useExerciseNotes.ts
  - src/components/workout/ExerciseView.tsx
  - src/db/demo-data.ts
autonomous: true

must_haves:
  truths:
    - "User sees a note icon below the sets during workout logging"
    - "Tapping the icon reveals a text area with placeholder 'Quick note...'"
    - "Note text auto-saves to store on blur/debounce (no save button)"
    - "Character counter appears when within last 15 chars of ~70 limit"
    - "Previous notes section shows all historical notes with session dates"
    - "Previous notes section shows 'No previous notes' when empty (not hidden)"
    - "Notes are read-only in history -- no editing old notes"
  artifacts:
    - path: "src/components/workout/ExerciseNote.tsx"
      provides: "Note input UI with tap-to-reveal, auto-save, char counter, and history display"
      min_lines: 80
    - path: "src/hooks/useExerciseNotes.ts"
      provides: "Hook to query exercise_note_logged events from DuckDB"
      min_lines: 40
    - path: "src/components/workout/ExerciseView.tsx"
      provides: "Renders ExerciseNote below SetGrid"
      contains: "ExerciseNote"
  key_links:
    - from: "src/components/workout/ExerciseNote.tsx"
      to: "src/stores/useWorkoutStore.ts"
      via: "setNote action for auto-save"
      pattern: "setNote"
    - from: "src/components/workout/ExerciseNote.tsx"
      to: "src/hooks/useExerciseNotes.ts"
      via: "useExerciseNotes hook for history"
      pattern: "useExerciseNotes"
    - from: "src/hooks/useExerciseNotes.ts"
      to: "DuckDB events table"
      via: "SQL CTE query for exercise_note_logged events"
      pattern: "exercise_note_logged"
    - from: "src/components/workout/ExerciseView.tsx"
      to: "src/components/workout/ExerciseNote.tsx"
      via: "renders ExerciseNote component"
      pattern: "<ExerciseNote"
---

<objective>
Build the ExerciseNote UI component with tap-to-reveal input, auto-save, character counter, previous notes history, and integrate into ExerciseView.

Purpose: This is the user-facing feature -- the note input during workout logging and the historical notes display. Depends on Plan 01's data layer (setNote action, ExerciseNoteLoggedEvent type).
Output: Working exercise notes feature: icon -> expand textarea -> type note -> auto-saves -> previous notes visible below.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-exercise-notes/25-RESEARCH.md
@.planning/phases/25-exercise-notes/25-01-SUMMARY.md

@src/components/workout/ExerciseView.tsx
@src/hooks/useLastSessionData.ts
@src/stores/useWorkoutStore.ts
@src/db/demo-data.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useExerciseNotes hook and ExerciseNote component</name>
  <files>src/hooks/useExerciseNotes.ts, src/components/workout/ExerciseNote.tsx</files>
  <action>
**Create `src/hooks/useExerciseNotes.ts`:**

Follow the exact CTE pattern from `useLastSessionData.ts`. This hook queries historical notes for an exercise.

```typescript
// Hook signature
export function useExerciseNotes(exerciseId: string): {
  notes: Array<{ note: string; session_date: string }>;
  isLoading: boolean;
}
```

SQL query (CTE pattern matching useLastSessionData):
```sql
WITH note_events AS (
  SELECT
    payload->>'workout_id' AS workout_id,
    payload->>'original_exercise_id' AS original_exercise_id,
    payload->>'note' AS note,
    _created_at
  FROM events
  WHERE event_type = 'exercise_note_logged'
),
workout_events AS (
  SELECT
    payload->>'workout_id' AS workout_id,
    payload->>'started_at' AS started_at
  FROM events
  WHERE event_type = 'workout_started'
)
SELECT n.note, w.started_at AS session_date
FROM note_events n
JOIN workout_events w ON n.workout_id = w.workout_id
WHERE n.original_exercise_id = '${exerciseId}'
ORDER BY w.started_at DESC
```

Use `useState` + `useEffect` pattern matching `useLastSessionData`. Get DuckDB via `getDuckDB()` from `../db/duckdb-init`. Handle null db, empty results, and errors gracefully. Close connection in finally block.

**Create `src/components/workout/ExerciseNote.tsx`:**

Props:
```typescript
interface ExerciseNoteProps {
  originalExerciseId: string;
  currentNote: string;        // From session.notes[originalExerciseId]
  onNoteChange: (note: string) => void;  // Calls setNote
}
```

Component structure:
1. **Tap-to-reveal toggle**: Icon-only button (pencil/edit SVG). Use filled icon when `currentNote` has content, outline when empty. Small, positioned below the sets area.

2. **Expanded state** (when toggled open):
   - Textarea: 2 rows, full width, `resize-none`, placeholder "Quick note...", max length ~70 chars (use `maxLength={70}` on textarea).
   - Auto-save: Use `useRef` for debounce timer (500ms). On each keystroke update local state immediately. On debounce timeout OR onBlur, call `onNoteChange(text)`. Clear timer on unmount.
   - Character counter: Only render when `text.length >= 55` (last 15 chars). Show remaining count. Use `text-warning` color when <= 15 remaining, `text-error` when at 0.
   - Do NOT auto-focus the textarea on expand (mobile keyboard stealing, per research pitfall).

3. **Previous notes section**: Always rendered below the input (when expanded).
   - Use `useExerciseNotes(originalExerciseId)` hook.
   - Wrap in a collapsible section labeled "Previous notes" using a simple disclosure toggle (not the full CollapsibleSection component -- keep it lightweight, just a clickable header with chevron).
   - Each history entry: format session_date with `date-fns` `format(parseISO(date), 'MMM d')` (e.g., "Jan 28"). Show date in `text-text-muted` and note text in `text-text-secondary`.
   - When no notes: show "No previous notes" in muted text inside the section (section is visible, not hidden).
   - Notes are read-only -- no edit/delete UI on history entries.

Styling:
- Use existing project Tailwind classes: `bg-bg-tertiary`, `text-text-primary`, `text-text-muted`, `text-text-secondary`, `border-border-primary`, `text-accent`, `rounded-xl`.
- Textarea should have: `bg-bg-elevated border border-border-primary rounded-lg p-2 text-sm text-text-primary placeholder:text-text-muted w-full resize-none focus:outline-none focus:border-accent`.
- Toggle icon button: `text-text-muted hover:text-accent transition-colors` with small padding.
- Use `framer-motion` (`AnimatePresence` + `motion.div`) for expand/collapse animation on the note section. Import from `framer-motion` (project uses LazyMotion but inline imports work for small components).

IMPORTANT: Do NOT use `autoFocus` on the textarea. Let user tap into it.
  </action>
  <verify>Run `npx tsc --noEmit` -- zero errors. Visually inspect the component structure by reading the file back.</verify>
  <done>useExerciseNotes hook queries note history via CTE SQL. ExerciseNote component has tap-to-reveal input, 500ms debounce auto-save, character counter at 55+ chars, and collapsible previous notes section with date-formatted history.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate ExerciseNote into ExerciseView and add demo data notes</name>
  <files>src/components/workout/ExerciseView.tsx, src/db/demo-data.ts</files>
  <action>
**In `src/components/workout/ExerciseView.tsx`:**

1. Import `ExerciseNote` from `./ExerciseNote`.
2. Import `useWorkoutStore` selector for `session.notes` -- the store is already imported, just need to select `setNote` action and notes for current exercise.
3. Add store selectors:
   ```typescript
   const setNote = useWorkoutStore(state => state.setNote);
   const currentNote = useWorkoutStore(
     state => state.session?.notes?.[planExercise.exercise_id] ?? ''
   );
   ```
4. Render `<ExerciseNote>` AFTER the `<SetGrid>` component and BEFORE the navigation buttons. Place it inside the `{session && (...)}` block, after SetGrid:
   ```tsx
   <ExerciseNote
     originalExerciseId={planExercise.exercise_id}
     currentNote={currentNote}
     onNoteChange={(note) => setNote(planExercise.exercise_id, note)}
   />
   ```

**In `src/db/demo-data.ts`:**

Add 2-3 `exercise_note_logged` events to the demo data generation. Find where demo workout events are created (after set_logged events for a workout). Add notes for 2-3 exercises in different demo workout sessions. Examples:
- "Felt strong today, moved up from 60kg" (for a bench press type exercise)
- "Left shoulder tight, kept weight light" (for an overhead press type exercise)
- "Grip gave out on last set" (for a deadlift/row type exercise)

Follow the exact same `writeEvent` pattern used for other demo events. Use the `ExerciseNoteLoggedEvent` type. Make sure the `workout_id`, `exercise_id`, and `original_exercise_id` match existing demo workout/exercise IDs in the demo data function.

NOTE: Read the demo-data.ts file first to understand the structure and find appropriate workout IDs and exercise IDs to attach notes to. The notes should be attached to completed workouts that already have set_logged events.
  </action>
  <verify>Run `npx tsc --noEmit` -- zero errors. Run `npx vitest run` -- all tests pass. Run `npx vite build` -- clean build. Grep ExerciseView.tsx for `ExerciseNote` to confirm integration. Grep demo-data.ts for `exercise_note_logged` to confirm demo notes exist.</verify>
  <done>ExerciseNote renders below SetGrid for each exercise during workout logging. Demo data includes 2-3 sample exercise notes visible when loading demo data. Full feature is functional: type note -> auto-saves -> completes workout -> note persisted as event -> visible in next session's Previous Notes.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npx vitest run` -- all tests pass
3. `npx vite build` -- clean production build
4. ExerciseNote component renders below SetGrid in ExerciseView
5. Tap icon -> textarea expands with "Quick note..." placeholder
6. Typing auto-saves via debounce to Zustand store
7. Character counter appears at 55+ characters typed
8. Previous notes section always visible (shows "No previous notes" or history entries)
9. Demo data includes exercise notes visible in history
10. Completing a workout with notes writes exercise_note_logged events to DuckDB
</verification>

<success_criteria>
- NOTE-01: Free text field per exercise during workout logging -- icon below sets, expands to textarea
- NOTE-02: Notes saved with workout session data via event sourcing -- exercise_note_logged events written on workout save
- NOTE-03: Notes visible in exercise history on next workout -- useExerciseNotes hook + Previous Notes section in ExerciseNote
- All three requirements fully satisfied end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/25-exercise-notes/25-02-SUMMARY.md`
</output>
