---
phase: 13-e2e-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/Navigation.tsx
  - src/components/workout/StartWorkout.tsx
  - src/components/workout/SetRow.tsx
  - src/components/workout/SetGrid.tsx
  - src/components/workout/WorkoutComplete.tsx
  - src/components/workout/ActiveWorkout.tsx
  - src/components/settings/DemoDataSection.tsx
  - src/components/backup/BackupSettings.tsx
  - src/components/rotation/QuickStartCard.tsx
  - src/components/templates/TemplateBuilder.tsx
  - src/components/templates/TemplateCard.tsx
  - src/components/ExerciseForm.tsx
  - src/components/GymForm.tsx
  - src/components/analytics/AnalyticsPage.tsx
  - src/components/DeleteConfirmation.tsx
  - src/e2e/fixtures/app.fixture.ts
  - src/e2e/helpers/selectors.ts
  - src/e2e/helpers/seed.ts
  - playwright.config.ts
autonomous: true

must_haves:
  truths:
    - "All E2E tests can locate interactive elements via data-testid without relying on text content or CSS classes"
    - "Every test starts with a known-ready app state (DuckDB initialized, app rendered)"
    - "Tests can seed data through the UI or via demo data import without hand-rolling SQL"
  artifacts:
    - path: "src/e2e/fixtures/app.fixture.ts"
      provides: "Custom Playwright fixture with app readiness wait and cleanup"
      min_lines: 30
    - path: "src/e2e/helpers/selectors.ts"
      provides: "Centralized data-testid selector constants"
      min_lines: 20
    - path: "src/e2e/helpers/seed.ts"
      provides: "Data seeding helpers (demo data via UI, cleanup)"
      min_lines: 20
  key_links:
    - from: "src/e2e/fixtures/app.fixture.ts"
      to: "src/e2e/helpers/selectors.ts"
      via: "import selectors for readiness detection"
      pattern: "import.*selectors"
    - from: "src/components/Navigation.tsx"
      to: "src/e2e/helpers/selectors.ts"
      via: "data-testid attributes match selector constants"
      pattern: "data-testid"
---

<objective>
Add data-testid attributes to all key interactive components and create the shared E2E test infrastructure (fixtures, selectors, seed helpers, config updates).

Purpose: Every subsequent test plan depends on stable selectors and a reusable app-readiness fixture. Without data-testid attributes, tests would break on any text or CSS change.

Output: data-testid attributes on ~15 production components, plus src/e2e/fixtures/ and src/e2e/helpers/ modules ready for import by all spec files.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-e2e-tests/13-RESEARCH.md
@.planning/phases/13-e2e-tests/13-CONTEXT.md
@playwright.config.ts
@src/e2e/workout-flow.spec.ts
@src/components/Navigation.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add data-testid attributes to production components</name>
  <files>
    src/components/Navigation.tsx
    src/components/workout/StartWorkout.tsx
    src/components/workout/SetRow.tsx
    src/components/workout/SetGrid.tsx
    src/components/workout/WorkoutComplete.tsx
    src/components/workout/ActiveWorkout.tsx
    src/components/settings/DemoDataSection.tsx
    src/components/backup/BackupSettings.tsx
    src/components/rotation/QuickStartCard.tsx
    src/components/templates/TemplateBuilder.tsx
    src/components/templates/TemplateCard.tsx
    src/components/ExerciseForm.tsx
    src/components/GymForm.tsx
    src/components/analytics/AnalyticsPage.tsx
    src/components/DeleteConfirmation.tsx
  </files>
  <action>
    Add `data-testid` attributes to key interactive elements. Do NOT change any logic, styling, or structure -- only add the attribute to existing JSX elements.

    **Navigation.tsx:**
    - Each tab button: `data-testid="nav-workouts"`, `data-testid="nav-templates"`, `data-testid="nav-analytics"`, `data-testid="nav-settings"`

    **StartWorkout.tsx:**
    - Gym select: `data-testid="gym-select"` (already has `id="gym-select"`, add testid too)
    - Template select: `data-testid="template-select"`
    - Start Workout button (manual): `data-testid="btn-start-workout"`

    **QuickStartCard.tsx:**
    - Outer container div (the one with `border-2 border-accent`): `data-testid="quick-start-card"`
    - Start Workout button inside card: `data-testid="btn-quick-start"`
    - Rotation info text ("Workout N of M"): `data-testid="rotation-info"`

    **SetRow.tsx:**
    - Weight input: `data-testid={`set-${setNumber}-weight`}`
    - Reps input: `data-testid={`set-${setNumber}-reps`}`
    - RIR input: `data-testid={`set-${setNumber}-rir`}`
    - Remove button: `data-testid={`set-${setNumber}-remove`}`
    - PR badge span: `data-testid={`set-${setNumber}-pr`}`

    **SetGrid.tsx:**
    - "+ Add Set" button: `data-testid="btn-add-set"`
    - "First time - no previous data" div: `data-testid="first-time-hint"`
    - "Loading last session..." div: `data-testid="loading-ghost-data"`

    **WorkoutComplete.tsx:**
    - "Save Workout" button: `data-testid="btn-save-workout"`
    - "Done" button: `data-testid="btn-done-workout"`
    - "Go Back" button: `data-testid="btn-go-back"`
    - "Workout Complete" heading: `data-testid="workout-complete-heading"`
    - "Workout Saved!" heading: `data-testid="workout-saved-heading"`
    - "Log at least one set" text: `data-testid="no-sets-warning"`

    **ActiveWorkout.tsx:**
    - "Finish Workout" button: `data-testid="btn-finish-workout"`
    - Exercise name heading (if rendered): `data-testid="active-exercise-name"`

    **DemoDataSection.tsx:**
    - "Load Demo Data" button: `data-testid="btn-load-demo"`
    - "Clear All Data" button: `data-testid="btn-clear-data"`

    **BackupSettings.tsx:**
    - "Export Backup" button: `data-testid="btn-export-backup"`
    - "Import Backup" button: `data-testid="btn-import-backup"`
    - Hidden file input: `data-testid="file-input-parquet"`
    - Event count text (the `{eventCount} events` span): `data-testid="event-count"`
    - Import result div: `data-testid="import-result"`

    **TemplateBuilder.tsx:**
    - Template name input: `data-testid="template-name-input"`
    - "Create Template" / submit button: `data-testid="btn-create-template"`

    **TemplateCard.tsx:**
    - 3-dot menu button: `data-testid="btn-template-menu"`
    - Delete option in dropdown: `data-testid="btn-template-delete"`

    **ExerciseForm.tsx:**
    - Exercise name input: `data-testid="exercise-name-input"`
    - Muscle group select: `data-testid="exercise-muscle-select"`
    - "Add Exercise" submit button: `data-testid="btn-add-exercise"`

    **GymForm.tsx:**
    - Gym name input: `data-testid="gym-name-input"`
    - Location input: `data-testid="gym-location-input"`
    - "Add Gym" submit button: `data-testid="btn-add-gym"`

    **AnalyticsPage.tsx:**
    - Exercise selector dropdown: `data-testid="analytics-exercise-select"`
    - Charts container (wrapper around Recharts): `data-testid="analytics-charts"`
    - Empty state message: `data-testid="analytics-empty"`

    **DeleteConfirmation.tsx:**
    - "Delete" confirm button: `data-testid="btn-confirm-delete"`
    - "Cancel" button: `data-testid="btn-cancel-delete"`

    IMPORTANT: Pass `data-testid` through to the underlying DOM element. For custom components like `<Input>`, `<Button>`, `<Select>` -- check if they spread `...rest` props onto the native element. If they do, just add `data-testid` as a prop. If they don't, add `...rest` spread to the component first (check src/components/ui/Input.tsx and src/components/ui/Button.tsx).
  </action>
  <verify>
    Run `grep -r 'data-testid' src/components/ | wc -l` -- should return 30+ matches.
    Run `npm run build` -- no TypeScript or build errors.
    Run `npm run test` -- existing unit tests still pass.
  </verify>
  <done>30+ data-testid attributes added across 15 components. Build passes. Unit tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Create E2E fixtures, helpers, and update Playwright config</name>
  <files>
    src/e2e/fixtures/app.fixture.ts
    src/e2e/helpers/selectors.ts
    src/e2e/helpers/seed.ts
    playwright.config.ts
  </files>
  <action>
    **src/e2e/helpers/selectors.ts:**
    Export a `SEL` object with all data-testid selectors as constants:
    ```typescript
    export const SEL = {
      // Navigation
      navWorkouts: '[data-testid="nav-workouts"]',
      navTemplates: '[data-testid="nav-templates"]',
      navAnalytics: '[data-testid="nav-analytics"]',
      navSettings: '[data-testid="nav-settings"]',
      // Workout
      gymSelect: '[data-testid="gym-select"]',
      templateSelect: '[data-testid="template-select"]',
      btnStartWorkout: '[data-testid="btn-start-workout"]',
      btnFinishWorkout: '[data-testid="btn-finish-workout"]',
      btnSaveWorkout: '[data-testid="btn-save-workout"]',
      btnDoneWorkout: '[data-testid="btn-done-workout"]',
      btnGoBack: '[data-testid="btn-go-back"]',
      noSetsWarning: '[data-testid="no-sets-warning"]',
      workoutCompleteHeading: '[data-testid="workout-complete-heading"]',
      workoutSavedHeading: '[data-testid="workout-saved-heading"]',
      // Quick Start
      quickStartCard: '[data-testid="quick-start-card"]',
      btnQuickStart: '[data-testid="btn-quick-start"]',
      rotationInfo: '[data-testid="rotation-info"]',
      // Set logging
      btnAddSet: '[data-testid="btn-add-set"]',
      firstTimeHint: '[data-testid="first-time-hint"]',
      loadingGhostData: '[data-testid="loading-ghost-data"]',
      // Settings
      btnLoadDemo: '[data-testid="btn-load-demo"]',
      btnClearData: '[data-testid="btn-clear-data"]',
      btnExportBackup: '[data-testid="btn-export-backup"]',
      btnImportBackup: '[data-testid="btn-import-backup"]',
      fileInputParquet: '[data-testid="file-input-parquet"]',
      eventCount: '[data-testid="event-count"]',
      importResult: '[data-testid="import-result"]',
      // Templates
      templateNameInput: '[data-testid="template-name-input"]',
      btnCreateTemplate: '[data-testid="btn-create-template"]',
      btnTemplateMenu: '[data-testid="btn-template-menu"]',
      btnTemplateDelete: '[data-testid="btn-template-delete"]',
      // Exercises
      exerciseNameInput: '[data-testid="exercise-name-input"]',
      exerciseMuscleSelect: '[data-testid="exercise-muscle-select"]',
      btnAddExercise: '[data-testid="btn-add-exercise"]',
      // Gyms
      gymNameInput: '[data-testid="gym-name-input"]',
      gymLocationInput: '[data-testid="gym-location-input"]',
      btnAddGym: '[data-testid="btn-add-gym"]',
      // Analytics
      analyticsExerciseSelect: '[data-testid="analytics-exercise-select"]',
      analyticsCharts: '[data-testid="analytics-charts"]',
      analyticsEmpty: '[data-testid="analytics-empty"]',
      // Delete confirmation
      btnConfirmDelete: '[data-testid="btn-confirm-delete"]',
      btnCancelDelete: '[data-testid="btn-cancel-delete"]',
    } as const;

    // Dynamic selectors for set rows
    export const setRow = (n: number) => ({
      weight: `[data-testid="set-${n}-weight"]`,
      reps: `[data-testid="set-${n}-reps"]`,
      rir: `[data-testid="set-${n}-rir"]`,
      remove: `[data-testid="set-${n}-remove"]`,
      pr: `[data-testid="set-${n}-pr"]`,
    });
    ```

    **src/e2e/fixtures/app.fixture.ts:**
    Create a custom Playwright fixture that extends the base test:
    ```typescript
    import { test as base, expect, type Page } from '@playwright/test';
    import { SEL } from '../helpers/selectors';

    // Helper to wait for app readiness (DuckDB initialized + app rendered)
    async function waitForApp(page: Page) {
      await page.waitForSelector(SEL.navWorkouts, { timeout: 30000 });
    }

    // Helper to clear all data via Settings UI
    async function clearAllData(page: Page) {
      await page.click(SEL.navSettings);
      // Set up dialog handler before clicking
      page.once('dialog', d => d.accept());
      const reloadPromise = page.waitForURL('**/*');
      await page.click(SEL.btnClearData);
      await reloadPromise;
      await waitForApp(page);
    }

    // Helper to load demo data via Settings UI
    async function loadDemoData(page: Page) {
      await page.click(SEL.navSettings);
      // Handle confirm dialog if data exists
      page.on('dialog', d => d.accept());
      const reloadPromise = page.waitForURL('**/*');
      await page.click(SEL.btnLoadDemo);
      await reloadPromise;
      // Remove dialog listener after reload
      page.removeAllListeners('dialog');
      await waitForApp(page);
    }

    export const test = base.extend<{
      appPage: Page;
    }>({
      appPage: async ({ page }, use) => {
        await page.goto('/');
        await waitForApp(page);
        await use(page);
      },
    });

    export { expect, waitForApp, clearAllData, loadDemoData };
    ```

    **src/e2e/helpers/seed.ts:**
    Create seed helpers that use the UI to create gyms, exercises, templates:
    ```typescript
    import type { Page } from '@playwright/test';
    import { SEL, setRow } from './selectors';

    export async function createGym(page: Page, name: string, location: string) {
      await page.click(SEL.navSettings);
      await page.fill(SEL.gymNameInput, name);
      await page.fill(SEL.gymLocationInput, location);
      await page.click(SEL.btnAddGym);
      // Wait for gym to appear in list
      await page.waitForSelector(`text="${name}"`, { timeout: 5000 });
    }

    export async function createExercise(page: Page, name: string, muscleGroup: string) {
      await page.click(SEL.navSettings);
      await page.fill(SEL.exerciseNameInput, name);
      await page.locator(SEL.exerciseMuscleSelect).selectOption(muscleGroup);
      await page.click(SEL.btnAddExercise);
      await page.waitForSelector(`text="${name}"`, { timeout: 5000 });
    }

    // Log a set in the active workout at given row index (1-based)
    export async function logSet(page: Page, setNumber: number, weight: string, reps: string, rir?: string) {
      const row = setRow(setNumber);
      await page.fill(row.weight, weight);
      await page.fill(row.reps, reps);
      if (rir) {
        await page.fill(row.rir, rir);
      }
      // Blur to trigger auto-save
      await page.locator(row.reps).blur();
    }
    ```

    **playwright.config.ts updates:**
    - Add `screenshot: 'only-on-failure'` to the `use` block
    - Add `video: 'retain-on-failure'` to the `use` block
    - Set `timeout: 60000` (60s per test -- DuckDB-WASM operations are slow)
    - Set `expect: { timeout: 10000 }` (10s for assertions)
    - Keep existing config intact

    **Delete the old spec file** `src/e2e/workout-flow.spec.ts` -- it uses outdated selectors and will be replaced by the new test plans. The old test was a Phase 8 placeholder; this phase replaces it entirely.
  </action>
  <verify>
    Run `ls src/e2e/fixtures/ src/e2e/helpers/` -- files exist.
    Run `npx tsc --noEmit` -- no TypeScript errors in fixture/helper files.
    Run `npm run build` -- build passes.
  </verify>
  <done>Custom fixture, selectors module, seed helpers all created. Playwright config updated with screenshot/video on failure and generous timeouts. Old placeholder spec deleted.</done>
</task>

</tasks>

<verification>
- `grep -r 'data-testid' src/components/ | wc -l` returns 30+
- `npm run build` passes
- `npm run test` passes (unit tests unaffected)
- `ls src/e2e/fixtures/app.fixture.ts src/e2e/helpers/selectors.ts src/e2e/helpers/seed.ts` all exist
- `npx tsc --noEmit` passes
</verification>

<success_criteria>
- data-testid attributes added to all key interactive elements across 15 components
- Shared fixture provides app readiness wait, cleanup, and demo data loading
- Selectors module provides a single source of truth for all test selectors
- Seed helpers provide reusable gym/exercise/set creation through the UI
- Playwright config has screenshot-on-failure, video-on-failure, and 60s timeout
- Build and unit tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/13-e2e-tests/13-01-SUMMARY.md`
</output>
