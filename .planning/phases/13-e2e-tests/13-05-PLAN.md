---
phase: 13-e2e-tests
plan: 05
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/e2e/demo-data.spec.ts
autonomous: true

must_haves:
  truths:
    - "E2E test imports demo data and verifies charts populate in Analytics, then clears all data and verifies empty state"
  artifacts:
    - path: "src/e2e/demo-data.spec.ts"
      provides: "TEST-04: Demo data import and clear"
      min_lines: 60
  key_links:
    - from: "src/e2e/demo-data.spec.ts"
      to: "src/e2e/fixtures/app.fixture.ts"
      via: "import custom fixture and loadDemoData helper"
      pattern: "import.*app\\.fixture"
---

<objective>
Write the Demo Data Import and Clear E2E test (TEST-04 / SUCCESS CRITERION 4).

Purpose: Validates the one-click demo data feature works correctly for portfolio reviewers -- data loads, charts populate, and clearing removes everything.

Output: src/e2e/demo-data.spec.ts with import, verify, clear, and verify-empty tests.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/13-e2e-tests/13-RESEARCH.md
@src/components/settings/DemoDataSection.tsx
@src/components/analytics/AnalyticsPage.tsx
@src/components/backup/BackupSettings.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write demo-data.spec.ts -- Demo data import and clear</name>
  <files>src/e2e/demo-data.spec.ts</files>
  <action>
    Create `src/e2e/demo-data.spec.ts` using the custom fixture.

    Import `test`, `expect`, `loadDemoData`, `clearAllData`, `waitForApp` from fixtures/app.fixture. Import `SEL` from helpers/selectors.

    Use `test.describe.serial()` since clear depends on import having happened.

    **Test 1: "Load demo data and verify event count"**
    1. Navigate to Settings tab via `SEL.navSettings`
    2. Note that event count should show "0 events" initially (or use `SEL.eventCount`)
    3. Call `loadDemoData(page)` helper (handles dialog + reload + readiness wait)
    4. Navigate to Settings tab again
    5. Assert event count is > 0 (use `SEL.eventCount` and verify text contains a number > 0)
       - Demo data creates ~288+ events. Assert `eventCount` text does NOT contain "0 events"
       - Or parse the number and assert `> 200`

    **Test 2: "Charts populate after demo data import"**
    1. Navigate to Analytics tab via `SEL.navAnalytics`
    2. Wait for analytics page to load
    3. Assert `SEL.analyticsEmpty` is NOT visible (no empty state)
    4. If exercise selector exists (`SEL.analyticsExerciseSelect`), select the first available exercise
    5. Wait for Recharts to render: `page.locator('.recharts-surface').first()` with timeout 15000
    6. Assert at least one `.recharts-surface` SVG element is visible (chart rendered)
    7. Optionally assert the exercise selector has multiple options (demo creates 10 exercises)

    **Test 3: "Clear all data and verify empty state"**
    1. Call `clearAllData(page)` helper (handles dialog + reload + readiness wait)
    2. Navigate to Settings tab
    3. Assert event count shows "0 events" (use `SEL.eventCount`)
    4. Navigate to Analytics tab via `SEL.navAnalytics`
    5. Assert empty state is visible (`SEL.analyticsEmpty` or text "No exercises yet" or similar)
    6. Assert `.recharts-surface` is NOT visible (no charts)

    **Test 4: "Load demo data when existing data triggers confirm dialog"**
    1. Load demo data once (call `loadDemoData(page)`)
    2. Navigate to Settings
    3. Verify event count > 0
    4. Now load demo data AGAIN -- this time `eventCount > 0` so `window.confirm()` fires
    5. The `loadDemoData` helper already handles dialogs. Verify it succeeds.
    6. Assert event count is still > 0 after reload

    **Implementation notes:**
    - `loadDemoData()` in DemoDataSection.tsx clears existing events first, then loads demo data, then reloads
    - `clearAllData()` from utils/clearAllData.ts drops the events table, deletes OPFS files, clears localStorage, then reloads
    - Both trigger `window.location.reload()` -- the helpers in app.fixture.ts handle the reload wait
    - The confirm dialog only appears when `eventCount > 0` for load demo. Clear always shows confirm.
    - Analytics page is lazy-loaded; Recharts takes a moment to render SVG elements
  </action>
  <verify>
    Run `npx playwright test demo-data.spec.ts --reporter=line` -- all 4 tests pass.
    Charts are confirmed visible after demo import and gone after clear.
  </verify>
  <done>demo-data.spec.ts passes: demo data loads, event count increases, charts populate, clear removes all data, empty state confirmed.</done>
</task>

</tasks>

<verification>
- `npx playwright test demo-data.spec.ts` passes (4 tests)
- Charts are visible after demo data import
- Empty state after clear all data
- Confirm dialog handled correctly when data exists
</verification>

<success_criteria>
- TEST-04 fully covered: demo data import, chart verification, clear, empty state
- Tests handle window.confirm() dialogs and page reloads
- Analytics charts verified via .recharts-surface selector
</success_criteria>

<output>
After completion, create `.planning/phases/13-e2e-tests/13-05-SUMMARY.md`
</output>
