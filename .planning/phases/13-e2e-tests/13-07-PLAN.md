---
phase: 13-e2e-tests
plan: 07
type: execute
wave: 3
depends_on: ["13-02", "13-03", "13-04", "13-05", "13-06"]
files_modified:
  - .github/workflows/ci.yml
  - playwright.config.ts
autonomous: true

must_haves:
  truths:
    - "All E2E tests pass in CI via GitHub Actions"
    - "Test reports and failure screenshots are uploaded as CI artifacts"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "Updated CI workflow with E2E test job including screenshot/report artifacts"
      contains: "playwright"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "playwright.config.ts"
      via: "npx playwright test command"
      pattern: "playwright test"
---

<objective>
Update CI configuration to properly run all E2E tests and upload failure artifacts (screenshots, videos, reports).

Purpose: The existing CI workflow already has an E2E job, but it needs updates to handle the new test suite's longer timeouts and failure artifact collection.

Output: Updated ci.yml with proper E2E artifact handling.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/13-e2e-tests/13-RESEARCH.md
@.github/workflows/ci.yml
@playwright.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update CI workflow for comprehensive E2E test suite</name>
  <files>
    .github/workflows/ci.yml
    playwright.config.ts
  </files>
  <action>
    **Update `.github/workflows/ci.yml` -- the `test-e2e` job:**

    The existing job already installs Playwright Chromium and runs tests. Update it to:

    1. Add `timeout-minutes: 10` to the job (E2E tests with DuckDB-WASM can take a while)

    2. Keep existing steps (checkout, setup node, npm ci, install playwright chromium, run tests)

    3. Update the artifact upload step to also capture:
       - `test-results/` directory (contains screenshots and videos on failure)
       - Keep existing `playwright-report/` upload

    Replace the existing artifact upload with TWO upload steps (or one with multiple paths):
    ```yaml
    - name: Upload Playwright report
      if: ${{ !cancelled() }}
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 7

    - name: Upload test artifacts (screenshots, videos)
      if: ${{ !cancelled() }}
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: test-results/
        retention-days: 7
        if-no-files-found: ignore
    ```

    4. The build-deploy job already depends on test-e2e. No changes needed there.

    **Update `playwright.config.ts`** (if not already done in 13-01):
    - Ensure `outputDir: 'test-results'` is set (this is where Playwright stores failure screenshots/videos)
    - This should already exist or be default, but verify.

    **Verify the full test suite runs locally before declaring CI ready:**
    Run `npx playwright test --reporter=line` to confirm all 5 spec files pass together.
  </action>
  <verify>
    Run `npx playwright test --reporter=line` -- all specs pass (plan-crud, batch-logging, workout-rotation, demo-data, parquet-roundtrip).
    Run `cat .github/workflows/ci.yml | grep -A5 "test-results"` -- artifact upload for test-results exists.
    Run `npm run build` -- build still passes.
  </verify>
  <done>CI workflow updated with test-results artifact upload and timeout. All E2E tests pass locally as a full suite.</done>
</task>

<task type="auto">
  <name>Task 2: Run full E2E suite and verify all 5 success criteria</name>
  <files></files>
  <action>
    Run the complete E2E test suite and verify all 5 success criteria are met:

    1. Run `npx playwright test --reporter=list` to see each test name and result
    2. Verify all tests pass:
       - plan-crud.spec.ts: creates plan, logs workout, deletes plan, history persists (SC-1)
       - batch-logging.spec.ts: empty sets, max values, ghost text (SC-2)
       - workout-rotation.spec.ts: Quick Start, rotation advances (SC-3)
       - demo-data.spec.ts: import demo, charts populate, clear, empty state (SC-4)
       - parquet-roundtrip.spec.ts: export, clear, reimport, data matches (SC-5)
    3. If any test fails, diagnose and fix. Common issues:
       - Timeout: Increase specific wait timeouts
       - Selector not found: Check data-testid was applied correctly
       - State leakage: Ensure each spec starts from clean state
    4. Run the suite 3 times to check for flakiness: `for i in 1 2 3; do npx playwright test --reporter=line; done`
    5. If flaky, add targeted waits or retry logic

    Report the final test count and pass/fail status.
  </action>
  <verify>
    All 5 spec files pass on 3 consecutive runs.
    `npx playwright test --reporter=line` exits with code 0.
  </verify>
  <done>Full E2E suite passes: 5 spec files, all success criteria verified, no flaky tests on 3 consecutive runs.</done>
</task>

</tasks>

<verification>
- `npx playwright test` passes with all specs (0 failures)
- CI workflow includes test-results artifact upload
- All 5 success criteria covered by the test suite
- No flaky failures on repeated runs
</verification>

<success_criteria>
- CI workflow properly runs E2E tests and uploads failure artifacts
- Full test suite passes locally
- All 5 success criteria from the phase are covered and verified
- Suite is stable (no flakiness on 3 consecutive runs)
</success_criteria>

<output>
After completion, create `.planning/phases/13-e2e-tests/13-07-SUMMARY.md`
</output>
