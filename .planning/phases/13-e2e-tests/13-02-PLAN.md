---
phase: 13-e2e-tests
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/e2e/plan-crud.spec.ts
autonomous: true

must_haves:
  truths:
    - "E2E test creates a gym, exercise, and template, logs a workout, deletes the template, and verifies exercise history persists in analytics"
  artifacts:
    - path: "src/e2e/plan-crud.spec.ts"
      provides: "TEST-01: Plan CRUD with exercise history preservation"
      min_lines: 80
  key_links:
    - from: "src/e2e/plan-crud.spec.ts"
      to: "src/e2e/fixtures/app.fixture.ts"
      via: "import custom fixture"
      pattern: "import.*app\\.fixture"
    - from: "src/e2e/plan-crud.spec.ts"
      to: "src/e2e/helpers/selectors.ts"
      via: "import selectors"
      pattern: "import.*selectors"
---

<objective>
Write the Plan CRUD + History Preservation E2E test (TEST-01 / SUCCESS CRITERION 1).

Purpose: Validates that deleting a template does NOT delete exercise history -- the critical bug fix from Phase 12 (BUG-01). This is the highest-value regression test.

Output: src/e2e/plan-crud.spec.ts with a complete workflow test.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/13-e2e-tests/13-RESEARCH.md
@src/components/workout/StartWorkout.tsx
@src/components/workout/WorkoutComplete.tsx
@src/components/templates/TemplateCard.tsx
@src/components/templates/TemplateBuilder.tsx
@src/components/analytics/AnalyticsPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write plan-crud.spec.ts -- Plan CRUD with history preservation</name>
  <files>src/e2e/plan-crud.spec.ts</files>
  <action>
    Create `src/e2e/plan-crud.spec.ts` using the custom fixture from `src/e2e/fixtures/app.fixture.ts`.

    Import the `test` and `expect` from the custom fixture. Import `SEL`, `setRow` from helpers/selectors. Import seed helpers from helpers/seed.

    **Test: "Plan CRUD with exercise history preservation after deletion"**

    Flow (single test, sequential steps):

    1. **Setup: Create gym and exercise via seed helpers**
       - `createGym(page, 'E2E Test Gym', 'Test Location')`
       - `createExercise(page, 'E2E Bench Press', 'Chest')`

    2. **Create template**
       - Navigate to Templates tab via `SEL.navTemplates`
       - Click "+ New Template" button (use `text="+ New Template"` or similar)
       - Fill template name input (`SEL.templateNameInput`) with "E2E Push Day"
       - Find and check the "E2E Bench Press" checkbox in the exercise picker
       - Click create template button (`SEL.btnCreateTemplate`)
       - Assert template "E2E Push Day" is visible in template list

    3. **Log a workout using the template**
       - Navigate to Workouts tab via `SEL.navWorkouts`
       - Select gym via `SEL.gymSelect` (select option matching "E2E Test Gym")
       - Select template via `SEL.templateSelect` (select option matching "E2E Push Day")
       - Click `SEL.btnStartWorkout`
       - Wait for SetGrid to load (wait for `SEL.firstTimeHint` or set row to appear)
       - Log set 1: `logSet(page, 1, '80', '10', '2')`
       - Click `SEL.btnFinishWorkout`
       - Assert `SEL.workoutCompleteHeading` is visible
       - Click `SEL.btnSaveWorkout`
       - Assert `SEL.workoutSavedHeading` is visible ("Workout Saved!")
       - Click `SEL.btnDoneWorkout`

    4. **Verify exercise appears in analytics BEFORE deletion**
       - Navigate to Analytics tab via `SEL.navAnalytics`
       - Wait for analytics page to load
       - If exercise selector is visible (`SEL.analyticsExerciseSelect`), select "E2E Bench Press"
       - Assert chart container or data is visible (use `SEL.analyticsCharts` or `.recharts-surface`)

    5. **Delete the template**
       - Navigate to Templates tab via `SEL.navTemplates`
       - Find the template card for "E2E Push Day"
       - Click the 3-dot menu button (`SEL.btnTemplateMenu`)
       - Click delete option (`SEL.btnTemplateDelete`)
       - Click confirm delete (`SEL.btnConfirmDelete`) in the DeleteConfirmation modal
       - Assert "E2E Push Day" is no longer visible in template list

    6. **Verify exercise history STILL persists after deletion**
       - Navigate to Analytics tab via `SEL.navAnalytics`
       - Select "E2E Bench Press" in the exercise selector
       - Assert chart data is still visible (`.recharts-surface` or chart container)
       - This is the critical assertion -- exercise history must survive template deletion

    Use `test.describe` to group. Use `test.beforeEach` with `appPage` fixture for navigation + app readiness. Clean up at test start: navigate to Settings, clear data if event count > 0.

    **Edge case test: "Template list shows empty state after deleting all templates"**
    - After deleting, verify the Templates tab shows an empty state message or "No templates" indicator

    Handle timing: Use generous timeouts for DuckDB operations (waitForSelector with timeout: 10000 for data-dependent assertions). The analytics page lazy-loads Recharts, so wait for `.recharts-surface` with timeout: 15000.
  </action>
  <verify>
    Run `npx playwright test plan-crud.spec.ts --reporter=line` -- test passes.
    The test must complete in under 60 seconds.
  </verify>
  <done>plan-crud.spec.ts passes: creates gym + exercise + template, logs workout, deletes template, and verifies exercise history persists in Analytics tab.</done>
</task>

</tasks>

<verification>
- `npx playwright test plan-crud.spec.ts` passes
- Test creates a plan, logs a workout, deletes the plan, and verifies history persists
- No flaky failures on 3 consecutive runs
</verification>

<success_criteria>
- TEST-01 fully covered: Plan CRUD with exercise history preservation after deletion
- Test uses stable data-testid selectors from Plan 13-01
- Test cleans up its own data or starts from clean state
</success_criteria>

<output>
After completion, create `.planning/phases/13-e2e-tests/13-02-SUMMARY.md`
</output>
