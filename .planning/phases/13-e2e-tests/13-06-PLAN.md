---
phase: 13-e2e-tests
plan: 06
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/e2e/parquet-roundtrip.spec.ts
autonomous: true

must_haves:
  truths:
    - "E2E test exports data as Parquet, re-imports from that file, and verifies event count matches"
  artifacts:
    - path: "src/e2e/parquet-roundtrip.spec.ts"
      provides: "TEST-05: Parquet export/import round-trip"
      min_lines: 60
  key_links:
    - from: "src/e2e/parquet-roundtrip.spec.ts"
      to: "src/e2e/fixtures/app.fixture.ts"
      via: "import custom fixture and loadDemoData helper"
      pattern: "import.*app\\.fixture"
---

<objective>
Write the Parquet Export/Import Round-Trip E2E test (TEST-05 / SUCCESS CRITERION 5).

Purpose: Validates data durability -- users can export their workout data as Parquet, clear their app, and re-import with no data loss. This is the most critical data integrity test.

Output: src/e2e/parquet-roundtrip.spec.ts with export, clear, import, and verification.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/13-e2e-tests/13-RESEARCH.md
@src/components/backup/BackupSettings.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write parquet-roundtrip.spec.ts -- Parquet export/import round-trip</name>
  <files>src/e2e/parquet-roundtrip.spec.ts</files>
  <action>
    Create `src/e2e/parquet-roundtrip.spec.ts` using the custom fixture.

    Import `test`, `expect`, `loadDemoData`, `clearAllData`, `waitForApp` from fixtures/app.fixture. Import `SEL` from helpers/selectors.

    **Test: "Parquet export and re-import preserves all data"**

    This is a single sequential test (must be one test, not split, because the download artifact is needed across steps):

    1. **Seed data:**
       - Call `loadDemoData(page)` to populate the app with demo data (~288+ events)

    2. **Record event count before export:**
       - Navigate to Settings tab via `SEL.navSettings`
       - Read the event count text from `SEL.eventCount`
       - Parse the number from text like "288 events" -- extract the integer
       - Store as `originalEventCount`
       - Assert `originalEventCount > 200` (sanity check demo data loaded)

    3. **Export Parquet file:**
       - Set up download listener BEFORE clicking: `const downloadPromise = page.waitForEvent('download')`
       - Click `SEL.btnExportBackup`
       - `const download = await downloadPromise`
       - Assert filename matches pattern: `expect(download.suggestedFilename()).toMatch(/gymlog-backup-.*\.parquet/)`
       - Save the download path: `const filePath = await download.path()`
       - Assert filePath is truthy (file was actually saved)

    4. **Clear all data:**
       - Call `clearAllData(page)` helper
       - Navigate to Settings tab
       - Assert event count shows "0 events" via `SEL.eventCount`

    5. **Import the exported Parquet file:**
       - Navigate to Settings tab (should already be there)
       - Use the hidden file input to import: `await page.locator(SEL.fileInputParquet).setInputFiles(filePath!)`
       - Wait for import result to appear: `await page.waitForSelector(SEL.importResult, { timeout: 30000 })`
       - Assert import result contains "Imported" text (success message)
       - Assert import result contains the original event count number

    6. **Verify event count matches:**
       - The import result message format is: "Imported N events (0 duplicates skipped)"
       - Parse N from the import result text
       - Assert N equals `originalEventCount`
       - OR: read the event count display (`SEL.eventCount`) after import -- but note: import may not trigger a reload, so the event count display might need a page refresh to update
       - If event count display hasn't updated, reload the page: `await page.reload()` then `await waitForApp(page)` then check `SEL.eventCount`

    **Edge case test: "Re-importing same file skips duplicates"**
    1. After the main test, try importing the SAME Parquet file again
    2. Set input files again: `await page.locator(SEL.fileInputParquet).setInputFiles(filePath!)`
    3. Wait for import result
    4. Assert the result shows "0" or the original count in "duplicates skipped"
    5. Assert event count hasn't doubled

    **Implementation notes:**
    - The export uses DuckDB `COPY TO` with zstd compression to create the Parquet file
    - The import uses `useBackupImport` hook which validates schema, inserts events, and skips duplicates by `_event_id`
    - The hidden file input has `accept=".parquet"` and is at `SEL.fileInputParquet`
    - Download path from Playwright is a temp file -- it persists for the test duration
    - Import does NOT trigger a page reload (unlike demo data load/clear). The import result is shown inline.
    - After import, the event count display in BackupSettings reads from `useDuckDB()` hook -- it may auto-update via reactivity, or may need a tab switch to trigger re-query
  </action>
  <verify>
    Run `npx playwright test parquet-roundtrip.spec.ts --reporter=line` -- test passes.
    Event count before export matches event count after re-import.
  </verify>
  <done>parquet-roundtrip.spec.ts passes: exports Parquet, clears data, reimports, event count matches original. Duplicate import correctly skips all events.</done>
</task>

</tasks>

<verification>
- `npx playwright test parquet-roundtrip.spec.ts` passes
- Exported file has correct naming pattern
- Event count after import matches event count before export
- Duplicate import skips all events
</verification>

<success_criteria>
- TEST-05 fully covered: Parquet export/import round-trip with data verification
- Event count integrity confirmed: export count == import count
- Duplicate import handled gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/13-e2e-tests/13-06-SUMMARY.md`
</output>
