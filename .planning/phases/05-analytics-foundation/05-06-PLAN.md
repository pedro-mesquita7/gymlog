---
phase: 05-analytics-foundation
plan: 06
type: execute
wave: 1
depends_on: []
files_modified: [src/hooks/useAnalytics.ts]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Progress chart renders line chart with weight data points over time"
    - "Week comparison card shows this week vs last week with percentage changes"
  artifacts:
    - path: "src/hooks/useAnalytics.ts"
      provides: "Correct date parsing for DuckDB-WASM DATE values"
      contains: "new Date(dateVal).toISOString"
  key_links:
    - from: "src/hooks/useAnalytics.ts"
      to: "DuckDB DATE column"
      via: "direct millisecond-to-Date conversion (no multiplication)"
      pattern: "new Date\\(dateVal\\)"
---

<objective>
Fix date parsing bug in useAnalytics.ts that causes "Invalid time value" errors on all chart and comparison components.

Purpose: DuckDB-WASM returns DATE values as millisecond-epoch integers (e.g., 1769731200000), but useExerciseProgress and useWeeklyComparison multiply by 86400000 assuming epoch-day integers. This produces values ~1.5e+23 which exceed JS Date max (~8.64e+15), causing RangeError.

Output: Both hooks correctly parse dates, unblocking progress charts and week comparison cards.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/hooks/useAnalytics.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove epoch-day multiplication from useExerciseProgress and useWeeklyComparison</name>
  <files>src/hooks/useAnalytics.ts</files>
  <action>
  In src/hooks/useAnalytics.ts, make these changes:

  1. **Lines 46-57 (useExerciseProgress date parsing):** Replace the entire date conversion block with:
     ```typescript
     // DuckDB-WASM DATE returns millisecond-epoch integers (number or BigInt)
     const dateVal = row.date;
     let dateStr: string;
     if (typeof dateVal === 'number') {
       dateStr = new Date(dateVal).toISOString().split('T')[0];
     } else if (typeof dateVal === 'bigint') {
       dateStr = new Date(Number(dateVal)).toISOString().split('T')[0];
     } else {
       const d = new Date(dateVal);
       dateStr = !isNaN(d.getTime()) ? d.toISOString().split('T')[0] : String(dateVal).split('T')[0];
     }
     ```
     Key change: Remove `* 86400000` from both the `number` branch (line 50) and the `bigint` branch (line 52). Update the comment on line 46 from "epoch-day integers" to "millisecond-epoch integers".

  2. **Lines 111-120 (useWeeklyComparison week_start parsing):** Apply the identical fix:
     ```typescript
     // DuckDB-WASM DATE returns millisecond-epoch integers (number or BigInt)
     const wsVal = row.week_start;
     let weekStartStr: string;
     if (typeof wsVal === 'number') {
       weekStartStr = new Date(wsVal).toISOString().split('T')[0];
     } else if (typeof wsVal === 'bigint') {
       weekStartStr = new Date(Number(wsVal)).toISOString().split('T')[0];
     } else {
       const d = new Date(wsVal);
       weekStartStr = !isNaN(d.getTime()) ? d.toISOString().split('T')[0] : String(wsVal).split('T')[0];
     }
     ```
     Key change: Remove `* 86400000` from both branches (lines 114 and 116).

  Do NOT change anything else in the file. The rest of the logic (field mapping, hook structure, etc.) is correct.
  </action>
  <verify>
  Run: `npx tsc --noEmit` to confirm no type errors.
  Grep the file for `86400000` — should return zero matches.
  Grep the file for `new Date(dateVal)` and `new Date(wsVal)` — should find the direct conversions.
  Grep the file for `new Date(Number(dateVal))` and `new Date(Number(wsVal))` — should find the BigInt conversions.
  </verify>
  <done>
  Both useExerciseProgress and useWeeklyComparison convert DuckDB DATE values directly to JS Date without multiplication. No `86400000` anywhere in the file. TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
- `grep -c "86400000" src/hooks/useAnalytics.ts` returns 0
- `grep -c "new Date(dateVal)" src/hooks/useAnalytics.ts` returns 1
- `grep -c "new Date(wsVal)" src/hooks/useAnalytics.ts` returns 1
- `npx tsc --noEmit` passes
- `npm run build` succeeds
</verification>

<success_criteria>
- Date parsing in useExerciseProgress uses `new Date(dateVal)` without multiplication
- Date parsing in useWeeklyComparison uses `new Date(wsVal)` without multiplication
- Comment accurately says "millisecond-epoch integers"
- Build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-analytics-foundation/05-06-SUMMARY.md`
</output>
