---
phase: 05-analytics-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/types/analytics.ts
  - src/db/compiled-queries.ts
autonomous: true

must_haves:
  truths:
    - "Recharts and date-fns are installed and available"
    - "TypeScript types exist for chart data structures"
    - "SQL queries exist for exercise progress and weekly comparison"
  artifacts:
    - path: "package.json"
      provides: "Recharts and date-fns dependencies"
      contains: "recharts"
    - path: "src/types/analytics.ts"
      provides: "ProgressPoint, WeeklyComparison types"
      contains: "ProgressPoint"
    - path: "src/db/compiled-queries.ts"
      provides: "EXERCISE_PROGRESS_SQL, WEEKLY_COMPARISON_SQL queries"
      contains: "EXERCISE_PROGRESS_SQL"
  key_links:
    - from: "src/db/compiled-queries.ts"
      to: "src/hooks"
      via: "Query imports"
      pattern: "export const.*SQL"
---

<objective>
Install Recharts and date-fns, extend TypeScript types, and add compiled SQL queries for analytics.

Purpose: Prepares the infrastructure for analytics features - installs charting library, defines data types for type safety, and compiles SQL queries matching dbt views. This is parallel work to Plan 01 (dbt models) since it doesn't depend on dbt output.
Output: Dependencies installed, TypeScript types defined, SQL queries ready for hooks.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-analytics-foundation/05-RESEARCH.md

# Existing patterns
@src/types/analytics.ts
@src/db/compiled-queries.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Recharts and date-fns dependencies</name>
  <files>
    package.json
  </files>
  <action>
Install the charting library and date utility:

```bash
npm install recharts@3.7.0 date-fns@4.1.0
```

Verify installation:
- recharts should be ~3.7.x
- date-fns should be ~4.1.x
- No peer dependency warnings

Note: Recharts is ~96KB gzipped. We'll lazy-load it in Plan 05 to keep main bundle small.
  </action>
  <verify>Run `npm list recharts date-fns` - should show both packages installed</verify>
  <done>recharts@3.7.x and date-fns@4.1.x installed in package.json</done>
</task>

<task type="auto">
  <name>Task 2: Extend analytics TypeScript types</name>
  <files>
    src/types/analytics.ts
  </files>
  <action>
Add new types for chart data to src/types/analytics.ts:

```typescript
// Add to existing file after existing types

// Progress chart data point (CHART-01, CHART-02, CHART-03)
export interface ProgressPoint {
  date: string;           // ISO date string (YYYY-MM-DD)
  maxWeight: number;      // Max weight lifted that day
  max1rm: number;         // Max estimated 1RM that day
  totalVolume: number;    // Sum of (weight * reps) for day
  setCount: number;       // Number of sets
}

// Weekly comparison data (CHART-04)
export interface WeeklyComparison {
  exerciseId: string;
  exerciseName: string;
  muscleGroup: string;
  weekStart: string;      // ISO date string
  maxWeight: number;
  max1rm: number;
  totalVolume: number;
  setCount: number;
  prevMaxWeight: number | null;
  prevVolume: number | null;
  weightChangePct: number | null;
  volumeChangePct: number | null;
}

// Hook return types
export interface UseExerciseProgressReturn {
  data: ProgressPoint[];
  isLoading: boolean;
  error: string | null;
  refresh: () => Promise<void>;
}

export interface UseWeeklyComparisonReturn {
  data: WeeklyComparison[];
  isLoading: boolean;
  error: string | null;
  refresh: () => Promise<void>;
}
```

Keep existing types (SetHistory, PRRecord, ExerciseMax, HistoryByDate) unchanged.
  </action>
  <verify>Run `npx tsc --noEmit` - should pass with no type errors</verify>
  <done>ProgressPoint, WeeklyComparison types exist with correct fields</done>
</task>

<task type="auto">
  <name>Task 3: Add compiled SQL queries for analytics</name>
  <files>
    src/db/compiled-queries.ts
  </files>
  <action>
Add SQL queries to src/db/compiled-queries.ts that mirror the dbt views:

```typescript
// Add after existing queries

// Exercise progress for charts (mirrors vw_exercise_progress.sql)
export const EXERCISE_PROGRESS_SQL = `
WITH daily_aggregates AS (
    SELECT
        original_exercise_id AS exercise_id,
        DATE_TRUNC('day', CAST(logged_at AS TIMESTAMP))::DATE AS date,
        MAX(weight_kg) AS max_weight,
        MAX(estimated_1rm) AS max_1rm,
        SUM(weight_kg * reps) AS total_volume,
        COUNT(*) AS set_count
    FROM (${FACT_SETS_SQL}) fact_sets
    WHERE CAST(logged_at AS TIMESTAMP) >= CURRENT_DATE - INTERVAL '28 days'
    GROUP BY original_exercise_id, DATE_TRUNC('day', CAST(logged_at AS TIMESTAMP))::DATE
),

exercise_dim AS (
    ${DIM_EXERCISE_SQL}
)

SELECT
    d.exercise_id,
    d.date,
    d.max_weight,
    d.max_1rm,
    d.total_volume,
    d.set_count,
    e.name AS exercise_name,
    e.muscle_group
FROM daily_aggregates d
INNER JOIN exercise_dim e ON d.exercise_id = e.exercise_id
WHERE d.exercise_id = $1
ORDER BY d.date
`;

// Weekly comparison (mirrors vw_weekly_comparison.sql)
export const WEEKLY_COMPARISON_SQL = `
WITH weekly_metrics AS (
    SELECT
        original_exercise_id AS exercise_id,
        DATE_TRUNC('week', CAST(logged_at AS TIMESTAMP))::DATE AS week_start,
        MAX(weight_kg) AS max_weight,
        MAX(estimated_1rm) AS max_1rm,
        SUM(weight_kg * reps) AS total_volume,
        COUNT(*) AS set_count
    FROM (${FACT_SETS_SQL}) fact_sets
    WHERE CAST(logged_at AS TIMESTAMP) >= CURRENT_DATE - INTERVAL '14 days'
    GROUP BY original_exercise_id, DATE_TRUNC('week', CAST(logged_at AS TIMESTAMP))::DATE
),

with_comparison AS (
    SELECT
        exercise_id,
        week_start,
        max_weight,
        max_1rm,
        total_volume,
        set_count,
        LAG(max_weight) OVER (PARTITION BY exercise_id ORDER BY week_start) AS prev_max_weight,
        LAG(total_volume) OVER (PARTITION BY exercise_id ORDER BY week_start) AS prev_volume
    FROM weekly_metrics
),

exercise_dim AS (
    ${DIM_EXERCISE_SQL}
)

SELECT
    w.exercise_id,
    w.week_start,
    w.max_weight,
    w.max_1rm,
    w.total_volume,
    w.set_count,
    w.prev_max_weight,
    w.prev_volume,
    e.name AS exercise_name,
    e.muscle_group,
    CASE
        WHEN w.prev_max_weight IS NOT NULL AND w.prev_max_weight > 0 THEN
            ROUND(((w.max_weight - w.prev_max_weight) / w.prev_max_weight) * 100, 1)
        ELSE NULL
    END AS weight_change_pct,
    CASE
        WHEN w.prev_volume IS NOT NULL AND w.prev_volume > 0 THEN
            ROUND(((w.total_volume - w.prev_volume) / w.prev_volume) * 100, 1)
        ELSE NULL
    END AS volume_change_pct
FROM with_comparison w
INNER JOIN exercise_dim e ON w.exercise_id = e.exercise_id
ORDER BY week_start DESC, exercise_name
`;
```

Both queries:
- Use existing FACT_SETS_SQL and DIM_EXERCISE_SQL patterns
- Support $1 placeholder for exercise_id filtering
- Match logic in dbt models exactly
  </action>
  <verify>Run `npx tsc --noEmit` - should pass (SQL is just strings)</verify>
  <done>EXERCISE_PROGRESS_SQL and WEEKLY_COMPARISON_SQL exported and use existing query patterns</done>
</task>

</tasks>

<verification>
- [ ] `npm list recharts date-fns` shows both packages
- [ ] `npx tsc --noEmit` passes with no errors
- [ ] ProgressPoint type has date, maxWeight, max1rm, totalVolume, setCount
- [ ] WeeklyComparison type has weightChangePct, volumeChangePct
- [ ] EXERCISE_PROGRESS_SQL uses DATE_TRUNC and GROUP BY
- [ ] WEEKLY_COMPARISON_SQL uses LAG window function
</verification>

<success_criteria>
- Recharts 3.7.x and date-fns 4.1.x installed
- TypeScript types defined for chart data structures
- SQL queries compile (string templates valid)
- No type errors in project
</success_criteria>

<output>
After completion, create `.planning/phases/05-analytics-foundation/05-02-SUMMARY.md`
</output>
