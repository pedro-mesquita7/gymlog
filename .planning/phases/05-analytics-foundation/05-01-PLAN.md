---
phase: 05-analytics-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - dbt/models/marts/analytics/vw_exercise_progress.sql
  - dbt/models/marts/analytics/vw_weekly_comparison.sql
  - dbt/models/marts/analytics/_analytics__models.yml
autonomous: true

must_haves:
  truths:
    - "vw_exercise_progress provides daily aggregates per exercise for last 28 days"
    - "vw_weekly_comparison calculates this week vs last week metrics"
    - "Both views join dim_exercise for exercise names"
    - "Volume calculated as weight_kg * reps (SQL aggregation, not JavaScript)"
  artifacts:
    - path: "dbt/models/marts/analytics/vw_exercise_progress.sql"
      provides: "Daily progress data for charts"
      contains: "DATE_TRUNC"
    - path: "dbt/models/marts/analytics/vw_weekly_comparison.sql"
      provides: "Week-over-week comparison"
      contains: "LAG"
    - path: "dbt/models/marts/analytics/_analytics__models.yml"
      provides: "dbt documentation for analytics models"
      contains: "vw_exercise_progress"
  key_links:
    - from: "dbt/models/marts/analytics/vw_exercise_progress.sql"
      to: "dbt/models/marts/core/fact_sets.sql"
      via: "ref('fact_sets')"
      pattern: "ref\\('fact_sets'\\)"
    - from: "dbt/models/marts/analytics/vw_weekly_comparison.sql"
      to: "dbt/models/marts/core/fact_sets.sql"
      via: "ref('fact_sets')"
      pattern: "ref\\('fact_sets'\\)"
---

<objective>
Create dbt analytical views for exercise progress and week-over-week comparison.

Purpose: Establishes the data layer for analytics charts - SQL aggregation in DuckDB ensures 10-100x faster performance than JavaScript aggregation. These views power CHART-01 (weight progression), CHART-02 (1RM trend), CHART-03 (volume), and CHART-04 (week comparison).
Output: 2 dbt views + schema documentation ready for React hook consumption.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-analytics-foundation/05-RESEARCH.md

# Existing dbt models to reference
@dbt/models/marts/core/fact_sets.sql
@dbt/models/marts/core/dim_exercise.sql
@dbt/models/marts/analytics/vw_exercise_history.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create vw_exercise_progress view</name>
  <files>
    dbt/models/marts/analytics/vw_exercise_progress.sql
  </files>
  <action>
Create a dbt view that aggregates daily exercise progress for charts:

```sql
-- dbt/models/marts/analytics/vw_exercise_progress.sql
-- Progress data for exercise charts (CHART-01, CHART-02, CHART-03)
{{
    config(
        materialized='view'
    )
}}

WITH daily_aggregates AS (
    SELECT
        original_exercise_id AS exercise_id,
        DATE_TRUNC('day', CAST(logged_at AS TIMESTAMP))::DATE AS date,
        MAX(weight_kg) AS max_weight,
        MAX(estimated_1rm) AS max_1rm,
        SUM(weight_kg * reps) AS total_volume,
        COUNT(*) AS set_count
    FROM {{ ref('fact_sets') }}
    WHERE CAST(logged_at AS TIMESTAMP) >= CURRENT_DATE - INTERVAL '28 days'
    GROUP BY original_exercise_id, DATE_TRUNC('day', CAST(logged_at AS TIMESTAMP))::DATE
)

SELECT
    d.exercise_id,
    d.date,
    d.max_weight,
    d.max_1rm,
    d.total_volume,
    d.set_count,
    e.name AS exercise_name,
    e.muscle_group
FROM daily_aggregates d
INNER JOIN {{ ref('dim_exercise') }} e ON d.exercise_id = e.exercise_id
ORDER BY exercise_id, date
```

Key requirements:
- Use `original_exercise_id` to track across substitutions (matches existing pattern)
- DATE_TRUNC to day for grouping
- 28-day window for 4 weeks of data
- Include max_weight, max_1rm, total_volume, set_count
- Join dim_exercise for exercise_name and muscle_group
  </action>
  <verify>Run `cd dbt && dbt compile --select vw_exercise_progress` - should compile without errors</verify>
  <done>vw_exercise_progress view exists and compiles, providing daily aggregates for charts</done>
</task>

<task type="auto">
  <name>Task 2: Create vw_weekly_comparison view</name>
  <files>
    dbt/models/marts/analytics/vw_weekly_comparison.sql
  </files>
  <action>
Create a dbt view for week-over-week comparison (CHART-04):

```sql
-- dbt/models/marts/analytics/vw_weekly_comparison.sql
-- Week-over-week comparison for exercise performance (CHART-04)
{{
    config(
        materialized='view'
    )
}}

WITH weekly_metrics AS (
    SELECT
        original_exercise_id AS exercise_id,
        DATE_TRUNC('week', CAST(logged_at AS TIMESTAMP))::DATE AS week_start,
        MAX(weight_kg) AS max_weight,
        MAX(estimated_1rm) AS max_1rm,
        SUM(weight_kg * reps) AS total_volume,
        COUNT(*) AS set_count
    FROM {{ ref('fact_sets') }}
    WHERE CAST(logged_at AS TIMESTAMP) >= CURRENT_DATE - INTERVAL '14 days'
    GROUP BY original_exercise_id, DATE_TRUNC('week', CAST(logged_at AS TIMESTAMP))::DATE
),

with_comparison AS (
    SELECT
        exercise_id,
        week_start,
        max_weight,
        max_1rm,
        total_volume,
        set_count,
        LAG(max_weight) OVER (PARTITION BY exercise_id ORDER BY week_start) AS prev_max_weight,
        LAG(total_volume) OVER (PARTITION BY exercise_id ORDER BY week_start) AS prev_volume
    FROM weekly_metrics
)

SELECT
    w.exercise_id,
    w.week_start,
    w.max_weight,
    w.max_1rm,
    w.total_volume,
    w.set_count,
    w.prev_max_weight,
    w.prev_volume,
    e.name AS exercise_name,
    e.muscle_group,
    CASE
        WHEN w.prev_max_weight IS NOT NULL AND w.prev_max_weight > 0 THEN
            ROUND(((w.max_weight - w.prev_max_weight) / w.prev_max_weight) * 100, 1)
        ELSE NULL
    END AS weight_change_pct,
    CASE
        WHEN w.prev_volume IS NOT NULL AND w.prev_volume > 0 THEN
            ROUND(((w.total_volume - w.prev_volume) / w.prev_volume) * 100, 1)
        ELSE NULL
    END AS volume_change_pct
FROM with_comparison w
INNER JOIN {{ ref('dim_exercise') }} e ON w.exercise_id = e.exercise_id
ORDER BY week_start DESC, exercise_name
```

Key requirements:
- Use LAG window function for previous week comparison
- 14-day window to capture current and previous week
- Calculate percentage change for weight and volume
- Handle NULL and zero division cases
  </action>
  <verify>Run `cd dbt && dbt compile --select vw_weekly_comparison` - should compile without errors</verify>
  <done>vw_weekly_comparison view exists and compiles, providing week-over-week metrics</done>
</task>

<task type="auto">
  <name>Task 3: Add schema documentation for analytics models</name>
  <files>
    dbt/models/marts/analytics/_analytics__models.yml
  </files>
  <action>
Create or update the schema file for analytics models:

```yaml
version: 2

models:
  - name: vw_exercise_history
    description: "Recent sets history for last 14 days with workout context"
    columns:
      - name: set_id
        description: "Unique identifier for the set"
      - name: exercise_name
        description: "Name of the exercise"

  - name: vw_exercise_progress
    description: "Daily aggregated progress data for exercise charts (last 28 days)"
    columns:
      - name: exercise_id
        description: "Original exercise ID (stable across substitutions)"
      - name: date
        description: "Date of workout"
      - name: max_weight
        description: "Maximum weight lifted that day (kg)"
      - name: max_1rm
        description: "Maximum estimated 1RM that day (kg)"
      - name: total_volume
        description: "Total volume (sum of weight_kg * reps)"
      - name: set_count
        description: "Number of sets performed"
      - name: exercise_name
        description: "Name of the exercise"
      - name: muscle_group
        description: "Primary muscle group"

  - name: vw_weekly_comparison
    description: "Week-over-week comparison metrics for exercise performance"
    columns:
      - name: exercise_id
        description: "Original exercise ID"
      - name: week_start
        description: "Start of the week"
      - name: max_weight
        description: "Maximum weight lifted that week"
      - name: total_volume
        description: "Total volume for the week"
      - name: weight_change_pct
        description: "Percentage change in max weight from previous week"
      - name: volume_change_pct
        description: "Percentage change in volume from previous week"
```

If _analytics__models.yml exists, merge the new model definitions.
  </action>
  <verify>Run `cd dbt && dbt docs generate` - should complete without errors</verify>
  <done>Schema documentation exists for all analytics views</done>
</task>

</tasks>

<verification>
- [ ] `dbt compile --select vw_exercise_progress` succeeds
- [ ] `dbt compile --select vw_weekly_comparison` succeeds
- [ ] vw_exercise_progress uses DATE_TRUNC('day', ...) for daily grouping
- [ ] vw_weekly_comparison uses LAG for previous week comparison
- [ ] Both views join dim_exercise for exercise names
- [ ] Volume calculated as weight_kg * reps in SQL
- [ ] 28-day window for progress, 14-day window for weekly comparison
</verification>

<success_criteria>
- vw_exercise_progress provides daily max_weight, max_1rm, total_volume per exercise
- vw_weekly_comparison provides this_week vs last_week with percentage changes
- All models compile successfully with dbt
- Schema documentation describes all columns
</success_criteria>

<output>
After completion, create `.planning/phases/05-analytics-foundation/05-01-SUMMARY.md`
</output>
