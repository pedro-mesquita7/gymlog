---
phase: 24-settings-ui-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/stores/useRotationStore.ts
  - src/components/backup/BackupSettings.tsx
  - src/components/settings/ToonExportSection.tsx
autonomous: true

must_haves:
  truths:
    - "Settings top level shows Default Gym inline dropdown, active Rotation inline dropdown, and Export Data button"
    - "Developer Mode toggle is visible at the bottom of settings, off by default"
    - "System Observability, Data Quality, and Demo Data sections are hidden when Developer Mode is off"
    - "System Observability, Data Quality, and Demo Data sections appear when Developer Mode is toggled on"
    - "Developer Mode preference persists across page refreshes"
    - "TOON Export is simplified to a single 'Export Data' button at top level"
  artifacts:
    - path: "src/stores/useRotationStore.ts"
      provides: "developerMode boolean with setter, persisted via Zustand"
      contains: "developerMode"
    - path: "src/components/backup/BackupSettings.tsx"
      provides: "Restructured settings page with developer toggle"
      contains: "developerMode"
    - path: "src/components/settings/ToonExportSection.tsx"
      provides: "Simplified single-button TOON export"
  key_links:
    - from: "src/components/backup/BackupSettings.tsx"
      to: "src/stores/useRotationStore.ts"
      via: "useRotationStore selector for developerMode"
      pattern: "useRotationStore.*developerMode"
---

<objective>
Restructure the settings page for daily mobile use: surface Default Gym, active Rotation selector, and Export Data at top level. Hide debug sections (System Observability, Data Quality, Demo Data) behind a Developer Mode toggle. Simplify TOON export to a single button.

Purpose: Settings should serve daily workout needs, not developer exploration. The most-used controls (gym, rotation, export) should be immediately accessible.
Output: Restructured BackupSettings with developer toggle, simplified ToonExportSection, and persisted developerMode in rotation store.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-settings-ui-polish/24-RESEARCH.md
@src/stores/useRotationStore.ts
@src/components/backup/BackupSettings.tsx
@src/components/settings/ToonExportSection.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add developerMode to rotation store and restructure settings page</name>
  <files>
    src/stores/useRotationStore.ts
    src/components/backup/BackupSettings.tsx
  </files>
  <action>
    **useRotationStore.ts:**
    1. Add `developerMode: boolean` to the `RotationState` interface (default: `false`)
    2. Add `setDeveloperMode: (enabled: boolean) => void` to the interface
    3. Add default value `developerMode: false` in the store implementation
    4. Add setter: `setDeveloperMode: (enabled) => { set({ developerMode: enabled }); }`
    5. Add `developerMode` to the `partialize` function so it persists to localStorage
    6. No migration needed -- the existing `merge` function uses spread which handles missing keys by falling back to `currentState` defaults

    **BackupSettings.tsx - Full settings page restructure:**

    New layout order (replace entire return JSX):

    ```
    1. Default Gym (inline dropdown -- already exists, keep current implementation)
    2. Active Rotation (NEW inline dropdown to switch active rotation)
       - Simple <select> dropdown listing all rotations
       - Selecting a rotation calls setActiveRotation(id)
       - Shows "No rotation" option to deactivate
       - Below dropdown: show current position info (e.g., "Position 2/4 plans")
    3. Export Data (simplified -- just a "Copy Last Workout" button that calls exportLastWorkoutToon)
       - Single button, not the full ToonExportSection component
       - Uses the existing exportLastWorkoutToon function from toon-export service
       - Shows brief copy success feedback
    ---hr---
    4. Workout Preferences (collapsible -- keep existing)
    5. Data Backup (collapsible -- keep existing)
    6. Restore from Backup (collapsible -- keep existing)
    7. Manage Rotations (collapsible -- wraps RotationSection for full CRUD)
    ---hr---
    8. Developer Mode toggle (at bottom)
       - Label: "Developer Mode" on left
       - Toggle switch on right (copy pattern from soundEnabled toggle at line 149-161)
       - Use useRotationStore developerMode / setDeveloperMode
    9. [if developerMode] System Observability (collapsible)
    10. [if developerMode] Data Quality (collapsible)
    11. [if developerMode] Demo Data & Reset (collapsible)
    ```

    For the active rotation inline dropdown (#2):
    - Import `rotations` and `activeRotationId` from useRotationStore (already imported)
    - Create a `<select>` element similar to the Default Gym select
    - Value: `activeRotationId || ''`
    - onChange: `setActiveRotation(e.target.value || null)`
    - Options: "No active rotation" + all rotations by name
    - Show rotation position info below when active

    For the Export Data button (#3):
    - Import `exportLastWorkoutToon` from `../../services/toon-export`
    - Remove the `ToonExportSection` import and component usage
    - Add a simple button with clipboard copy logic:
      - onClick: call exportLastWorkoutToon(), then navigator.clipboard.writeText()
      - Show "Copied!" feedback for 2 seconds (useState + setTimeout pattern)
      - Button text: "Export Last Workout" (default) / "Copied!" (success) / "No data" (empty)

    For the Manage Rotations section (#7):
    - Wrap existing `<RotationSection />` in a `<CollapsibleSection title="Manage Rotations">`
    - This gives full CRUD access but keeps it tucked away

    For Developer Mode toggle (#8):
    - Copy the toggle switch pattern exactly from the soundEnabled toggle (lines 149-161)
    - Wrap in a div with an hr separator above
    - Label text: "Developer Mode"

    For conditional debug sections (#9-11):
    - Wrap the existing three CollapsibleSection blocks in `{developerMode && (<>...</>)}`
    - Keep existing structure intact (CollapsibleSection with child components)

    Preserve all existing data-testid attributes. The ToonExportSection component file itself is NOT deleted -- just no longer imported in BackupSettings.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify no TypeScript errors.
    Run `npx vitest run` to verify existing tests still pass.
    Verify developerMode defaults to false: `grep "developerMode: false" src/stores/useRotationStore.ts`
    Verify developerMode is persisted: `grep "developerMode" src/stores/useRotationStore.ts` shows it in partialize.
    Verify conditional rendering: `grep "developerMode" src/components/backup/BackupSettings.tsx` shows conditional block.
  </verify>
  <done>
    Settings page shows Default Gym, Active Rotation dropdown, and Export Data button at top level. Developer Mode toggle at bottom controls visibility of System Observability, Data Quality, and Demo Data sections. developerMode persists across refreshes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Simplify ToonExportSection for potential standalone use</name>
  <files>
    src/components/settings/ToonExportSection.tsx
  </files>
  <action>
    While BackupSettings no longer imports ToonExportSection, keep the file functional but add an optional `compact` prop for potential reuse:

    Actually, since BackupSettings.tsx now uses inline export logic and no longer imports ToonExportSection, this component becomes unused. Rather than modifying it, verify it compiles but don't change it -- it may be useful later for a "full export" mode if Developer Mode users want more export options.

    Instead, verify that the inline export implementation in BackupSettings.tsx (from Task 1) works correctly:
    - The `exportLastWorkoutToon` import resolves
    - The clipboard copy pattern handles errors gracefully
    - The "No data" case is handled when no workouts exist

    If ToonExportSection is truly orphaned (not imported anywhere), add a brief comment at the top: `// NOTE: Full TOON export UI -- currently unused, replaced by inline export in BackupSettings`
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify no TypeScript errors.
    Grep for ToonExportSection imports: `grep -r "ToonExportSection" src/` should only show the file itself (not imported elsewhere).
  </verify>
  <done>
    ToonExportSection.tsx compiles cleanly. BackupSettings no longer imports it. Inline export in BackupSettings works with Last Workout export + clipboard copy.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npx vitest run` passes all existing tests
3. Settings page top level: Default Gym dropdown, Active Rotation dropdown, Export Data button
4. Developer Mode toggle at bottom, off by default
5. Debug sections hidden when Developer Mode is off
6. Debug sections visible when Developer Mode is on
7. developerMode persists in localStorage after page refresh
8. All data-testid attributes preserved for E2E compatibility
</verification>

<success_criteria>
- Default Gym, Active Rotation selector, and Export Data button are immediately visible in settings
- Developer Mode toggle hides/shows System Observability, Data Quality, Demo Data
- developerMode persists across page refresh
- ToonExportSection is no longer imported in BackupSettings
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/24-settings-ui-polish/24-02-SUMMARY.md`
</output>
