---
phase: 16-demo-data-toon-export
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/toon-export.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "TOON service can export last workout as TOON-formatted string"
    - "TOON service can export rotation cycle data as TOON-formatted string"
    - "TOON service can export time-range-scoped data as TOON-formatted string"
    - "TOON output includes context headers (exercise definitions, date range, gym names)"
  artifacts:
    - path: "src/services/toon-export.ts"
      provides: "TOON export service with three scope functions"
      exports: ["exportLastWorkoutToon", "exportRotationCycleToon", "exportTimeRangeToon"]
  key_links:
    - from: "src/services/toon-export.ts"
      to: "@duckdb/duckdb-wasm"
      via: "getDuckDB query execution"
      pattern: "getDuckDB|conn\\.query"
    - from: "src/services/toon-export.ts"
      to: "@toon-format/toon"
      via: "encode() call"
      pattern: "encode\\("
---

<objective>
Install the TOON SDK and create a service module that queries DuckDB for workout data across three scopes (last workout, rotation cycle, time range) and encodes the results as TOON-formatted strings with rich context headers.

Purpose: The TOON format is optimized for LLM consumption -- users can copy their workout data and paste it into ChatGPT/Claude for analysis. The service layer keeps all SQL and encoding logic out of React components.
Output: `src/services/toon-export.ts` with three async export functions, and `@toon-format/toon` added to dependencies.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-demo-data-toon-export/16-CONTEXT.md
@.planning/phases/16-demo-data-toon-export/16-RESEARCH.md
@src/db/duckdb-init.ts
@src/db/compiled-queries.ts
@src/stores/useRotationStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @toon-format/toon and create TOON export service</name>
  <files>
    package.json
    src/services/toon-export.ts
  </files>
  <action>
**Step 1: Install dependency**
```bash
npm install @toon-format/toon
```

**Step 2: Create src/services/toon-export.ts**

This is a pure service module -- no React, no hooks. All functions are async, take minimal params, query DuckDB directly, and return TOON strings.

Import `encode` from `@toon-format/toon` and `getDuckDB` from `../db/duckdb-init`.

**Data structure for TOON encoding:**

The TOON `encode()` function takes a JavaScript object and returns a token-efficient string. Structure the workout data as:

```typescript
interface ToonExportData {
  metadata: {
    app: string;         // "GymLog"
    exported_at: string; // ISO timestamp
    scope: string;       // "last_workout" | "rotation_cycle" | "time_range"
    date_range: { from: string; to: string };
  };
  exercises: Array<{
    name: string;
    muscle_group: string;
    equipment: string;
  }>;
  workouts: Array<{
    date: string;
    gym: string;
    template: string;
    sets: Array<{
      exercise: string;
      weight: number;
      reps: number;
      set_number: number;
      pr_type: string | null;  // "weight" | "reps" | "volume" | null
    }>;
  }>;
}
```

**Three export functions:**

1. `exportLastWorkoutToon(): Promise<string>`
   - Query: Find the most recent `workout_started` event, get its workout_id. Then query all `set_logged` events for that workout_id. Join with exercise definitions to get names/muscle_groups. Get gym name from the workout's gym_id.
   - SQL approach: Use a CTE to find latest workout_started, then join sets. Use the existing pattern from `compiled-queries.ts` for exercise dimension lookups.
   - Return empty string if no workouts found.

2. `exportRotationCycleToon(rotationCount: number, rotationTemplateIds: string[], currentPosition: number): Promise<string>`
   - Takes rotation params from the caller (the UI will read from useRotationStore).
   - Calculate which workouts belong to the requested rotation cycles by finding the last N complete passes through the template list.
   - Query workout_started events matching those template IDs, ordered by date, limited to `rotationCount * templateIds.length` most recent workouts.
   - For each workout, get its sets with exercise details.
   - Return empty string if no rotation data.

3. `exportTimeRangeToon(days: number | null): Promise<string>`
   - `days` param: 30, 90, 180, 365, or null (all time). Same pattern as analytics hooks.
   - Query all workout_started events within the date range. For each, get sets + exercise details.
   - Group by workout date.
   - Return empty string if no data in range.

**Shared helper within the module:**

Create a private `queryWorkoutData(whereClause: string): Promise<ToonExportData>` that:
1. Opens a DuckDB connection
2. Queries exercise definitions (exercise_created/updated/deleted, pick latest)
3. Queries workouts matching the where clause
4. Queries sets for those workouts
5. Queries gym names
6. Assembles the ToonExportData object
7. Closes connection in finally block
8. Calls `encode(data)` and returns the string

**SQL patterns to follow:**
- Use the event sourcing pattern from compiled-queries.ts: ROW_NUMBER() OVER (PARTITION BY entity_id ORDER BY _created_at DESC) for latest state
- Filter deleted exercises/gyms (event_type != 'exercise_deleted')
- For PR detection in sets: check if payload contains pr_type field (the set_logged payload includes PR info when applicable)
- Use `json_extract_string(payload, '$.field')` for payload field access (existing DuckDB pattern in this codebase)

**Error handling:** Wrap all DB operations in try/finally, always close connection. If getDuckDB() returns null, return empty string. Log errors to console.warn.

**Important:** Do NOT use `any` types. Define proper interfaces for query results. Use `as unknown as Type` pattern if DuckDB result typing is needed (existing codebase pattern).
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles. Run `npm run build` to confirm no build errors. Verify `@toon-format/toon` appears in package.json dependencies. Read the created file to confirm all three export functions exist and use proper DuckDB query patterns.
  </verify>
  <done>
- `@toon-format/toon` installed in package.json
- `src/services/toon-export.ts` exports `exportLastWorkoutToon`, `exportRotationCycleToon`, `exportTimeRangeToon`
- Each function queries DuckDB and returns a TOON-encoded string
- Context headers include exercise definitions, date range, gym names
- Set data includes weight, reps, set_number, and pr_type
- TypeScript compiles and build succeeds
  </done>
</task>

</tasks>

<verification>
1. `npm ls @toon-format/toon` shows installed package
2. `npx tsc --noEmit` passes
3. `npm run build` succeeds
4. src/services/toon-export.ts exports all three functions
5. No `any` types in the service module
6. All DuckDB connections use try/finally pattern
</verification>

<success_criteria>
- Three TOON export functions available for the UI to call
- Each returns a TOON-encoded string with metadata, exercise definitions, and workout/set data
- Empty string returned gracefully when no data exists for scope
- No React dependencies in the service module (pure async functions)
</success_criteria>

<output>
After completion, create `.planning/phases/16-demo-data-toon-export/16-02-SUMMARY.md`
</output>
