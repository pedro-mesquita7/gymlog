---
phase: 16-demo-data-toon-export
plan: 03
type: execute
wave: 2
depends_on: ["16-02"]
files_modified:
  - src/components/settings/ToonExportSection.tsx
  - src/components/backup/BackupSettings.tsx
autonomous: true

must_haves:
  truths:
    - "User can copy last workout as TOON text to clipboard"
    - "User can download last workout as .toon file"
    - "User can select rotation cycle scope and export as TOON"
    - "User can select time range scope and export as TOON"
    - "Export buttons are disabled when no data exists for selected scope"
  artifacts:
    - path: "src/components/settings/ToonExportSection.tsx"
      provides: "TOON export UI with scope picker, copy, and download"
      contains: "ToonExportSection"
    - path: "src/components/backup/BackupSettings.tsx"
      provides: "Settings page integrating ToonExportSection"
      contains: "ToonExportSection"
  key_links:
    - from: "src/components/settings/ToonExportSection.tsx"
      to: "src/services/toon-export.ts"
      via: "import and call export functions"
      pattern: "exportLastWorkoutToon|exportRotationCycleToon|exportTimeRangeToon"
    - from: "src/components/settings/ToonExportSection.tsx"
      to: "navigator.clipboard"
      via: "clipboard API for copy"
      pattern: "navigator\\.clipboard\\.writeText"
    - from: "src/components/backup/BackupSettings.tsx"
      to: "src/components/settings/ToonExportSection.tsx"
      via: "component import and render"
      pattern: "<ToonExportSection"
---

<objective>
Create the TOON Export UI section for the Settings page with scope picker (last workout, rotation cycle, time range), copy-to-clipboard and download actions, and integrate it into BackupSettings.

Purpose: Users need a simple interface to export their workout data in TOON format for LLM analysis. The UI provides scope selection and dual output (clipboard + file download).
Output: `ToonExportSection.tsx` component wired to toon-export service, integrated into Settings page.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-demo-data-toon-export/16-CONTEXT.md
@.planning/phases/16-demo-data-toon-export/16-RESEARCH.md
@.planning/phases/16-demo-data-toon-export/16-02-SUMMARY.md
@src/components/backup/BackupSettings.tsx
@src/services/toon-export.ts
@src/stores/useRotationStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ToonExportSection component</name>
  <files>src/components/settings/ToonExportSection.tsx</files>
  <action>
Create `src/components/settings/ToonExportSection.tsx` with the following structure:

**State:**
- `scope`: `'last_workout' | 'rotation_cycle' | 'time_range'` (default: `'last_workout'`)
- `rotationCount`: number (1, 2, or 3) for rotation cycle scope
- `timeRangeDays`: `30 | 90 | 180 | 365 | null` for time range scope (default: 90)
- `isExporting`: boolean
- `copySuccess`: boolean (briefly true after clipboard copy, auto-resets after 2s)
- `error`: string | null

**Read rotation state** from `useRotationStore`: get `rotations`, `activeRotationId`. Derive the active rotation's `template_ids` and `current_position`. If no active rotation, disable the rotation_cycle scope option. Capture rotation data at render time and pass to exportRotationCycleToon (don't re-read from store during async export operation).

**Scope picker:** Use a segmented control (3 buttons in a row, similar to the kg/lbs toggle in BackupSettings). Options: "Last Workout", "Rotation", "Time Range". Use `bg-accent text-black` for active, `bg-bg-tertiary text-text-secondary` for inactive. The "Rotation" option should show `opacity-50 cursor-not-allowed` if no active rotation exists.

**Scope-specific options** (shown conditionally below the scope picker):
- Rotation cycle: Small segmented control for count: "1x", "2x", "3x"
- Time range: Segmented control matching analytics: "1M", "3M", "6M", "1Y", "All"

**Action buttons:** Two buttons side by side in a flex row:
1. "Copy to Clipboard" (primary, `bg-accent`): Calls the appropriate export function based on scope, then `navigator.clipboard.writeText(result)`. On success, set `copySuccess = true` and setTimeout to reset after 2000ms. On clipboard error, fall back to showing a toast-like error message.
2. "Download .toon" (secondary, `bg-bg-tertiary`): Calls same export function, then creates a Blob with `text/plain` type, creates object URL, triggers download via hidden anchor element (same pattern as useBackupExport). Filename: `gymlog-{scope}-{date}.toon`.

**Export function dispatch:**
```typescript
async function handleExport(): Promise<string> {
  switch (scope) {
    case 'last_workout':
      return exportLastWorkoutToon();
    case 'rotation_cycle':
      return exportRotationCycleToon(rotationCount, activeRotation.template_ids, activeRotation.current_position);
    case 'time_range':
      return exportTimeRangeToon(timeRangeDays);
  }
}
```

**Empty state handling:** After calling the export function, if result is empty string, set error to "No data available for this scope" and return early (don't try to copy/download empty string).

**Disable both action buttons** when `isExporting` is true.

**Copy success feedback:** When `copySuccess` is true, change the "Copy to Clipboard" button text to "Copied!" with a checkmark icon (use Unicode checkmark, no icon library needed).

**Styling:** Match existing Settings sections -- `bg-bg-secondary rounded-lg p-4` container, `text-lg font-semibold mb-4 text-text-primary` for section heading. Section heading: "Export TOON". Add a brief description: `text-sm text-text-secondary mb-3` -- "Export workout data in LLM-optimized format for AI analysis".

**Error display:** If error is set, show below buttons in `text-sm text-error mt-2`.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles. Read the created file to confirm scope picker, both action buttons, and all three export scope handlers exist.
  </verify>
  <done>
ToonExportSection component renders with scope picker (3 options), scope-specific sub-options, copy + download buttons, empty state handling, and clipboard success feedback.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate ToonExportSection into Settings page</name>
  <files>src/components/backup/BackupSettings.tsx</files>
  <action>
In `src/components/backup/BackupSettings.tsx`:

1. Add import: `import { ToonExportSection } from '../settings/ToonExportSection';`

2. Add the ToonExportSection between the existing "Restore from Backup" section and the "Demo & Data Management" section (before the `<hr>` that precedes DemoDataSection). Add an `<hr className="border-border-primary" />` before ToonExportSection.

The insertion point is after the import result feedback `</section>` (around line 191) and before the existing `<hr>` + `<DemoDataSection>` block.

Result order on Settings page:
1. Rotation Section
2. Workout Preferences
3. Data Backup (export)
4. Restore from Backup (import)
5. **Export TOON** (new)
6. Demo & Data Management
7. System Observability
8. Data Quality
  </action>
  <verify>
Run `npm run build` to confirm build succeeds. Read BackupSettings.tsx to verify ToonExportSection is imported and rendered in the correct position.
  </verify>
  <done>
ToonExportSection appears on Settings page between backup restore and demo data sections. Full build passes.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. ToonExportSection.tsx exists with scope picker, copy, and download buttons
4. BackupSettings.tsx renders ToonExportSection
5. Rotation scope is disabled when no active rotation
6. Copy button shows "Copied!" feedback after successful clipboard write
7. Download creates .toon file with correct filename pattern
</verification>

<success_criteria>
- User can select export scope (last workout, rotation cycle, time range)
- User can copy TOON text to clipboard
- User can download .toon file
- Empty data shows "No data available" message instead of empty file
- Rotation scope disabled when no active rotation
- All TypeScript types correct, build passes
</success_criteria>

<output>
After completion, create `.planning/phases/16-demo-data-toon-export/16-03-SUMMARY.md`
</output>
