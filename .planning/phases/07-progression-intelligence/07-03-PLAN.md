---
phase: 07-progression-intelligence
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/stores/useProgressionAlertStore.ts
  - src/components/workout/ProgressionAlert.tsx
  - src/components/workout/SetLogger.tsx
autonomous: true

must_haves:
  truths:
    - "User sees contextual alert during workout logging when current exercise is in plateau/regression/progressing"
    - "Plateau alert shows encouraging message with actionable suggestion"
    - "Regression alert shows weight/volume drop percentage with recovery advice"
    - "Progressing alert shows positive reinforcement (green, recent PR)"
    - "User can dismiss plateau/regression alerts per session"
    - "Dismissed alerts return in next session (2+ hour gap) if condition persists"
  artifacts:
    - path: "src/stores/useProgressionAlertStore.ts"
      provides: "Zustand store for session-dismissible alert state"
      exports: ["useProgressionAlertStore"]
      min_lines: 30
    - path: "src/components/workout/ProgressionAlert.tsx"
      provides: "Contextual progression alert component"
      exports: ["ProgressionAlert"]
      min_lines: 40
    - path: "src/components/workout/SetLogger.tsx"
      provides: "Updated SetLogger with ProgressionAlert injection"
      contains: "ProgressionAlert"
  key_links:
    - from: "src/components/workout/ProgressionAlert.tsx"
      to: "src/hooks/useExerciseProgression.ts"
      via: "imports useExerciseProgression hook for single exercise status"
      pattern: "useExerciseProgression"
    - from: "src/components/workout/ProgressionAlert.tsx"
      to: "src/stores/useProgressionAlertStore.ts"
      via: "imports store for dismissal state"
      pattern: "useProgressionAlertStore"
    - from: "src/components/workout/SetLogger.tsx"
      to: "src/components/workout/ProgressionAlert.tsx"
      via: "renders ProgressionAlert above PR indicator"
      pattern: "ProgressionAlert"
---

<objective>
Create session-dismissible progression alerts that appear during active workout logging. Each exercise shows its status (progressing/plateau/regressing) with actionable suggestions and dismissible UI.

Purpose: PROG-01 (plateau alert), PROG-02 (regression alert), and the contextual workout alert requirement from CONTEXT.md. Users see relevant progression info exactly when they need it -- while logging sets.
Output: Zustand alert store, ProgressionAlert component, updated SetLogger.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-progression-intelligence/07-CONTEXT.md
@.planning/phases/07-progression-intelligence/07-RESEARCH.md
@.planning/phases/07-progression-intelligence/07-01-SUMMARY.md
@src/components/workout/SetLogger.tsx
@src/stores/useBackupStore.ts
@src/components/history/PRIndicator.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useProgressionAlertStore with session-dismissible state</name>
  <files>
    src/stores/useProgressionAlertStore.ts
  </files>
  <action>
Create `src/stores/useProgressionAlertStore.ts` following the useBackupStore.ts pattern with Zustand persist middleware:

1. Interface DismissedAlert: { exerciseId: string, status: 'plateau' | 'regressing', dismissedAt: string (ISO timestamp) }

2. Interface ProgressionAlertState:
   - dismissedAlerts: DismissedAlert[]
   - sessionStartTime: string | null
   - dismissAlert(exerciseId, status): adds to dismissedAlerts with current timestamp
   - isAlertDismissed(exerciseId, status): returns true if alert was dismissed in current session (dismissedAt >= sessionStartTime)
   - initSession(): checks if 2+ hours since last sessionStartTime; if so, clears dismissedAlerts and sets new sessionStartTime. If no sessionStartTime, just set it.

3. Create store with Zustand persist:
   - Storage key: 'gymlog-progression-alerts'
   - Use createJSONStorage(() => localStorage)
   - Import from 'zustand' and 'zustand/middleware'

4. Session logic: "new session" = 2+ hours since last sessionStartTime. This means:
   - First visit: set sessionStartTime, no dismissals
   - Within 2 hours: keep existing dismissals (same workout session)
   - After 2+ hours: clear all dismissals, reset sessionStartTime (new workout session)

IMPORTANT: Follow useBackupStore.ts import and structure patterns exactly. Use `create<State>()(persist(...))` syntax.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Store exports useProgressionAlertStore
    - Uses Zustand persist with localStorage
  </verify>
  <done>
    Session-dismissible alert store persists across page refreshes but clears dismissals when 2+ hours have passed, treating that as a new workout session.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ProgressionAlert component and inject into SetLogger</name>
  <files>
    src/components/workout/ProgressionAlert.tsx
    src/components/workout/SetLogger.tsx
  </files>
  <action>
1. Create `src/components/workout/ProgressionAlert.tsx`:

Props: exerciseId (string), originalExerciseId (string), currentGymId (string)

Implementation:
- Call useExerciseProgression({ exerciseId: originalExerciseId, gymId: currentGymId })
- Call useProgressionAlertStore for isAlertDismissed and dismissAlert
- Call initSession() on mount (useEffect with empty deps) to handle session boundary detection
- If isLoading or no data, return null
- If status is 'unknown', return null
- If status is 'plateau' or 'regressing' and isAlertDismissed returns true, return null

Status config object (RESEARCH.md Pattern 4):
- progressing: icon='↗', green colors (bg-green-900/30 border-green-700/50 text-green-200), title='Progressing', message='Keep up the great work! You hit a PR recently.'
- plateau: icon='→', yellow colors (bg-yellow-900/30 border-yellow-700/50 text-yellow-200), title='Plateau Detected', message='No PR in 4+ weeks. Try varying rep ranges or increasing weight by 2.5kg.'
- regressing: icon='↘', red colors (bg-red-900/30 border-red-700/50 text-red-200), title='Regression Alert', message dynamically includes weight_drop_pct or volume_drop_pct: 'Weight or volume down X% from recent average. Check recovery and nutrition.'

UI structure:
- Outer div with border rounded-lg p-3 mb-4 and status-specific color classes
- Flex row: icon + text content on left, dismiss X button on right (only for plateau/regressing)
- Text content: h3 font-semibold text-sm for title, p text-xs mt-1 opacity-90 for message
- Dismiss button: SVG X icon (24x24 viewBox, M6 18L18 6M6 6l12 12 path), text-current opacity-60 hover:opacity-100

2. Modify `src/components/workout/SetLogger.tsx`:

Add imports:
- Import ProgressionAlert from './ProgressionAlert'
- Import useWorkoutStore from '../../stores/useWorkoutStore' (to get currentGymId)

Read SetLogger's existing props -- it already has exerciseId and originalExerciseId. It needs currentGymId.

Determine how to get gym_id: Check if SetLogger's parent passes gym context. Look at useWorkoutStore for the current workout's gym_id. The simplest approach: import useWorkoutStore and get the active workout's gym_id from state.

Add ProgressionAlert as the FIRST child in the space-y-6 div, BEFORE the PRIndicator:
```jsx
<ProgressionAlert
  exerciseId={exerciseId}
  originalExerciseId={originalExerciseId}
  currentGymId={currentGymId}
/>
```

Where currentGymId comes from `useWorkoutStore(state => state.activeWorkout?.gym_id || '')` or similar -- check the store's shape.

IMPORTANT: Do NOT change any existing SetLogger functionality. Only add the ProgressionAlert above existing content.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds
    - ProgressionAlert component exports correctly
    - SetLogger renders ProgressionAlert before PRIndicator
    - ProgressionAlert uses useExerciseProgression and useProgressionAlertStore
  </verify>
  <done>
    During active workout logging, each exercise shows contextual progression alert with status-specific styling, actionable message, and dismiss button. Dismissed alerts persist within session but return in next session if condition persists.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- all TypeScript compiles
2. `npm run build` -- Vite build succeeds
3. SetLogger renders ProgressionAlert for each exercise during workout
4. Alert shows correct status with icon, color, message
5. Dismiss button hides alert for current session
6. Store persists dismissals in localStorage under 'gymlog-progression-alerts'
</verification>

<success_criteria>
- PROG-01 satisfied: User sees plateau alert with actionable suggestion during workout
- PROG-02 satisfied: User sees regression alert with drop percentages during workout
- CONTEXT.md: All three statuses shown (including green "progressing" for positive reinforcement)
- CONTEXT.md: Alerts are session-dismissible (return next session if condition persists)
- CONTEXT.md: Encouraging/actionable tone in all messages
</success_criteria>

<output>
After completion, create `.planning/phases/07-progression-intelligence/07-03-SUMMARY.md`
</output>
