# Plan 08-05: Unit Tests for Critical Hooks

**Requirements:** TEST-02
**Depends on:** 08-01 (testing infrastructure must exist)

## Goal

Write unit tests for the three critical hooks: `useHistory`, `useWorkoutStore`, and `useExerciseProgress` (replacing useExerciseProgress for the originally named useExerciseProgress — the analytics equivalent). All tests mock DuckDB-WASM and test user-observable behavior, not implementation details.

## Tasks

1. **Create test fixtures** at `src/tests/__fixtures__/test-data.ts`
   - Factory functions for creating test data: `makeSetHistory()`, `makePRRecord()`, `makeProgressPoint()`
   - Realistic default values with optional overrides
   - These fixtures are reused across all test files

2. **Test `useWorkoutStore`** at `src/stores/useWorkoutStore.test.ts`
   - This is a Zustand store so test it directly (no rendering needed):
     - `startWorkout()` creates session with correct shape (workout_id, template_id, gym_id, started_at, empty sets)
     - `logSet()` adds set with correct fields (set_id, exercise_id, weight_kg, reps, rir, logged_at)
     - `removeSet()` removes correct set by ID
     - `completeWorkout()` returns session and clears state to null
     - `cancelWorkout()` clears session to null
     - `substituteExercise()` maps original to replacement
     - `revertSubstitution()` removes mapping
     - `selectSetsForExercise` selector filters correctly by original_exercise_id
   - Mock `uuidv7` to return predictable IDs
   - Mock `Date` for deterministic timestamps

3. **Test `useHistory`** at `src/hooks/useHistory.test.ts`
   - Use `renderHook` from `@testing-library/react`
   - Mock `getDuckDB` using the DuckDB mock from 08-01
   - Test cases:
     - Returns loading=true initially, then loading=false with data
     - Returns empty history when no exerciseId provided
     - Returns error when DB not initialized (getDuckDB returns null)
     - Correctly groups history by date in historyByDate
     - `refresh()` re-fetches data
     - Filters by gym context (matches_gym_context)
   - Configure mock to return test fixture data

4. **Test `useExerciseProgress`** at `src/hooks/useAnalytics.test.ts`
   - Use `renderHook` from `@testing-library/react`
   - Mock `getDuckDB` same as above
   - Test cases:
     - Returns loading=true then data on success
     - Returns empty array when no exerciseId
     - Returns error state when DB query fails
     - Correctly maps row data to ProgressPoint type
     - `refresh()` re-fetches

## Verification
- [ ] `npm test` passes all tests
- [ ] Tests cover: useWorkoutStore (8+ test cases), useHistory (6+ test cases), useExerciseProgress (5+ test cases)
- [ ] No tests depend on real DuckDB — all use mocks
- [ ] `npm run test:coverage` shows coverage for tested hooks

## Files
- `src/tests/__fixtures__/test-data.ts` (create)
- `src/stores/useWorkoutStore.test.ts` (create)
- `src/hooks/useHistory.test.ts` (create)
- `src/hooks/useAnalytics.test.ts` (create)
