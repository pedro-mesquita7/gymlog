# Plan 08-01: Testing Infrastructure Setup

**Requirements:** TEST-01
**Depends on:** None

## Goal

Install and configure Vitest, React Testing Library, happy-dom, and Playwright. Create config files, test setup, DuckDB mock, and npm scripts so that `npm test` and `npx playwright test` both run (even with zero real tests).

## Tasks

1. **Install test dependencies**
   - `npm install -D vitest @vitest/ui @vitest/coverage-v8 @testing-library/react @testing-library/jest-dom @testing-library/user-event happy-dom playwright @playwright/test`
   - Run `npx playwright install chromium` (only Chromium needed for OPFS/SharedArrayBuffer)

2. **Create Vitest config**
   - Add `vitest.config.ts` at project root (separate from vite.config.ts for clarity):
     ```ts
     import { defineConfig } from 'vitest/config';
     import react from '@vitejs/plugin-react';
     export default defineConfig({
       plugins: [react()],
       test: {
         environment: 'happy-dom',
         globals: true,
         setupFiles: ['./src/tests/setup.ts'],
         include: ['src/**/*.test.{ts,tsx}'],
         coverage: {
           provider: 'v8',
           reporter: ['text', 'html'],
           include: ['src/**/*.{ts,tsx}'],
           exclude: ['src/tests/**', 'src/**/*.test.*', 'src/vite-env.d.ts'],
         },
       },
     });
     ```

3. **Create test setup file** at `src/tests/setup.ts`
   - Import `@testing-library/jest-dom/vitest` for matcher extensions
   - Add any global cleanup (afterEach RTL cleanup is automatic in recent versions)

4. **Create DuckDB mock** at `src/tests/mocks/duckdb.ts`
   - Export a mock factory that replaces `getDuckDB()` with a fake that returns mock query results
   - Mock `connect()` returning a connection with `query()` and `close()` methods
   - Query returns `{ toArray: () => [] }` by default, configurable per test
   - This is the critical piece: all hooks depend on DuckDB, so mocking it correctly unblocks all unit tests

5. **Create Playwright config** at `playwright.config.ts`
   - Chromium only (SharedArrayBuffer requires secure context)
   - Base URL: `http://localhost:5173`
   - Web server: `npm run dev` with COOP/COEP headers (already in vite.config.ts)
   - Test directory: `src/e2e/`
   - Set `launchOptions.args: ['--enable-features=SharedArrayBuffer']` if needed

6. **Add npm scripts** to package.json:
   - `"test"`: `"vitest run"`
   - `"test:watch"`: `"vitest"`
   - `"test:ui"`: `"vitest --ui"`
   - `"test:coverage"`: `"vitest run --coverage"`
   - `"test:e2e"`: `"playwright test"`

7. **Create a smoke test** at `src/tests/smoke.test.ts`
   - Simple test: `test('vitest runs', () => expect(true).toBe(true))`
   - Confirms the entire pipeline works

8. **Update tsconfig.app.json**
   - Add `"types": ["vite/client", "vitest/globals"]` so globals like `describe`, `test`, `expect` are typed

## Verification
- [ ] `npm test` runs and passes (smoke test)
- [ ] `npm run test:coverage` produces coverage report
- [ ] `npx playwright test --list` shows test discovery works (0 tests found is fine)
- [ ] TypeScript compiles without errors: `npx tsc --noEmit`

## Files
- `vitest.config.ts` (create)
- `playwright.config.ts` (create)
- `src/tests/setup.ts` (create)
- `src/tests/mocks/duckdb.ts` (create)
- `src/tests/smoke.test.ts` (create)
- `package.json` (modify - add devDependencies + scripts)
- `tsconfig.app.json` (modify - add vitest/globals types)
