---
phase: 12-bug-fix-security
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - index.html
  - package-lock.json
autonomous: true

must_haves:
  truths:
    - "npm audit reports zero high/critical vulnerabilities"
    - "App loads and functions correctly with CSP headers enabled"
    - "DuckDB-WASM initializes successfully with CSP meta tag present"
  artifacts:
    - path: "index.html"
      provides: "CSP meta tag with DuckDB-WASM accommodations"
      contains: "Content-Security-Policy"
    - path: "package-lock.json"
      provides: "Updated dependencies with audit fixes"
  key_links:
    - from: "index.html"
      to: "DuckDB-WASM worker"
      via: "CSP worker-src blob: directive"
      pattern: "worker-src.*blob:"
    - from: "index.html"
      to: "WASM compilation"
      via: "CSP script-src wasm-unsafe-eval directive"
      pattern: "wasm-unsafe-eval"
---

<objective>
Complete SEC-02 and SEC-03: Fix npm audit vulnerabilities and add CSP meta tag to index.html with DuckDB-WASM compatibility (worker-src blob:, wasm-unsafe-eval).

Purpose: App is hardened against dependency vulnerabilities and content injection attacks while maintaining full DuckDB-WASM functionality.
Output: Zero high/critical npm vulnerabilities, CSP-protected index.html.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-bug-fix-security/12-RESEARCH.md

@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run npm audit fix and verify build</name>
  <files>package-lock.json</files>
  <action>
  1. Run `npm audit` to capture current state (expect 2 moderate: esbuild/vite dev-only)
  2. Run `npm audit fix` (NOT `--force`) to fix available vulnerabilities
  3. Run `npm audit` again to verify results
  4. Run `npm run build` to verify the fix did not break anything
  5. Run `npm test` to verify tests still pass

  If `npm audit fix` changes vite to a version with breaking changes:
  - Check the vite changelog for breaking changes
  - If build/tests break, revert with `git checkout package-lock.json package.json` and document as accepted risk
  - Per policy: only fix high/critical. Moderate are acceptable if fix causes breakage.

  Document the final audit state (expected: 0 high/critical, 0-2 moderate dev-only).
  </action>
  <verify>
  - `npm audit` shows zero high/critical vulnerabilities
  - `npm run build` succeeds
  - `npm test` passes
  </verify>
  <done>npm audit reports zero high/critical vulnerabilities. Build and tests pass. Any remaining moderate vulnerabilities are dev-only and documented as accepted risk.</done>
</task>

<task type="auto">
  <name>Task 2: Add CSP meta tag to index.html</name>
  <files>index.html</files>
  <action>
  Add the following CSP meta tag to `index.html` inside `<head>`, BEFORE the `<script src="coi-serviceworker.js">` tag (CSP should be declared before any scripts execute):

  ```html
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'wasm-unsafe-eval'; worker-src 'self' blob:; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; connect-src 'self'; font-src 'self';">
  ```

  Key directives and WHY:
  - `script-src 'wasm-unsafe-eval'` -- allows DuckDB-WASM compilation without enabling JS eval (safer than `unsafe-eval`)
  - `worker-src blob:` -- DuckDB-WASM creates Web Workers from blob URLs
  - `style-src 'unsafe-inline'` -- Tailwind CSS injects inline styles at runtime
  - `img-src data: blob:` -- allows data URLs and blob URLs for images
  - `connect-src 'self'` -- restricts fetch/XHR to same origin

  After adding, verify by:
  1. Running `npm run dev` and opening the app in browser
  2. Check browser console for CSP violation errors
  3. Verify DuckDB-WASM initializes (app loads data)
  4. If CSP violations occur for DuckDB-WASM, adjust directives accordingly

  Add an HTML comment documenting the HTTP header equivalent for future VPS migration:
  ```html
  <!-- CSP HTTP header equivalent for nginx/Caddy VPS deployment:
       add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'wasm-unsafe-eval'; worker-src 'self' blob:; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; connect-src 'self'; font-src 'self';";
  -->
  ```
  </action>
  <verify>
  - `index.html` contains `Content-Security-Policy` meta tag
  - `npm run build` succeeds
  - CSP meta tag includes `wasm-unsafe-eval` and `worker-src 'self' blob:`
  - HTML comment documents HTTP header equivalent for VPS
  </verify>
  <done>CSP meta tag added to index.html with DuckDB-WASM compatibility. HTTP header equivalent documented for future VPS migration. Build succeeds.</done>
</task>

</tasks>

<verification>
- npm audit shows zero high/critical vulnerabilities
- index.html has CSP meta tag with correct directives
- Build succeeds
- Tests pass
- CSP does not block DuckDB-WASM initialization
</verification>

<success_criteria>
Zero high/critical npm vulnerabilities. CSP headers protect against content injection while DuckDB-WASM functions normally. VPS migration path documented.
</success_criteria>

<output>
After completion, create `.planning/phases/12-bug-fix-security/12-04-SUMMARY.md`
</output>
