---
phase: 12-bug-fix-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/compiled-queries.ts
autonomous: true

must_haves:
  truths:
    - "Exercise history remains visible after an exercise is deleted and recreated"
    - "Active exercise list still excludes deleted exercises"
    - "All 5 analytics queries return data for exercises that were historically logged then deleted"
  artifacts:
    - path: "src/db/compiled-queries.ts"
      provides: "DIM_EXERCISE_ALL_SQL dimension and updated history/analytics queries"
      contains: "DIM_EXERCISE_ALL_SQL"
  key_links:
    - from: "EXERCISE_HISTORY_SQL"
      to: "exercise_dim_all"
      via: "JOIN on exercise_id"
      pattern: "exercise_dim_all"
    - from: "EXERCISE_PROGRESS_SQL"
      to: "exercise_dim_all"
      via: "JOIN on exercise_id"
      pattern: "exercise_dim_all"
    - from: "VOLUME_BY_MUSCLE_GROUP_SQL"
      to: "exercise_dim_all"
      via: "JOIN on original_exercise_id"
      pattern: "exercise_dim_all"
---

<objective>
Fix BUG-01: Exercise history disappears when exercises are deleted/recreated. Create a new DIM_EXERCISE_ALL_SQL dimension that includes deleted exercises for history JOINs, and update all 5 affected analytics queries to use it.

Purpose: Users trust the app with their data -- exercise history survives plan changes and exercise lifecycle events.
Output: Updated compiled-queries.ts with DIM_EXERCISE_ALL_SQL and 5 fixed queries.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-bug-fix-security/12-RESEARCH.md

@src/db/compiled-queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DIM_EXERCISE_ALL_SQL and update history/analytics queries</name>
  <files>src/db/compiled-queries.ts</files>
  <action>
  1. Add a new exported constant `DIM_EXERCISE_ALL_SQL` immediately after the existing `DIM_EXERCISE_SQL`. This new dimension should be identical to `DIM_EXERCISE_SQL` but WITHOUT the `event_type != 'exercise_deleted'` filter. It should:
     - Use the same CTE structure (all_exercise_events, deduplicated)
     - In the final SELECT, include ALL exercises where _rn = 1 (most recent event, whether created, updated, or deleted)
     - Include the `event_type` column in the output so consumers can identify deleted exercises if needed
     - Keep the same columns: exercise_id, name, muscle_group, is_global, plus event_type and last_updated_at

  2. Update ALL 5 affected queries to use `exercise_dim_all` (from DIM_EXERCISE_ALL_SQL) instead of `exercise_dim` (from DIM_EXERCISE_SQL):
     - `EXERCISE_HISTORY_SQL` (~line 230): Change `JOIN exercise_dim e` to `JOIN exercise_dim_all e`
     - `EXERCISE_PROGRESS_SQL` (~line 299): Change `INNER JOIN exercise_dim e` to `INNER JOIN exercise_dim_all e`
     - `WEEKLY_COMPARISON_SQL` (~line 358): Change `INNER JOIN exercise_dim e` to `INNER JOIN exercise_dim_all e`
     - `VOLUME_BY_MUSCLE_GROUP_SQL` (~line 378): Change `INNER JOIN exercise_dim e` to `INNER JOIN exercise_dim_all e`
     - `MUSCLE_HEAT_MAP_SQL` (~line 409): Change `INNER JOIN exercise_dim e` to `INNER JOIN exercise_dim_all e`

  3. For each of the 5 queries, also update the WITH clause CTE reference. These queries define `exercise_dim AS (...)` as a CTE using `DIM_EXERCISE_SQL`. Add a new CTE `exercise_dim_all AS (${DIM_EXERCISE_ALL_SQL})` and reference that in the JOINs. Search the file for how `exercise_dim` is used as a CTE to understand the exact pattern.

  4. DO NOT modify `DIM_EXERCISE_SQL` itself -- it must continue to filter out deleted exercises for the active exercise list UI.

  5. Verify that `useHistory.ts` gym-context filtering (line ~63: `rows.filter(row => row.matches_gym_context)`) is not affected by this change. The gym filter is applied at the JS layer after the query, so it should still work correctly.
  </action>
  <verify>
  - `npx tsc --noEmit` passes (no TypeScript errors)
  - `npm run build` succeeds
  - `npm test` passes (existing tests still green)
  - Grep the file to confirm: DIM_EXERCISE_SQL still has `event_type != 'exercise_deleted'` filter
  - Grep the file to confirm: DIM_EXERCISE_ALL_SQL does NOT have `event_type != 'exercise_deleted'` filter
  - Grep the file to confirm: All 5 history/analytics queries reference `exercise_dim_all` (not `exercise_dim`)
  </verify>
  <done>
  - DIM_EXERCISE_ALL_SQL exported and includes deleted exercises
  - DIM_EXERCISE_SQL unchanged (still filters deleted)
  - All 5 analytics queries (EXERCISE_HISTORY_SQL, EXERCISE_PROGRESS_SQL, WEEKLY_COMPARISON_SQL, VOLUME_BY_MUSCLE_GROUP_SQL, MUSCLE_HEAT_MAP_SQL) use exercise_dim_all for JOINs
  - Build passes, tests pass
  </done>
</task>

</tasks>

<verification>
- TypeScript compilation succeeds
- Build succeeds with no errors
- All existing tests pass
- DIM_EXERCISE_SQL unchanged for active exercise list
- DIM_EXERCISE_ALL_SQL includes deleted exercises
- 5 analytics queries use exercise_dim_all
</verification>

<success_criteria>
Exercise history queries will now return data for exercises regardless of their deletion status. Active exercise list continues to show only non-deleted exercises.
</success_criteria>

<output>
After completion, create `.planning/phases/12-bug-fix-security/12-01-SUMMARY.md`
</output>
