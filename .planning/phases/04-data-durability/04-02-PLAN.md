---
phase: 04-data-durability
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useBackupImport.ts
autonomous: true

must_haves:
  truths:
    - "User can select a Parquet file for import"
    - "Import validates file is a Parquet file"
    - "Import validates schema matches events table"
    - "Duplicate events are skipped (by _event_id)"
    - "Successful import shows count of imported events"
  artifacts:
    - path: "src/hooks/useBackupImport.ts"
      provides: "Import functionality with validation"
      exports: ["useBackupImport"]
  key_links:
    - from: "src/hooks/useBackupImport.ts"
      to: "getDuckDB"
      via: "DuckDB registerFileHandle for file access"
      pattern: "registerFileHandle"
---

<objective>
Create import functionality for restoring data from Parquet backup files.

Purpose: Enable users to import previously exported backup files to restore or merge data.
Output: Working import hook that validates and imports Parquet files into the events table.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-data-durability/04-RESEARCH.md
@src/db/duckdb-init.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useBackupImport hook with validation</name>
  <files>src/hooks/useBackupImport.ts</files>
  <action>
Create hook that imports events from a user-selected Parquet file.

Interface:
```typescript
interface ImportResult {
  success: boolean;
  eventsImported: number;
  eventsSkipped: number;  // duplicates
  error?: string;
}

interface UseBackupImport {
  importBackup: (file: File) => Promise<ImportResult>;
  isImporting: boolean;
  lastResult: ImportResult | null;
}
```

Implementation:

1. **Pre-validation** (before DuckDB):
   - Check file extension is `.parquet` (case-insensitive)
   - If not, return error: "Please select a Parquet backup file (.parquet)"

2. **Register file with DuckDB**:
   ```typescript
   import { DuckDBDataProtocol } from '@duckdb/duckdb-wasm';

   await db.registerFileHandle(
     'import.parquet',
     file,
     DuckDBDataProtocol.BROWSER_FILEREADER,
     true  // directIO
   );
   ```

3. **Schema validation**:
   - Query: `SELECT column_name FROM (DESCRIBE SELECT * FROM 'import.parquet')`
   - Required columns: `_event_id`, `_created_at`, `event_type`, `payload`
   - If missing columns, return error: "Invalid backup file: missing required columns ({list})"
   - Don't require `year`/`month` columns (they are virtual/computed)

4. **Count existing events for skip calculation**:
   ```sql
   SELECT COUNT(*) as total FROM 'import.parquet'
   ```

5. **Import with duplicate skip**:
   ```sql
   INSERT INTO events (_event_id, _created_at, event_type, payload)
   SELECT _event_id, _created_at, event_type, payload
   FROM 'import.parquet'
   WHERE _event_id NOT IN (SELECT _event_id FROM events)
   ```

6. **Get import count**:
   - After INSERT, count how many were added by comparing before/after event counts
   - Or use DuckDB's row count from INSERT result if available

7. **Cleanup**:
   - `await db.dropFile('import.parquet')` in finally block

8. **Return result**:
   ```typescript
   return {
     success: true,
     eventsImported: insertedCount,
     eventsSkipped: totalInFile - insertedCount,
   };
   ```

Error handling:
- Wrap in try/catch
- DuckDB errors for invalid Parquet: "not a valid Parquet file"
- Set isImporting state during operation
- Store lastResult for UI display
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Hook exports useBackupImport with importBackup function that validates and imports Parquet files</done>
</task>

<task type="auto">
  <name>Task 2: Add DuckDBDataProtocol import to types</name>
  <files>src/hooks/useBackupImport.ts</files>
  <action>
Ensure DuckDBDataProtocol is properly imported from @duckdb/duckdb-wasm.

The import should be:
```typescript
import { DuckDBDataProtocol } from '@duckdb/duckdb-wasm';
```

This enum provides BROWSER_FILEREADER protocol for registerFileHandle.

If the import doesn't work directly, check how duckdb-init.ts imports and follow the same pattern:
```typescript
import * as duckdb from '@duckdb/duckdb-wasm';
// Then use: duckdb.DuckDBDataProtocol.BROWSER_FILEREADER
```

Note: This task is combined with Task 1 - just ensure the import is correct in the hook file.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>DuckDBDataProtocol properly imported and used in registerFileHandle call</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Import hook compiles with DuckDBDataProtocol import
3. Schema validation logic correctly checks for required columns
</verification>

<success_criteria>
- Import hook created with file validation
- Schema validation checks for required columns
- Duplicate events skipped via _event_id check
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-data-durability/04-02-SUMMARY.md`
</output>
